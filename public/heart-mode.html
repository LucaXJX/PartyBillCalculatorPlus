<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/img/icon32x32.png" sizes="16x16" />
    <title>å¿ƒå‹•æ¨¡å¼ - PBCèšè³¬é€š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <!-- å¼•å…¥èªè­‰å’Œçµ„ä»¶ç®¡ç† -->
    <script src="/js/auth.js" type="module"></script>
    <script src="/js/components.js"></script>
    <script src="/js/page-setup.js" type="module"></script>
    <style>
      /* æ»‘å¡å‹•ç•« */
      .card-container {
        position: relative;
        width: 100%;
        max-width: 400px;
        height: 600px;
        margin: 0 auto;
        perspective: 1000px;
      }

      .restaurant-card {
        position: absolute;
        width: 100%;
        height: 100%;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease, opacity 0.3s ease;
        cursor: grab;
        user-select: none;
        overflow: hidden;
      }

      .restaurant-card:active {
        cursor: grabbing;
      }

      .restaurant-card.swiping-left {
        transform: rotate(-15deg) translateX(-100px);
        opacity: 0.5;
      }

      .restaurant-card.swiping-right {
        transform: rotate(15deg) translateX(100px);
        opacity: 0.5;
      }

      .restaurant-card.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .restaurant-image {
        width: 100%;
        height: 400px;
        object-fit: cover;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 48px;
      }

      .restaurant-info {
        padding: 20px;
        height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .action-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 30px;
      }

      .action-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .action-btn:hover {
        transform: scale(1.1);
      }

      .btn-dislike {
        background: #ef4444;
        color: white;
      }

      .btn-like {
        background: #10b981;
        color: white;
      }

      .btn-super-like {
        background: #3b82f6;
        color: white;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
      }

      .empty-state i {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .rating-stars {
        color: #fbbf24;
      }

      .price-range {
        color: #059669;
        font-weight: 600;
      }

      .cuisine-badge {
        display: inline-block;
        background: #e0e7ff;
        color: #4f46e5;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
      }

      .loading-spinner {
        border: 4px solid #f3f4f6;
        border-top: 4px solid #4f46e5;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Header å°‡ç”± JavaScript å‹•æ…‹æ’å…¥ -->

    <!-- ä¸»å…§å®¹å€ -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pt-24">
      <!-- ç¯©é¸æŒ‰éˆ• -->
      <div class="mb-4 flex justify-end">
        <button
          id="filterBtn"
          class="px-4 py-2 bg-white text-gray-600 hover:text-primary hover:bg-gray-50 rounded-lg shadow transition flex items-center gap-2"
        >
          <i class="fas fa-filter"></i> ç¯©é¸
        </button>
      </div>
      <!-- ç¯©é¸é¢æ¿ï¼ˆå¯é¸ï¼‰ -->
      <div id="filterPanel" class="hidden mb-6 bg-white p-4 rounded-lg shadow">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              èœç³»é¡å‹
            </label>
            <select
              id="cuisineFilter"
              class="w-full border border-gray-300 rounded-lg px-3 py-2"
            >
              <option value="">å…¨éƒ¨</option>
              <option value="ä¸­é¤">ä¸­é¤</option>
              <option value="æ—¥æ–™">æ—¥æ–™</option>
              <option value="éŸ“å¼">éŸ“å¼</option>
              <option value="æ³°å¼">æ³°å¼</option>
              <option value="ç¾©å¼">ç¾©å¼</option>
              <option value="æ³•å¼">æ³•å¼</option>
              <option value="ç¾å¼">ç¾å¼</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              æœ€å°è©•åˆ†
            </label>
            <select
              id="ratingFilter"
              class="w-full border border-gray-300 rounded-lg px-3 py-2"
            >
              <option value="">å…¨éƒ¨</option>
              <option value="4.5">4.5+</option>
              <option value="4.0">4.0+</option>
              <option value="3.5">3.5+</option>
              <option value="3.0">3.0+</option>
            </select>
          </div>
          <div class="flex items-end">
            <button
              id="applyFilter"
              class="w-full bg-primary text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"
            >
              æ‡‰ç”¨ç¯©é¸
            </button>
          </div>
        </div>
      </div>

      <!-- æ»‘å¡å€åŸŸ -->
      <div class="card-container" id="cardContainer">
        <!-- é¤å»³å¡ç‰‡å°‡å‹•æ…‹æ’å…¥é€™è£¡ -->
        <div id="emptyState" class="empty-state hidden">
          <i class="fas fa-utensils"></i>
          <h3 class="text-xl font-semibold mb-2">æ²’æœ‰æ›´å¤šé¤å»³äº†</h3>
          <p class="text-gray-500">
            æ‚¨å·²ç¶“çœ‹å®Œäº†æ‰€æœ‰ç¬¦åˆæ¢ä»¶çš„é¤å»³ï¼Œè«‹èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–ç¨å¾Œå†è©¦ã€‚
          </p>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰éˆ• -->
      <div class="action-buttons" id="actionButtons">
        <button
          class="action-btn btn-dislike"
          id="dislikeBtn"
          title="ä¸æ„Ÿèˆˆè¶£"
        >
          <i class="fas fa-times"></i>
        </button>
        <button
          class="action-btn btn-super-like"
          id="superLikeBtn"
          title="æ”¶è—"
        >
          <i class="fas fa-star"></i>
        </button>
        <button class="action-btn btn-like" id="likeBtn" title="å–œæ­¡">
          <i class="fas fa-heart"></i>
        </button>
      </div>

      <!-- çµ±è¨ˆä¿¡æ¯ -->
      <div class="mt-8 text-center text-gray-500 text-sm">
        <span id="statsText">å·²ç€è¦½: 0 | å–œæ­¡: 0 | æ”¶è—: 0</span>
      </div>
    </main>

    <!-- Google Maps JavaScript API (å¯é¸ï¼Œå¦‚æœæ²’æœ‰ API Key å°‡ä½¿ç”¨ Haversine å…¬å¼) -->
    <script>
      // å¾ç’°å¢ƒè®Šæ•¸æˆ–é…ç½®ä¸­ç²å– Google Maps API Keyï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
      const GOOGLE_MAPS_API_KEY = window.GOOGLE_MAPS_API_KEY || null;
      
      // å¦‚æœæœ‰ API Keyï¼ŒåŠ è¼‰ Google Maps API
      if (GOOGLE_MAPS_API_KEY) {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places`;
        script.async = true;
        script.defer = true;
        script.onload = () => {
          googleMapsLoaded = true;
          console.log("âœ… Google Maps API å·²åŠ è¼‰");
        };
        script.onerror = () => {
          console.warn("âš ï¸ Google Maps API åŠ è¼‰å¤±æ•—ï¼Œå°‡ä½¿ç”¨ Haversine å…¬å¼");
        };
        document.head.appendChild(script);
      } else {
        console.log("â„¹ï¸ æœªé…ç½® Google Maps API Keyï¼Œå°‡ä½¿ç”¨ Haversine å…¬å¼è¨ˆç®—è·é›¢");
      }
    </script>
    <script>
      // å…¨å±€è®Šé‡
      let currentRestaurant = null;
      let restaurantQueue = [];
      let stats = {
        viewed: 0,
        liked: 0,
        favorited: 0,
      };
      let userLocation = null; // { latitude, longitude, address }
      let googleMapsLoaded = false;

      // æª¢æŸ¥ Google Maps API æ˜¯å¦åŠ è¼‰
      if (typeof google !== 'undefined' && google.maps) {
        googleMapsLoaded = true;
      } else {
        // å¦‚æœæ²’æœ‰ API keyï¼Œä½¿ç”¨å‚™é¸æ–¹æ¡ˆï¼ˆHaversine å…¬å¼ï¼‰
        console.warn("Google Maps API æœªåŠ è¼‰ï¼Œå°‡ä½¿ç”¨ Haversine å…¬å¼è¨ˆç®—è·é›¢");
      }

      // èªè­‰
      const sessionId =
        localStorage.getItem("sessionId") ||
        document.cookie
          .split("; ")
          .find((row) => row.startsWith("sessionId="))
          ?.split("=")[1];

      if (!sessionId) {
        window.location.href = "/login-page.html";
      }

      const API_BASE = "/api";
      const headers = {
        "Content-Type": "application/json",
        Authorization: `Bearer ${sessionId}`,
      };

      // ç²å–ç”¨æˆ¶ä½ç½®
      async function getUserLocation() {
        return new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error("ç€è¦½å™¨ä¸æ”¯æŒåœ°ç†ä½ç½®"));
            return;
          }

          // è¨­ç½®è¶…æ™‚è¨ˆæ™‚å™¨
          const timeoutId = setTimeout(() => {
            reject(new Error("ç²å–ä½ç½®è¶…æ™‚ï¼Œå°‡ä½¿ç”¨å‚™é¸è·é›¢è¨ˆç®—"));
          }, 15000); // 15 ç§’è¶…æ™‚

          navigator.geolocation.getCurrentPosition(
            async (position) => {
              clearTimeout(timeoutId);
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              
              // å˜—è©¦ç²å–åœ°å€ï¼ˆä½¿ç”¨ Google Geocoding APIï¼‰
              let address = null;
              if (googleMapsLoaded && google.maps.geocoder) {
                try {
                  const geocoder = new google.maps.Geocoder();
                  const latlng = { lat, lng };
                  const result = await new Promise((resolve, reject) => {
                    geocoder.geocode({ location: latlng }, (results, status) => {
                      if (status === 'OK' && results[0]) {
                        resolve(results[0].formatted_address);
                      } else {
                        resolve(null);
                      }
                    });
                  });
                  address = result;
                } catch (e) {
                  console.warn("ç²å–åœ°å€å¤±æ•—:", e);
                }
              }

              userLocation = {
                latitude: lat,
                longitude: lng,
                address: address || `${lat}, ${lng}`,
              };
              resolve(userLocation);
            },
            (error) => {
              clearTimeout(timeoutId);
              // æ ¹æ“šéŒ¯èª¤é¡å‹æä¾›æ›´å‹å¥½çš„éŒ¯èª¤ä¿¡æ¯
              let errorMessage = "ç„¡æ³•ç²å–ä½ç½®";
              switch (error.code) {
                case error.PERMISSION_DENIED:
                  errorMessage = "ä½ç½®æ¬Šé™è¢«æ‹’çµ•ï¼Œå°‡ä½¿ç”¨å‚™é¸è·é›¢è¨ˆç®—";
                  break;
                case error.POSITION_UNAVAILABLE:
                  errorMessage = "ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œå°‡ä½¿ç”¨å‚™é¸è·é›¢è¨ˆç®—";
                  break;
                case error.TIMEOUT:
                  errorMessage = "ç²å–ä½ç½®è¶…æ™‚ï¼Œå°‡ä½¿ç”¨å‚™é¸è·é›¢è¨ˆç®—";
                  break;
                default:
                  errorMessage = "ç„¡æ³•ç²å–ä½ç½®ï¼Œå°‡ä½¿ç”¨å‚™é¸è·é›¢è¨ˆç®—";
                  break;
              }
              reject(new Error(errorMessage));
            },
            {
              enableHighAccuracy: false, // æ”¹ç‚º false ä»¥åŠ å¿«ç²å–é€Ÿåº¦
              timeout: 15000, // 15 ç§’è¶…æ™‚
              maximumAge: 300000, // å…è¨±ä½¿ç”¨ 5 åˆ†é˜å…§çš„ç·©å­˜ä½ç½®
            }
          );
        });
      }

      // ä½¿ç”¨ Google Maps Distance Matrix API è¨ˆç®—è·é›¢
      async function calculateDistanceWithGoogle(origin, destination) {
        if (!googleMapsLoaded || !google.maps) {
          // å‚™é¸æ–¹æ¡ˆï¼šä½¿ç”¨ Haversine å…¬å¼
          return calculateDistanceHaversine(
            origin.latitude,
            origin.longitude,
            destination.latitude,
            destination.longitude
          );
        }

        return new Promise((resolve, reject) => {
          const service = new google.maps.DistanceMatrixService();
          const origins = [{ lat: origin.latitude, lng: origin.longitude }];
          const destinations = [{ lat: destination.latitude, lng: destination.longitude }];

          service.getDistanceMatrix(
            {
              origins: origins,
              destinations: destinations,
              travelMode: google.maps.TravelMode.DRIVING,
              unitSystem: google.maps.UnitSystem.METRIC,
            },
            (response, status) => {
              if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
                const element = response.rows[0].elements[0];
                const distance = element.distance.value / 1000; // è½‰æ›ç‚ºå…¬é‡Œ
                const duration = element.duration.text;
                resolve({
                  distance: distance,
                  distanceText: element.distance.text,
                  duration: duration,
                });
              } else {
                // å¦‚æœ Google API å¤±æ•—ï¼Œä½¿ç”¨ Haversine å…¬å¼
                console.warn("Google Distance Matrix API å¤±æ•—ï¼Œä½¿ç”¨ Haversine å…¬å¼");
                const distance = calculateDistanceHaversine(
                  origin.latitude,
                  origin.longitude,
                  destination.latitude,
                  destination.longitude
                );
                resolve({
                  distance: distance,
                  distanceText: `${distance.toFixed(1)} å…¬é‡Œ`,
                  duration: null,
                });
              }
            }
          );
        });
      }

      // Haversine å…¬å¼è¨ˆç®—è·é›¢ï¼ˆå‚™é¸æ–¹æ¡ˆï¼‰
      function calculateDistanceHaversine(lat1, lon1, lat2, lon2) {
        const R = 6371; // åœ°çƒåŠå¾‘ï¼ˆå…¬é‡Œï¼‰
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(lat1 * Math.PI / 180) *
            Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // ç²å–ä¸‹ä¸€å€‹é¤å»³
      async function getNextRestaurant() {
        try {
          const cuisineType = document.getElementById("cuisineFilter")?.value;
          const minRating = document.getElementById("ratingFilter")?.value;

          const params = new URLSearchParams();
          if (cuisineType) params.append("cuisine_type", cuisineType);
          if (minRating) params.append("min_rating", minRating);

          const url = `${API_BASE}/restaurants/next${params.toString() ? '?' + params.toString() : ''}`;
          console.log("ğŸ” è«‹æ±‚é¤å»³:", url);

          const response = await fetch(url, { 
            method: 'GET',
            headers: {
              ...headers,
              'Accept': 'application/json',
            },
            credentials: 'include' // ç¢ºä¿ç™¼é€ cookies
          });

          console.log("ğŸ“¥ API éŸ¿æ‡‰ç‹€æ…‹:", response.status, response.statusText);

          if (response.status === 401) {
            // æœªæˆæ¬Šï¼Œè·³è½‰åˆ°ç™»éŒ„é 
            console.warn("âš ï¸ æœªæˆæ¬Šï¼Œè·³è½‰åˆ°ç™»éŒ„é ");
            window.location.href = "/login-page.html";
            return null;
          }

          if (response.status === 404) {
            // 404 éŒ¯èª¤ï¼Œå¯èƒ½æ˜¯è·¯ç”±å•é¡Œæˆ–æœå‹™å™¨æœªå•Ÿå‹•
            console.error("âŒ API ç«¯é»ä¸å­˜åœ¨ (404)");
            const errorText = await response.text().catch(() => '');
            console.error("éŸ¿æ‡‰å…§å®¹:", errorText);
            throw new Error("API ç«¯é»ä¸å­˜åœ¨ï¼Œè«‹ç¢ºèªæœå‹™å™¨å·²å•Ÿå‹•ä¸¦åŒ…å«é¤å»³è·¯ç”±");
          }

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error("âŒ API éŒ¯èª¤:", errorData);
            throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          console.log("âœ… ç²å–é¤å»³æˆåŠŸ:", data);
          
          // #region agent log
          if (data.restaurant) {
            fetch('http://127.0.0.1:7242/ingest/e0e62e5f-dac0-4669-80e3-631a3943d7a2',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'heart-mode.html:541',message:'API response received - H8',data:{id:data.restaurant.id,name:data.restaurant.name,rating:data.restaurant.rating,llmRating:data.restaurant.llm_rating,llmRatingConfidence:data.restaurant.llm_rating_confidence,hasRating:data.restaurant.rating!=null,hasLlmRating:data.restaurant.llm_rating!=null},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H8'})}).catch(()=>{});
          }
          // #endregion
          
          if (!data.restaurant) {
            console.log("â„¹ï¸ æ²’æœ‰æ›´å¤šé¤å»³äº†");
            return null;
          }
          
          return data.restaurant;
        } catch (error) {
          console.error("âŒ ç²å–é¤å»³å¤±æ•—:", error);
          showToast(error.message || "ç²å–é¤å»³å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
          return null;
        }
      }

      // é¡¯ç¤ºé¤å»³å¡ç‰‡ï¼ˆå¸¶è·é›¢è¨ˆç®—ï¼‰
      async function displayRestaurant(restaurant) {
        if (!restaurant) {
          document.getElementById("emptyState").classList.remove("hidden");
          document.getElementById("actionButtons").style.display = "none";
          return;
        }

        currentRestaurant = restaurant;
        const container = document.getElementById("cardContainer");
        const emptyState = document.getElementById("emptyState");
        emptyState.classList.add("hidden");

        // è¨ˆç®—è·é›¢ï¼ˆå¦‚æœç”¨æˆ¶ä½ç½®å’Œé¤å»³ä½ç½®éƒ½å­˜åœ¨ï¼‰
        let distanceInfo = null;
        if (userLocation && restaurant.latitude && restaurant.longitude) {
          try {
            const distanceResult = await calculateDistanceWithGoogle(
              userLocation,
              {
                latitude: restaurant.latitude,
                longitude: restaurant.longitude,
              }
            );
            distanceInfo = distanceResult;
            // å°‡è·é›¢ä¿¡æ¯æ·»åŠ åˆ°é¤å»³å°è±¡ä¸­ï¼ˆè‡¨æ™‚æ•¸æ“šï¼Œä¸å­˜å„²ï¼‰
            restaurant.distance = distanceResult.distance;
            restaurant.distanceText = distanceResult.distanceText;
            restaurant.duration = distanceResult.duration;
          } catch (error) {
            console.warn("è¨ˆç®—è·é›¢å¤±æ•—:", error);
          }
        }

        // å‰µå»ºå¡ç‰‡
        const card = document.createElement("div");
        card.className = "restaurant-card";
        card.dataset.restaurantId = restaurant.id;

        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/e0e62e5f-dac0-4669-80e3-631a3943d7a2',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'heart-mode.html:597',message:'Before rendering rating stars - H6,H7',data:{id:restaurant.id,name:restaurant.name,rating:restaurant.rating,ratingType:typeof restaurant.rating,isNull:restaurant.rating===null,isUndefined:restaurant.rating===undefined,isFalsy:!restaurant.rating},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H6,H7'})}).catch(()=>{});
        // #endregion
        
        // è©•åˆ†æ˜Ÿæ˜Ÿ
        // å„ªå…ˆä½¿ç”¨ LLM è©•åˆ†ï¼ˆå¦‚æœç½®ä¿¡åº¦ > 0.5ï¼‰ï¼Œå¦å‰‡ä½¿ç”¨åŸå§‹è©•åˆ†
        let ratingValue = null;
        let ratingSource = "none";
        
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/e0e62e5f-dac0-4669-80e3-631a3943d7a2',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'heart-mode.html:605',message:'Rating evaluation - H8',data:{id:restaurant.id,name:restaurant.name,rating:restaurant.rating,llmRating:restaurant.llm_rating,llmRatingConfidence:restaurant.llm_rating_confidence,hasRating:restaurant.rating!=null,hasLlmRating:restaurant.llm_rating!=null,llmConfidenceValid:restaurant.llm_rating_confidence!=null&&restaurant.llm_rating_confidence>0.5},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H8'})}).catch(()=>{});
        // #endregion
        
        if (restaurant.llm_rating != null && restaurant.llm_rating_confidence != null && restaurant.llm_rating_confidence > 0.5) {
          // ä½¿ç”¨ LLM è©•åˆ†
          ratingValue = restaurant.llm_rating;
          ratingSource = "llm";
        } else if (restaurant.rating != null && restaurant.rating > 0) {
          // ä½¿ç”¨åŸå§‹è©•åˆ†
          ratingValue = restaurant.rating;
          ratingSource = "original";
        }
        
        const ratingStars = ratingValue != null && ratingValue > 0
          ? `<span class="text-yellow-500">${"â˜…".repeat(Math.floor(ratingValue))}${"â˜†".repeat(5 - Math.floor(ratingValue))}</span>`
          : '<span class="text-gray-400">æš«ç„¡è©•åˆ†</span>';
        
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/e0e62e5f-dac0-4669-80e3-631a3943d7a2',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'heart-mode.html:620',message:'After rating evaluation - H8',data:{id:restaurant.id,name:restaurant.name,ratingValue,ratingSource,hasRating:ratingValue!=null,ratingStarsLength:ratingStars.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H8'})}).catch(()=>{});
        // #endregion
        
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/e0e62e5f-dac0-4669-80e3-631a3943d7a2',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'heart-mode.html:605',message:'After processing rating stars - H6,H7',data:{id:restaurant.id,name:restaurant.name,originalRating:restaurant.rating,ratingValue,hasRating:ratingValue!=null,ratingStarsLength:ratingStars.length,ratingStarsPreview:ratingStars.substring(0,50)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'H6,H7'})}).catch(()=>{});
        // #endregion

        // åƒ¹æ ¼ç¯„åœé¡¯ç¤º
        const priceDisplay = restaurant.price_range
          ? restaurant.price_range
          : "åƒ¹æ ¼æœªçŸ¥";

        // æ¨™ç±¤
        const tagsHtml =
          restaurant.tags && restaurant.tags.length > 0
            ? restaurant.tags
                .slice(0, 3)
                .map(
                  (tag) =>
                    `<span class="cuisine-badge">${tag}</span>`
                )
                .join(" ")
            : "";

        // è·é›¢é¡¯ç¤º
        const distanceHtml = distanceInfo
          ? `<div class="flex items-center justify-between text-sm mt-1">
              <span class="text-blue-600">
                <i class="fas fa-route"></i> ${distanceInfo.distanceText}
                ${distanceInfo.duration ? ` (${distanceInfo.duration})` : ""}
              </span>
            </div>`
          : "";

        card.innerHTML = `
          <div class="restaurant-image">
            ${
              restaurant.image_url
                ? `<img src="${restaurant.image_url}" alt="${restaurant.name}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas fa-utensils\\'></i>';" />`
                : `<i class="fas fa-utensils"></i>`
            }
          </div>
          <div class="restaurant-info">
            <div>
              <h2 class="text-2xl font-bold mb-2">${restaurant.name}</h2>
              ${
                restaurant.name_en
                  ? `<p class="text-gray-500 text-sm mb-2">${restaurant.name_en}</p>`
                  : ""
              }
              ${
                restaurant.cuisine_type
                  ? `<span class="cuisine-badge">${restaurant.cuisine_type}</span>`
                  : ""
              }
              ${
                restaurant.description
                  ? `<p class="text-gray-600 text-sm mt-2 line-clamp-2">${restaurant.description}</p>`
                  : ""
              }
            </div>
            <div class="mt-4 space-y-2">
              <div class="flex items-center justify-between text-sm">
                <span class="rating-stars">${ratingStars}</span>
                ${ratingValue != null && ratingValue > 0 ? `<span class="text-gray-500">${ratingValue.toFixed(1)}</span>` : ''}
              </div>
              <div class="flex items-center justify-between text-sm">
                <span class="price-range">${priceDisplay}</span>
                ${
                  restaurant.review_count
                    ? `<span class="text-gray-500">${restaurant.review_count} è©•è«–</span>`
                    : ""
                }
              </div>
              ${distanceHtml}
              ${
                restaurant.address
                  ? `<p class="text-gray-500 text-xs"><i class="fas fa-map-marker-alt"></i> ${restaurant.address}</p>`
                  : ""
              }
              ${tagsHtml ? `<div class="mt-2">${tagsHtml}</div>` : ""}
            </div>
          </div>
        `;

        // æ¸…é™¤èˆŠå¡ç‰‡
        const oldCards = container.querySelectorAll(".restaurant-card");
        oldCards.forEach((card) => card.remove());

        // æ·»åŠ æ–°å¡ç‰‡
        container.appendChild(card);

        // æ·»åŠ æ»‘å‹•äº‹ä»¶
        setupSwipeEvents(card);
        
        // é¡¯ç¤ºæ“ä½œæŒ‰éˆ•
        document.getElementById("actionButtons").style.display = "flex";
      }

      // è¨­ç½®æ»‘å‹•äº‹ä»¶
      function setupSwipeEvents(card) {
        let startX = 0;
        let startY = 0;
        let currentX = 0;
        let currentY = 0;
        let isDragging = false;

        card.addEventListener("mousedown", (e) => {
          isDragging = true;
          startX = e.clientX;
          startY = e.clientY;
        });

        card.addEventListener("touchstart", (e) => {
          isDragging = true;
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
        });

        const handleMove = (clientX, clientY) => {
          if (!isDragging) return;

          currentX = clientX - startX;
          currentY = clientY - startY;

          const rotation = currentX * 0.1;
          card.style.transform = `translateX(${currentX}px) translateY(${currentY}px) rotate(${rotation}deg)`;

          if (currentX < -50) {
            card.classList.add("swiping-left");
            card.classList.remove("swiping-right");
          } else if (currentX > 50) {
            card.classList.add("swiping-right");
            card.classList.remove("swiping-left");
          } else {
            card.classList.remove("swiping-left", "swiping-right");
          }
        };

        const handleEnd = () => {
          if (!isDragging) return;
          isDragging = false;

          const threshold = 100; // æ»‘å‹•é–¾å€¼
          
          if (currentX < -threshold) {
            // å·¦æ»‘ - ä¸æ„Ÿèˆˆè¶£
            card.style.transition = "transform 0.3s ease, opacity 0.3s ease";
            card.style.transform = `translateX(-1000px) rotate(-30deg)`;
            card.style.opacity = "0";
            setTimeout(() => {
              handleDislike();
            }, 300);
          } else if (currentX > threshold) {
            // å³æ»‘ - å–œæ­¡
            card.style.transition = "transform 0.3s ease, opacity 0.3s ease";
            card.style.transform = `translateX(1000px) rotate(30deg)`;
            card.style.opacity = "0";
            setTimeout(() => {
              handleLike();
            }, 300);
          } else {
            // å›å½ˆ
            card.style.transition = "transform 0.3s ease";
            card.style.transform = "";
            card.classList.remove("swiping-left", "swiping-right");
            setTimeout(() => {
              card.style.transition = "";
            }, 300);
          }

          currentX = 0;
          currentY = 0;
        };

        document.addEventListener("mousemove", (e) => {
          if (isDragging) handleMove(e.clientX, e.clientY);
        });

        document.addEventListener("mouseup", handleEnd);

        document.addEventListener("touchmove", (e) => {
          if (isDragging) {
            e.preventDefault();
            handleMove(e.touches[0].clientX, e.touches[0].clientY);
          }
        });

        document.addEventListener("touchend", handleEnd);
      }

      // è™•ç†å–œæ­¡
      async function handleLike() {
        if (!currentRestaurant) return;

        try {
          const response = await fetch(`${API_BASE}/restaurants/feedback`, {
            method: "POST",
            headers,
            credentials: 'include',
            body: JSON.stringify({
              restaurant_id: currentRestaurant.id,
              preference: "like",
            }),
          });

          if (response.status === 401) {
            window.location.href = "/login-page.html";
            return;
          }

          if (response.ok) {
            const data = await response.json();
            stats.liked++;
            stats.viewed++;
            updateStats();
            showToast("å·²æ·»åŠ åˆ°å–œæ­¡åˆ—è¡¨", "success");
            removeCard();
            loadNextRestaurant();
          } else {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || "è¨˜éŒ„å¤±æ•—");
          }
        } catch (error) {
          console.error("è¨˜éŒ„å–œæ­¡å¤±æ•—:", error);
          showToast(error.message || "æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
        }
      }

      // è™•ç†ä¸æ„Ÿèˆˆè¶£
      async function handleDislike() {
        if (!currentRestaurant) return;

        try {
          const response = await fetch(`${API_BASE}/restaurants/feedback`, {
            method: "POST",
            headers,
            credentials: 'include',
            body: JSON.stringify({
              restaurant_id: currentRestaurant.id,
              preference: "dislike",
            }),
          });

          if (response.status === 401) {
            window.location.href = "/login-page.html";
            return;
          }

          if (response.ok) {
            const data = await response.json();
            stats.viewed++;
            updateStats();
            removeCard();
            loadNextRestaurant();
          } else {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || "è¨˜éŒ„å¤±æ•—");
          }
        } catch (error) {
          console.error("è¨˜éŒ„ä¸æ„Ÿèˆˆè¶£å¤±æ•—:", error);
          showToast(error.message || "æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
        }
      }

      // è™•ç†æ”¶è—
      async function handleFavorite() {
        if (!currentRestaurant) return;

        try {
          const response = await fetch(`${API_BASE}/restaurants/feedback`, {
            method: "POST",
            headers,
            credentials: 'include',
            body: JSON.stringify({
              restaurant_id: currentRestaurant.id,
              preference: "favorite",
            }),
          });

          if (response.status === 401) {
            window.location.href = "/login-page.html";
            return;
          }

          if (response.ok) {
            const data = await response.json();
            stats.favorited++;
            stats.viewed++;
            updateStats();
            showToast("å·²æ·»åŠ åˆ°æ”¶è—", "success");
            removeCard();
            loadNextRestaurant();
          } else {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || "è¨˜éŒ„å¤±æ•—");
          }
        } catch (error) {
          console.error("è¨˜éŒ„æ”¶è—å¤±æ•—:", error);
          showToast(error.message || "æ“ä½œå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", "error");
        }
      }

      // ç§»é™¤å¡ç‰‡
      function removeCard() {
        const card = document.querySelector(".restaurant-card");
        if (card) {
          card.classList.add("hidden");
          setTimeout(() => card.remove(), 300);
        }
      }

      // åŠ è¼‰ä¸‹ä¸€å€‹é¤å»³
      async function loadNextRestaurant() {
        const restaurant = await getNextRestaurant();
        await displayRestaurant(restaurant);
      }

      // æ›´æ–°çµ±è¨ˆ
      function updateStats() {
        document.getElementById("statsText").textContent = `å·²ç€è¦½: ${stats.viewed} | å–œæ­¡: ${stats.liked} | æ”¶è—: ${stats.favorited}`;
      }

      // é¡¯ç¤ºæç¤º
      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.style.background =
          type === "success" ? "#10b981" : type === "error" ? "#ef4444" : "white";
        toast.style.color = type === "info" ? "#1f2937" : "white";
        toast.textContent = message;

        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.animation = "slideIn 0.3s ease reverse";
          setTimeout(() => toast.remove(), 300);
        }, 2000);
      }

      // äº‹ä»¶ç›£è½
      document.getElementById("likeBtn").addEventListener("click", handleLike);
      document.getElementById("dislikeBtn").addEventListener("click", handleDislike);
      document.getElementById("superLikeBtn").addEventListener("click", handleFavorite);

      document.getElementById("filterBtn").addEventListener("click", () => {
        const panel = document.getElementById("filterPanel");
        panel.classList.toggle("hidden");
      });

      document.getElementById("applyFilter").addEventListener("click", () => {
        loadNextRestaurant();
      });

      // åˆå§‹åŒ–ï¼šç²å–ç”¨æˆ¶ä½ç½®ï¼Œç„¶å¾ŒåŠ è¼‰é¤å»³
      async function init() {
        try {
          // è«‹æ±‚ç”¨æˆ¶ä½ç½®ï¼ˆä¸é˜»å¡é¤å»³åŠ è¼‰ï¼‰
          getUserLocation()
            .then(() => {
              console.log("âœ… ä½ç½®ç²å–æˆåŠŸ:", userLocation);
              showToast("ä½ç½®ç²å–æˆåŠŸ", "success");
            })
            .catch((error) => {
              console.warn("âš ï¸ ç„¡æ³•ç²å–ç”¨æˆ¶ä½ç½®:", error.message || error);
              // ä¸é¡¯ç¤ºéŒ¯èª¤æç¤ºï¼Œå› ç‚ºé€™æ˜¯å¯é¸åŠŸèƒ½
            });
        } catch (error) {
          console.warn("âš ï¸ ä½ç½®ç²å–ç•°å¸¸:", error);
        }
        
        // ç„¡è«–æ˜¯å¦ç²å–åˆ°ä½ç½®ï¼Œéƒ½ç«‹å³é–‹å§‹åŠ è¼‰é¤å»³
        loadNextRestaurant();
      }

      // é é¢è¨­ç½®ï¼šåˆå§‹åŒ– Header å’Œèªè­‰
      async function setupPage() {
        if (window.pageSetup) {
          await window.pageSetup.init({
            currentPage: "heart-mode",
            requireAuth: true,
            showHeader: true,
            showFooter: false,
          });
        }
      }

      // é é¢åŠ è¼‰å®Œæˆå¾Œåˆå§‹åŒ–
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', async () => {
          await setupPage();
          init();
        });
      } else {
        setupPage().then(() => init());
      }
    </script>
  </body>
</html>

