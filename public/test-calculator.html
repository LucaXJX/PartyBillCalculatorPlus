<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ™ºèƒ½è¨ˆç®—é é¢æ¸¬è©¦ - PBCèšè³¬é€š</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #4f46e5;
        --primary-light: #e0e7ff;
        --dark: #1f2937;
        --light: #f8fafc;
      }

      .text-primary {
        color: var(--primary);
      }

      .bg-primary {
        background-color: var(--primary);
      }

      .bg-light {
        background-color: var(--light);
      }

      .text-dark {
        color: var(--dark);
      }

      .test-pass {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
      }

      .test-fail {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
      }

      .test-warning {
        background-color: #fef3c7;
        color: #92400e;
        border: 1px solid #f59e0b;
      }

      .test-info {
        background-color: #dbeafe;
        color: #1e40af;
        border: 1px solid #3b82f6;
      }
    </style>
  </head>

  <body
    class="font-sans text-dark bg-gray-50 min-h-screen"
    style="background-color: #f9fafb"
  >
    <!-- Header å°‡ç”± JavaScript å‹•æ…‹æ’å…¥ -->

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="pt-24 pb-20">
      <section class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h1 class="text-3xl font-bold mb-4 text-dark">
            æ™ºèƒ½è¨ˆç®—é é¢ <span class="text-primary">è‡ªæˆ‘æª¢æŸ¥</span>
          </h1>
          <p class="text-gray-600 max-w-2xl mx-auto text-lg">
            è‡ªå‹•æ¸¬è©¦æ™ºèƒ½è¨ˆç®—é é¢çš„æ‰€æœ‰åŠŸèƒ½å’Œé‚è¼¯
          </p>
        </div>

        <div class="max-w-6xl mx-auto">
          <!-- æ¸¬è©¦æ§åˆ¶é¢æ¿ -->
          <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6">æ¸¬è©¦æ§åˆ¶é¢æ¿</h2>
            <div class="flex flex-wrap gap-4">
              <button
                id="run-all-tests"
                class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary/80 transition-colors"
              >
                <i class="fa fa-play mr-2"></i>é‹è¡Œæ‰€æœ‰æ¸¬è©¦
              </button>
              <button
                id="test-ui-elements"
                class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors"
              >
                <i class="fa fa-desktop mr-2"></i>æ¸¬è©¦UIå…ƒç´ 
              </button>
              <button
                id="test-calculations"
                class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors"
              >
                <i class="fa fa-calculator mr-2"></i>æ¸¬è©¦è¨ˆç®—é‚è¼¯
              </button>
              <button
                id="test-api-endpoints"
                class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition-colors"
              >
                <i class="fa fa-plug mr-2"></i>æ¸¬è©¦APIç«¯é»
              </button>
              <button
                id="test-participant-names"
                class="bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 transition-colors"
              >
                <i class="fa fa-users mr-2"></i>æ¸¬è©¦åƒèˆ‡è€…åç¨±
              </button>
              <button
                id="test-authentication"
                class="bg-red-500 text-white px-6 py-3 rounded-lg hover:bg-red-600 transition-colors"
              >
                <i class="fa fa-lock mr-2"></i>æ¸¬è©¦èªè­‰ç‹€æ…‹
              </button>
              <button
                id="export-results"
                class="bg-indigo-500 text-white px-6 py-3 rounded-lg hover:bg-indigo-600 transition-colors"
              >
                <i class="fa fa-download mr-2"></i>å°å‡ºçµæœ
              </button>
              <button
                id="clear-results"
                class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors"
              >
                <i class="fa fa-trash mr-2"></i>æ¸…é™¤çµæœ
              </button>
            </div>
          </div>

          <!-- æ¸¬è©¦çµæœ -->
          <div class="bg-white rounded-2xl shadow-xl p-8">
            <h2 class="text-2xl font-bold mb-6">æ¸¬è©¦çµæœ</h2>
            <div id="test-results" class="space-y-4">
              <div class="text-center text-gray-500 py-8">
                <i class="fa fa-info-circle text-4xl mb-4"></i>
                <p>é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦</p>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer å°‡ç”± JavaScript å‹•æ…‹æ’å…¥ -->

    <!-- å¼•å…¥å¿…è¦çš„è…³æœ¬ -->
    <script src="/js/auth.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/page-setup.js"></script>

    <script type="module">
      // æ¸¬è©¦çµæœå®¹å™¨
      const testResults = document.getElementById("test-results");

      // æ¸¬è©¦çµ±è¨ˆ
      let testStats = {
        total: 0,
        passed: 0,
        failed: 0,
        warnings: 0,
      };

      // èªè­‰çš„ fetch å‡½æ•¸
      async function authenticatedFetch(url, options = {}) {
        const sessionId = localStorage.getItem("sessionId");
        const headers = {
          "Content-Type": "application/json",
          ...options.headers,
        };

        if (sessionId) {
          headers["Authorization"] = `Bearer ${sessionId}`;
        }

        return fetch(url, {
          ...options,
          headers,
        });
      }

      // æ·»åŠ æ¸¬è©¦çµæœ
      function addTestResult(title, status, message, details = null) {
        // åªçµ±è¨ˆå¯¦éš›çš„æ¸¬è©¦çµæœï¼Œä¸åŒ…æ‹¬ä¿¡æ¯é¡å‹çš„çµæœ
        if (status !== "info") {
          testStats.total++;
          if (testStats[status] !== undefined) {
            testStats[status]++;
          }
        }

        const statusClass = `test-${status}`;
        const statusIcon = {
          pass: "fa-check-circle",
          fail: "fa-times-circle",
          warning: "fa-exclamation-triangle",
          info: "fa-info-circle",
        }[status];

        const resultDiv = document.createElement("div");
        resultDiv.className = `p-4 rounded-lg ${statusClass}`;
        resultDiv.innerHTML = `
           <div class="flex items-start">
             <i class="fa ${statusIcon} text-xl mr-3 mt-1"></i>
             <div class="flex-1">
               <h3 class="font-semibold mb-1">${title}</h3>
               <p class="text-sm mb-2">${message}</p>
               ${
                 details
                   ? `<pre class="text-xs bg-black/10 p-2 rounded overflow-x-auto">${details}</pre>`
                   : ""
               }
             </div>
           </div>
         `;

        testResults.appendChild(resultDiv);
      }

      // æ¸…é™¤æ¸¬è©¦çµæœ
      function clearResults() {
        testResults.innerHTML = `
          <div class="text-center text-gray-500 py-8">
            <i class="fa fa-info-circle text-4xl mb-4"></i>
            <p>é»æ“Šä¸Šæ–¹æŒ‰éˆ•é–‹å§‹æ¸¬è©¦</p>
          </div>
        `;
        testStats = { total: 0, passed: 0, failed: 0, warnings: 0 };
      }

      // é¡¯ç¤ºæ¸¬è©¦çµ±è¨ˆ
      function showTestStats() {
        const statsDiv = document.createElement("div");
        statsDiv.className = "bg-gray-100 p-4 rounded-lg mt-6";
        statsDiv.innerHTML = `
           <h3 class="font-semibold mb-2">æ¸¬è©¦çµ±è¨ˆ</h3>
           <div class="grid grid-cols-4 gap-4 text-center">
             <div>
               <div class="text-2xl font-bold text-gray-800">${testStats.total}</div>
               <div class="text-sm text-gray-600">ç¸½è¨ˆ</div>
             </div>
             <div>
               <div class="text-2xl font-bold text-green-600">${testStats.passed}</div>
               <div class="text-sm text-gray-600">é€šé</div>
             </div>
             <div>
               <div class="text-2xl font-bold text-red-600">${testStats.failed}</div>
               <div class="text-sm text-gray-600">å¤±æ•—</div>
             </div>
             <div>
               <div class="text-2xl font-bold text-yellow-600">${testStats.warnings}</div>
               <div class="text-sm text-gray-600">è­¦å‘Š</div>
             </div>
           </div>
         `;
        testResults.appendChild(statsDiv);
      }

      // å°å‡ºæ¸¬è©¦çµæœ
      function exportResults() {
        const results = [];
        const resultElements = testResults.querySelectorAll(".p-4.rounded-lg");

        // æ·»åŠ æ¸¬è©¦æ¨™é¡Œ
        results.push("# æ™ºèƒ½è¨ˆç®—é é¢æ¸¬è©¦çµæœ");
        results.push("");
        results.push(`**æ¸¬è©¦æ™‚é–“**: ${new Date().toLocaleString("zh-TW")}`);
        results.push("");

        // æ·»åŠ æ¸¬è©¦çµ±è¨ˆ
        results.push("## ğŸ“Š æ¸¬è©¦çµ±è¨ˆ");
        results.push("");
        results.push(`- **ç¸½è¨ˆ**: ${testStats.total} é …æ¸¬è©¦`);
        results.push(`- **é€šé**: ${testStats.passed} é … âœ…`);
        results.push(`- **å¤±æ•—**: ${testStats.failed} é … âŒ`);
        results.push(`- **è­¦å‘Š**: ${testStats.warnings} é … âš ï¸`);
        results.push("");

        // è¨ˆç®—é€šéç‡
        const passRate =
          testStats.total > 0
            ? ((testStats.passed / testStats.total) * 100).toFixed(1)
            : 0;
        results.push(`**é€šéç‡**: ${passRate}%`);
        results.push("");

        // æ·»åŠ è©³ç´°æ¸¬è©¦çµæœ
        results.push("## ğŸ“‹ è©³ç´°æ¸¬è©¦çµæœ");
        results.push("");

        resultElements.forEach((element, index) => {
          const title =
            element.querySelector("h3")?.textContent || `æ¸¬è©¦ ${index + 1}`;
          const message = element.querySelector("p")?.textContent || "";
          const details = element.querySelector("pre")?.textContent || "";

          // åˆ¤æ–·æ¸¬è©¦ç‹€æ…‹
          let status = "";
          let statusIcon = "";
          if (element.classList.contains("test-pass")) {
            status = "âœ… é€šé";
            statusIcon = "âœ…";
          } else if (element.classList.contains("test-fail")) {
            status = "âŒ å¤±æ•—";
            statusIcon = "âŒ";
          } else if (element.classList.contains("test-warning")) {
            status = "âš ï¸ è­¦å‘Š";
            statusIcon = "âš ï¸";
          } else {
            status = "â„¹ï¸ ä¿¡æ¯";
            statusIcon = "â„¹ï¸";
          }

          results.push(`### ${statusIcon} ${title}`);
          results.push("");
          results.push(`**ç‹€æ…‹**: ${status}`);
          results.push(`**æè¿°**: ${message}`);

          if (details) {
            results.push("");
            results.push("**è©³ç´°ä¿¡æ¯**:");
            results.push("```");
            results.push(details);
            results.push("```");
          }

          results.push("");
        });

        // æ·»åŠ ç¸½çµ
        results.push("## ğŸ“ æ¸¬è©¦ç¸½çµ");
        results.push("");

        if (testStats.failed === 0) {
          results.push("ğŸ‰ **æ‰€æœ‰æ¸¬è©¦éƒ½é€šéäº†ï¼** æ™ºèƒ½è¨ˆç®—é é¢åŠŸèƒ½æ­£å¸¸ã€‚");
        } else {
          results.push(
            `âš ï¸ **ç™¼ç¾ ${testStats.failed} å€‹å•é¡Œ**ï¼Œéœ€è¦é€²ä¸€æ­¥æª¢æŸ¥å’Œä¿®å¾©ã€‚`
          );
        }

        results.push("");
        results.push("---");
        results.push(`*æ­¤å ±å‘Šç”± PBCèšè³¬é€š æ™ºèƒ½è¨ˆç®—é é¢æ¸¬è©¦ç³»çµ±è‡ªå‹•ç”Ÿæˆ*`);

        // å‰µå»ºä¸¦ä¸‹è¼‰æ–‡ä»¶
        const content = results.join("\n");
        const blob = new Blob([content], {
          type: "text/markdown;charset=utf-8",
        });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `æ™ºèƒ½è¨ˆç®—é é¢æ¸¬è©¦çµæœ_${
          new Date().toISOString().split("T")[0]
        }.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // åŒæ™‚è¤‡è£½åˆ°å‰ªè²¼æ¿
        navigator.clipboard
          .writeText(content)
          .then(() => {
            addTestResult(
              "å°å‡ºçµæœ",
              "pass",
              "æ¸¬è©¦çµæœå·²å°å‡ºç‚º Markdown æ–‡ä»¶ä¸¦è¤‡è£½åˆ°å‰ªè²¼æ¿"
            );
          })
          .catch(() => {
            addTestResult(
              "å°å‡ºçµæœ",
              "warning",
              "æ¸¬è©¦çµæœå·²å°å‡ºç‚º Markdown æ–‡ä»¶ï¼Œä½†è¤‡è£½åˆ°å‰ªè²¼æ¿å¤±æ•—"
            );
          });
      }

      // æ¸¬è©¦UIå…ƒç´ 
      async function testUIElements() {
        addTestResult("UIå…ƒç´ æ¸¬è©¦", "info", "é–‹å§‹æ¸¬è©¦æ™ºèƒ½è¨ˆç®—é é¢çš„UIå…ƒç´ ...");

        try {
          // æ¸¬è©¦é é¢æ˜¯å¦å¯ä»¥è¨ªå•
          const response = await fetch("/calculator.html");
          if (response.ok) {
            addTestResult("é é¢å¯è¨ªå•æ€§", "pass", "æ™ºèƒ½è¨ˆç®—é é¢å¯ä»¥æ­£å¸¸è¨ªå•");
          } else {
            addTestResult(
              "é é¢å¯è¨ªå•æ€§",
              "fail",
              `é é¢è¨ªå•å¤±æ•—: ${response.status}`
            );
          }

          // æ¸¬è©¦èªè­‰ç‹€æ…‹
          if (window.authManager && window.authManager.isAuthenticated()) {
            const user = window.authManager.getCurrentUser();
            const sessionId = localStorage.getItem("sessionId");
            addTestResult(
              "ç”¨æˆ¶èªè­‰",
              "pass",
              `ç”¨æˆ¶å·²ç™»éŒ„: ${user?.username}ï¼ŒSession ID: ${
                sessionId ? "å·²è¨­ç½®" : "æœªè¨­ç½®"
              }`
            );
          } else {
            addTestResult(
              "ç”¨æˆ¶èªè­‰",
              "warning",
              "ç”¨æˆ¶æœªç™»éŒ„ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½ç„¡æ³•æ¸¬è©¦"
            );
          }

          // æ¸¬è©¦çµ„ä»¶ç³»çµ±
          if (window.componentManager) {
            addTestResult("çµ„ä»¶ç³»çµ±", "pass", "çµ„ä»¶ç®¡ç†å™¨å·²åŠ è¼‰");
          } else {
            addTestResult("çµ„ä»¶ç³»çµ±", "fail", "çµ„ä»¶ç®¡ç†å™¨æœªåŠ è¼‰");
          }

          // æ¸¬è©¦èªè­‰token
          const sessionId = localStorage.getItem("sessionId");
          if (sessionId) {
            addTestResult(
              "èªè­‰Token",
              "pass",
              `Session ID å·²è¨­ç½®: ${sessionId.substring(0, 10)}...`
            );
          } else {
            addTestResult(
              "èªè­‰Token",
              "fail",
              "Session ID æœªè¨­ç½®ï¼ŒAPIèª¿ç”¨å°‡å¤±æ•—"
            );
          }
        } catch (error) {
          addTestResult(
            "UIå…ƒç´ æ¸¬è©¦",
            "fail",
            `æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`,
            error.stack
          );
        }
      }

      // æ¸¬è©¦è¨ˆç®—é‚è¼¯
      async function testCalculations() {
        addTestResult("è¨ˆç®—é‚è¼¯æ¸¬è©¦", "info", "é–‹å§‹æ¸¬è©¦è¨ˆç®—é‚è¼¯...");

        try {
          // æ¸¬è©¦åŸºæœ¬è¨ˆç®—
          const testCases = [
            {
              name: "å¹³å‡åˆ†æ”¤æ¸¬è©¦",
              participants: ["A", "B", "C"],
              items: [
                {
                  name: "é¤è²»",
                  amount: 300,
                  shared: true,
                  participants: ["A", "B", "C"],
                },
              ],
              expected: { A: 100, B: 100, C: 100 },
            },
            {
              name: "éƒ¨åˆ†åƒèˆ‡æ¸¬è©¦",
              participants: ["A", "B", "C"],
              items: [
                {
                  name: "é¤è²»",
                  amount: 300,
                  shared: false,
                  participants: ["A", "B"],
                },
              ],
              expected: { A: 150, B: 150, C: 0 },
            },
            {
              name: "å°è²»è¨ˆç®—æ¸¬è©¦",
              participants: ["A", "B"],
              items: [
                {
                  name: "é¤è²»",
                  amount: 200,
                  shared: true,
                  participants: ["A", "B"],
                },
              ],
              tipPercentage: 10,
              expected: { A: 110, B: 110 },
            },
            {
              name: "å¤šé …ç›®æ··åˆæ¸¬è©¦",
              participants: ["A", "B", "C"],
              items: [
                {
                  name: "é¤è²»",
                  amount: 300,
                  shared: true,
                  participants: ["A", "B", "C"],
                },
                {
                  name: "é£²æ–™",
                  amount: 60,
                  shared: false,
                  participants: ["A", "B"],
                },
              ],
              expected: { A: 130, B: 130, C: 100 },
            },
          ];

          for (const testCase of testCases) {
            try {
              // é€™è£¡å¯ä»¥èª¿ç”¨å¯¦éš›çš„è¨ˆç®—å‡½æ•¸
              // æš«æ™‚æ¨¡æ“¬è¨ˆç®—çµæœ
              const result = simulateCalculation(testCase);

              if (
                JSON.stringify(result) === JSON.stringify(testCase.expected)
              ) {
                addTestResult(
                  testCase.name,
                  "pass",
                  `è¨ˆç®—çµæœæ­£ç¢º: ${JSON.stringify(result)}`
                );
              } else {
                addTestResult(
                  testCase.name,
                  "fail",
                  `è¨ˆç®—çµæœéŒ¯èª¤ã€‚æœŸæœ›: ${JSON.stringify(
                    testCase.expected
                  )}, å¯¦éš›: ${JSON.stringify(result)}`
                );
              }
            } catch (error) {
              addTestResult(
                testCase.name,
                "fail",
                `è¨ˆç®—éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`
              );
            }
          }
        } catch (error) {
          addTestResult(
            "è¨ˆç®—é‚è¼¯æ¸¬è©¦",
            "fail",
            `æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`,
            error.stack
          );
        }

        // æ¸¬è©¦å¯¦éš›APIè¨ˆç®—
        await testActualAPICalculation();
      }

      // æ¸¬è©¦å¯¦éš›APIè¨ˆç®—
      async function testActualAPICalculation() {
        addTestResult("å¯¦éš›APIè¨ˆç®—æ¸¬è©¦", "info", "é–‹å§‹æ¸¬è©¦å¯¦éš›APIè¨ˆç®—...");

        try {
          // é¦–å…ˆé‡ç½®è³¬å–®
          const resetResponse = await authenticatedFetch("/api/bill/reset", {
            method: "POST",
          });

          if (!resetResponse.ok) {
            addTestResult(
              "é‡ç½®è³¬å–®",
              "fail",
              `é‡ç½®å¤±æ•—: ${resetResponse.status}`
            );
            return;
          }

          // æ·»åŠ æ¸¬è©¦åƒèˆ‡è€…
          const participantNames = ["æ¸¬è©¦ç”¨æˆ¶A", "æ¸¬è©¦ç”¨æˆ¶B", "æ¸¬è©¦ç”¨æˆ¶C"];
          for (const name of participantNames) {
            const response = await authenticatedFetch("/api/participant", {
              method: "POST",
              body: JSON.stringify({ name }),
            });

            if (!response.ok) {
              addTestResult(
                "æ·»åŠ åƒèˆ‡è€…",
                "fail",
                `æ·»åŠ åƒèˆ‡è€… ${name} å¤±æ•—: ${response.status}`
              );
              return;
            }
          }

          // æ›´æ–°è³¬å–®ä¿¡æ¯
          const billInfoResponse = await authenticatedFetch("/api/bill/info", {
            method: "POST",
            body: JSON.stringify({
              name: "æ¸¬è©¦è³¬å–®",
              date: new Date().toISOString().split("T")[0],
              location: "æ¸¬è©¦åœ°é»",
              tipPercentage: 10,
            }),
          });

          if (!billInfoResponse.ok) {
            addTestResult(
              "æ›´æ–°è³¬å–®ä¿¡æ¯",
              "fail",
              `æ›´æ–°å¤±æ•—: ${billInfoResponse.status}`
            );
            return;
          }

          // ç²å–åƒèˆ‡è€…åˆ—è¡¨
          const participantsResponse = await authenticatedFetch(
            "/api/participants"
          );
          if (!participantsResponse.ok) {
            addTestResult(
              "ç²å–åƒèˆ‡è€…åˆ—è¡¨",
              "fail",
              `ç²å–åƒèˆ‡è€…å¤±æ•—: ${participantsResponse.status}`
            );
            return;
          }

          const participants = await participantsResponse.json();
          if (participants.length === 0) {
            addTestResult("åƒèˆ‡è€…åˆ—è¡¨", "fail", "åƒèˆ‡è€…åˆ—è¡¨ç‚ºç©ºï¼Œç„¡æ³•æ·»åŠ é …ç›®");
            return;
          }

          // æ·»åŠ æ¸¬è©¦é …ç›®
          const testItem = {
            name: "æ¸¬è©¦é¤è²»",
            amount: 300,
            isShared: true,
            participantIds: participants.map((p) => p.id), // ä½¿ç”¨å¯¦éš›çš„åƒèˆ‡è€…ID
          };

          const itemResponse = await authenticatedFetch("/api/item", {
            method: "POST",
            body: JSON.stringify(testItem),
          });

          if (!itemResponse.ok) {
            addTestResult(
              "æ·»åŠ é …ç›®",
              "fail",
              `æ·»åŠ é …ç›®å¤±æ•—: ${itemResponse.status}`
            );
            return;
          }

          // åŸ·è¡Œè¨ˆç®—
          const calculateResponse = await authenticatedFetch("/api/calculate");
          if (!calculateResponse.ok) {
            addTestResult(
              "APIè¨ˆç®—",
              "fail",
              `è¨ˆç®—å¤±æ•—: ${calculateResponse.status}`
            );
            return;
          }

          const { bill, results } = await calculateResponse.json();

          // é©—è­‰è¨ˆç®—çµæœ
          if (results && results.length === 3) {
            const totalAmount = results.reduce((sum, r) => sum + r.amount, 0);
            const expectedTotal = 300 + 300 * 0.1; // 300 + 10% å°è²» = 330

            if (Math.abs(totalAmount - expectedTotal) < 0.01) {
              addTestResult(
                "APIè¨ˆç®—çµæœ",
                "pass",
                `è¨ˆç®—æ­£ç¢º: ç¸½é‡‘é¡ ${totalAmount.toFixed(
                  2
                )}, é æœŸ ${expectedTotal.toFixed(2)}`
              );
            } else {
              addTestResult(
                "APIè¨ˆç®—çµæœ",
                "fail",
                `è¨ˆç®—éŒ¯èª¤: ç¸½é‡‘é¡ ${totalAmount.toFixed(
                  2
                )}, é æœŸ ${expectedTotal.toFixed(2)}`
              );
            }
          } else {
            addTestResult(
              "APIè¨ˆç®—çµæœ",
              "fail",
              `çµæœæ ¼å¼éŒ¯èª¤: æœŸæœ›3å€‹åƒèˆ‡è€…ï¼Œå¯¦éš›${results?.length || 0}å€‹`
            );
          }
        } catch (error) {
          addTestResult(
            "å¯¦éš›APIè¨ˆç®—æ¸¬è©¦",
            "fail",
            `æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`,
            error.stack
          );
        }
      }

      // æ¨¡æ“¬è¨ˆç®—å‡½æ•¸
      function simulateCalculation(testCase) {
        const result = {};

        // åˆå§‹åŒ–æ‰€æœ‰åƒèˆ‡è€…
        testCase.participants.forEach((p) => (result[p] = 0));

        // è¨ˆç®—æ¯å€‹é …ç›®
        testCase.items.forEach((item) => {
          const amountPerPerson = item.amount / item.participants.length;
          item.participants.forEach((p) => {
            result[p] += amountPerPerson;
          });
        });

        // è¨ˆç®—å°è²»
        if (testCase.tipPercentage) {
          const subtotal = testCase.items.reduce(
            (sum, item) => sum + item.amount,
            0
          );
          const totalTip = subtotal * (testCase.tipPercentage / 100);

          // æŒ‰åƒèˆ‡è€…çš„æ¶ˆè²»æ¯”ä¾‹åˆ†æ”¤å°è²»
          testCase.participants.forEach((participant) => {
            const participantSubtotal = result[participant];
            const participantTip = (participantSubtotal / subtotal) * totalTip;
            result[participant] += participantTip;
          });
        }

        // å››æ¨äº”å…¥åˆ°å…©ä½å°æ•¸
        Object.keys(result).forEach((key) => {
          result[key] = Math.round(result[key] * 100) / 100;
        });

        return result;
      }

      // æ¸¬è©¦APIç«¯é»
      async function testAPIEndpoints() {
        addTestResult("APIç«¯é»æ¸¬è©¦", "info", "é–‹å§‹æ¸¬è©¦APIç«¯é»...");

        const endpoints = [
          { path: "/api/auth/me", method: "GET", name: "ç”¨æˆ¶ä¿¡æ¯" },
          { path: "/api/calculate", method: "GET", name: "è¨ˆç®—è³¬å–®" },
          { path: "/api/bill/save", method: "POST", name: "ä¿å­˜è³¬å–®" },
          {
            path: "/api/users/search?query=test",
            method: "GET",
            name: "æœç´¢ç”¨æˆ¶",
          },
          { path: "/api/participants", method: "GET", name: "ç²å–åƒèˆ‡è€…" },
          { path: "/api/bill/info", method: "POST", name: "æ›´æ–°è³¬å–®ä¿¡æ¯" },
          { path: "/api/receipt/upload", method: "POST", name: "ä¸Šå‚³æ”¶æ“š" },
          { path: "/api/bill/payment-status", method: "POST", name: "æ›´æ–°æ”¯ä»˜ç‹€æ…‹" },
          { path: "/api/bill/confirm-payment", method: "POST", name: "ç¢ºèªæ”¶æ¬¾" },
        ];

        for (const endpoint of endpoints) {
          try {
            const response = await authenticatedFetch(endpoint.path, {
              method: endpoint.method,
            });

            if (response.status === 200) {
              addTestResult(
                endpoint.name,
                "pass",
                `ç«¯é»éŸ¿æ‡‰æ­£å¸¸: ${response.status}`
              );
            } else if (response.status === 401) {
              addTestResult(
                endpoint.name,
                "warning",
                `ç«¯é»éœ€è¦èªè­‰: ${response.status} (é€™æ˜¯æ­£å¸¸çš„ï¼Œå¦‚æœç”¨æˆ¶æœªç™»éŒ„)`
              );
            } else if (response.status === 404) {
              addTestResult(
                endpoint.name,
                "fail",
                `ç«¯é»ä¸å­˜åœ¨: ${response.status}`
              );
            } else {
              addTestResult(
                endpoint.name,
                "warning",
                `ç«¯é»éŸ¿æ‡‰ç•°å¸¸: ${response.status}`
              );
            }
          } catch (error) {
            addTestResult(
              endpoint.name,
              "fail",
              `ç«¯é»æ¸¬è©¦å¤±æ•—: ${error.message}`
            );
          }
        }
      }

      // æ¸¬è©¦åƒèˆ‡è€…åç¨±å•é¡Œ
      async function testParticipantNames() {
        addTestResult("åƒèˆ‡è€…åç¨±æ¸¬è©¦", "info", "é–‹å§‹æ¸¬è©¦åƒèˆ‡è€…åç¨±è™•ç†...");

        try {
          // é‡ç½®è³¬å–®
          const resetResponse = await authenticatedFetch("/api/bill/reset", {
            method: "POST",
          });

          // æ·»åŠ æ¸¬è©¦åƒèˆ‡è€…ï¼ˆåŒ…å«é•·åç¨±å’Œç‰¹æ®Šå­—ç¬¦ï¼‰
          const testNames = [
            "å¼µä¸‰",
            "æå››",
            "ç‹å°æ˜",
            "é™³å¤§è¯",
            "æ¸¬è©¦ç”¨æˆ¶å¾ˆé•·çš„åç¨±",
            "User@example.com",
          ];

          for (const name of testNames) {
            const response = await authenticatedFetch("/api/participant", {
              method: "POST",
              body: JSON.stringify({ name }),
            });

            if (response.ok) {
              const participant = await response.json();
              if (participant.name === name) {
                addTestResult(
                  `åƒèˆ‡è€…åç¨±: ${name}`,
                  "pass",
                  `åç¨±æ­£ç¢ºä¿å­˜: ${participant.name}`
                );
              } else {
                addTestResult(
                  `åƒèˆ‡è€…åç¨±: ${name}`,
                  "fail",
                  `åç¨±è¢«æˆªæ–·æˆ–ä¿®æ”¹: æœŸæœ› "${name}", å¯¦éš› "${participant.name}"`
                );
              }
            } else {
              addTestResult(
                `åƒèˆ‡è€…åç¨±: ${name}`,
                "fail",
                `æ·»åŠ å¤±æ•—: ${response.status}`
              );
            }
          }

          // ç²å–æ‰€æœ‰åƒèˆ‡è€…ä¸¦æª¢æŸ¥
          const participantsResponse = await authenticatedFetch(
            "/api/participants"
          );
          if (participantsResponse.ok) {
            const participantList = await participantsResponse.json();
            addTestResult(
              "åƒèˆ‡è€…åˆ—è¡¨",
              "pass",
              `æˆåŠŸç²å– ${participantList.length} å€‹åƒèˆ‡è€…`
            );

            // æª¢æŸ¥æ¯å€‹åƒèˆ‡è€…çš„åç¨±
            participantList.forEach((p, index) => {
              if (p.name && p.name.trim()) {
                addTestResult(
                  `åƒèˆ‡è€… ${index + 1}`,
                  "pass",
                  `åç¨±: "${p.name}", ID: ${p.id}`
                );
              } else {
                addTestResult(
                  `åƒèˆ‡è€… ${index + 1}`,
                  "fail",
                  `åç¨±ç‚ºç©ºæˆ–ç„¡æ•ˆ: "${p.name}"`
                );
              }
            });
          }
        } catch (error) {
          addTestResult(
            "åƒèˆ‡è€…åç¨±æ¸¬è©¦",
            "fail",
            `æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`,
            error.stack
          );
        }
      }

      // æ¸¬è©¦èªè­‰ç‹€æ…‹
      async function testAuthentication() {
        addTestResult("èªè­‰æ¸¬è©¦", "info", "é–‹å§‹æ¸¬è©¦èªè­‰ç‹€æ…‹...");

        try {
          // æª¢æŸ¥localStorageä¸­çš„èªè­‰ä¿¡æ¯
          const sessionId = localStorage.getItem("sessionId");
          const userData = localStorage.getItem("user");

          if (sessionId) {
            addTestResult(
              "Session ID",
              "pass",
              `Session ID å­˜åœ¨: ${sessionId.substring(0, 10)}...`
            );
          } else {
            addTestResult("Session ID", "fail", "Session ID ä¸å­˜åœ¨");
          }

          if (userData) {
            const user = JSON.parse(userData);
            addTestResult("ç”¨æˆ¶æ•¸æ“š", "pass", `ç”¨æˆ¶æ•¸æ“šå­˜åœ¨: ${user.username}`);
          } else {
            addTestResult("ç”¨æˆ¶æ•¸æ“š", "fail", "ç”¨æˆ¶æ•¸æ“šä¸å­˜åœ¨");
          }

          // æ¸¬è©¦èªè­‰API
          const authResponse = await authenticatedFetch("/api/auth/me");
          if (authResponse.ok) {
            const authData = await authResponse.json();
            addTestResult(
              "èªè­‰API",
              "pass",
              `èªè­‰APIæ­£å¸¸: ${authData.user.username}`
            );
          } else {
            addTestResult(
              "èªè­‰API",
              "fail",
              `èªè­‰APIå¤±æ•—: ${authResponse.status}`
            );
          }
        } catch (error) {
          addTestResult(
            "èªè­‰æ¸¬è©¦",
            "fail",
            `èªè­‰æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`,
            error.stack
          );
        }
      }

      // é‹è¡Œæ‰€æœ‰æ¸¬è©¦
      async function runAllTests() {
        clearResults();
        addTestResult("å…¨é¢æ¸¬è©¦", "info", "é–‹å§‹é‹è¡Œæ‰€æœ‰æ¸¬è©¦...");

        await testUIElements();
        await testAuthentication();
        await testCalculations();
        await testAPIEndpoints();
        await testParticipantNames();

        showTestStats();
      }

      // è¨­ç½®æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶
      function setupTestButtons() {
        try {
          console.log("é–‹å§‹è¨­ç½®æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨...");

          // è¨­ç½®æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶
          const runAllBtn = document.getElementById("run-all-tests");
          const testUIBtn = document.getElementById("test-ui-elements");
          const testCalcBtn = document.getElementById("test-calculations");
          const testAPIBtn = document.getElementById("test-api-endpoints");
          const testPartBtn = document.getElementById("test-participant-names");
          const testAuthBtn = document.getElementById("test-authentication");
          const exportBtn = document.getElementById("export-results");
          const clearBtn = document.getElementById("clear-results");

          console.log("æŒ‰éˆ•å…ƒç´ æª¢æŸ¥:", {
            runAllBtn: !!runAllBtn,
            testUIBtn: !!testUIBtn,
            testCalcBtn: !!testCalcBtn,
            testAPIBtn: !!testAPIBtn,
            testPartBtn: !!testPartBtn,
            testAuthBtn: !!testAuthBtn,
            exportBtn: !!exportBtn,
            clearBtn: !!clearBtn,
          });

          if (runAllBtn) {
            runAllBtn.addEventListener("click", runAllTests);
            console.log("é‹è¡Œæ‰€æœ‰æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶å·²è¨­ç½®");
          }
          if (testUIBtn) {
            testUIBtn.addEventListener("click", testUIElements);
            console.log("UIå…ƒç´ æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶å·²è¨­ç½®");
          }
          if (testCalcBtn) {
            testCalcBtn.addEventListener("click", testCalculations);
            console.log("è¨ˆç®—æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶å·²è¨­ç½®");
          }
          if (testAPIBtn) {
            testAPIBtn.addEventListener("click", testAPIEndpoints);
            console.log("APIç«¯é»æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶å·²è¨­ç½®");
          }
          if (testPartBtn) {
            testPartBtn.addEventListener("click", testParticipantNames);
            console.log("åƒèˆ‡è€…åç¨±æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶å·²è¨­ç½®");
          }
          if (testAuthBtn) {
            testAuthBtn.addEventListener("click", testAuthentication);
            console.log("èªè­‰æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶å·²è¨­ç½®");
          }
          if (exportBtn) {
            exportBtn.addEventListener("click", exportResults);
            console.log("å°å‡ºçµæœæŒ‰éˆ•äº‹ä»¶å·²è¨­ç½®");
          }
          if (clearBtn) {
            clearBtn.addEventListener("click", clearResults);
            console.log("æ¸…é™¤çµæœæŒ‰éˆ•äº‹ä»¶å·²è¨­ç½®");
          }

          console.log("æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨è¨­ç½®å®Œæˆ");

          // æ·»åŠ ä¸€å€‹ç°¡å–®çš„æ¸¬è©¦ä¾†é©—è­‰æŒ‰éˆ•æ˜¯å¦å·¥ä½œ
          setTimeout(() => {
            console.log("æ¸¬è©¦æŒ‰éˆ•é»æ“ŠåŠŸèƒ½...");
            const testBtn = document.getElementById("run-all-tests");
            if (testBtn) {
              console.log("é‹è¡Œæ‰€æœ‰æ¸¬è©¦æŒ‰éˆ•å­˜åœ¨ï¼Œå¯ä»¥é»æ“Š");
            } else {
              console.error("é‹è¡Œæ‰€æœ‰æ¸¬è©¦æŒ‰éˆ•ä¸å­˜åœ¨ï¼");
            }
          }, 1000);
        } catch (error) {
          console.error("è¨­ç½®æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶ç›£è½å™¨å¤±æ•—:", error);
        }
      }

      // é é¢åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          console.log("é é¢DOMå·²åŠ è¼‰ï¼Œé–‹å§‹åˆå§‹åŒ–...");

          // é¦–å…ˆè¨­ç½®æ¸¬è©¦æŒ‰éˆ•äº‹ä»¶ï¼ˆç¢ºä¿æŒ‰éˆ•å§‹çµ‚å¯ç”¨ï¼‰
          setupTestButtons();

          // è¨­ç½®é é¢çµ„ä»¶ï¼ˆéœ€è¦èªè­‰ï¼‰
          const pageInitialized = await window.pageSetup.init({
            currentPage: "test-calculator",
            requireAuth: true,
            showHeader: true,
            showFooter: true,
          });

          if (pageInitialized) {
            console.log("æ™ºèƒ½è¨ˆç®—æ¸¬è©¦é é¢åˆå§‹åŒ–æˆåŠŸ");

            // è¨­ç½®é é¢ç‰¹å®šåŠŸèƒ½
            window.pageSetup.setupPageFeatures({
              updateUserDisplay: true,
              setupLogout: true,
              setupAuthCheck: true,
            });

            console.log("æ™ºèƒ½è¨ˆç®—æ¸¬è©¦é é¢åŠŸèƒ½è¨­ç½®å®Œæˆ");
          } else {
            console.log("æ™ºèƒ½è¨ˆç®—æ¸¬è©¦é é¢åˆå§‹åŒ–å¤±æ•—ï¼Œä½†æ¸¬è©¦æŒ‰éˆ•ä»å¯ä½¿ç”¨");
          }
        } catch (error) {
          console.error("æ™ºèƒ½è¨ˆç®—æ¸¬è©¦é é¢åˆå§‹åŒ–éŒ¯èª¤:", error);
          console.log("æ¸¬è©¦æŒ‰éˆ•ä»å¯ä½¿ç”¨");
        }

        // å‚™ç”¨æŒ‰éˆ•è¨­ç½®ï¼ˆå»¶é²åŸ·è¡Œï¼Œç¢ºä¿DOMå®Œå…¨åŠ è¼‰ï¼‰
        setTimeout(() => {
          console.log("åŸ·è¡Œå‚™ç”¨æŒ‰éˆ•è¨­ç½®...");
          setupTestButtons();
        }, 2000);
      });
    </script>
  </body>
</html>
