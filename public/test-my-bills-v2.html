<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æˆ‘çš„è³¬å–®é é¢å®Œæ•´æ¸¬è©¦ - ç¬¬äºŒéšæ®µV2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <style>
      .test-pass {
        color: #10b981;
      }
      .test-fail {
        color: #ef4444;
      }
      .test-warn {
        color: #f59e0b;
      }
      .test-info {
        color: #3b82f6;
      }
    </style>
  </head>
  <body class="bg-gray-100 p-8">
    <div class="max-w-7xl mx-auto">
      <div class="mb-6">
        <h1 class="text-3xl font-bold mb-2">æˆ‘çš„è³¬å–®é é¢å®Œæ•´æ¸¬è©¦ç³»çµ± V2</h1>
        <p class="text-gray-600">
          ç¬¬äºŒéšæ®µï¼šAPIåŠŸèƒ½ã€ç‹€æ…‹è®Šæ›´é‚è¼¯ã€å¯¦éš›æ“ä½œæ¸¬è©¦
        </p>
        <p class="text-sm text-yellow-600 mt-2">
          <i class="fas fa-info-circle mr-1"></i>
          å»ºè­°ï¼šå…ˆåœ¨ã€Œæˆ‘çš„è³¬å–®ã€é é¢é€²è¡Œæ‰‹å‹•æ¸¬è©¦ï¼Œå†ä½¿ç”¨æ­¤é é¢é©—è­‰API
        </p>
      </div>

      <!-- å¿«é€Ÿå°èˆª -->
      <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="flex flex-wrap gap-2">
          <a
            href="/my-bills.html"
            target="_blank"
            class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
          >
            <i class="fas fa-external-link-alt mr-2"></i>æ‰“é–‹æˆ‘çš„è³¬å–®é é¢
          </a>
          <a
            href="/calculator.html"
            target="_blank"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
          >
            <i class="fas fa-calculator mr-2"></i>æ‰“é–‹æ™ºèƒ½è¨ˆç®—é é¢
          </a>
        </div>
      </div>

      <!-- æ§åˆ¶é¢æ¿ -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex flex-wrap items-center gap-4 mb-4">
          <button
            id="run-all-tests"
            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700"
          >
            <i class="fas fa-play mr-2"></i>é‹è¡Œæ‰€æœ‰æ¸¬è©¦
          </button>
          <button
            id="test-payment-update"
            class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700"
          >
            <i class="fas fa-dollar-sign mr-2"></i>æ¸¬è©¦æ”¯ä»˜ç‹€æ…‹æ›´æ–°
          </button>
          <button
            id="test-confirm-payment"
            class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700"
          >
            <i class="fas fa-check mr-2"></i>æ¸¬è©¦ç¢ºèªæ”¶æ¬¾
          </button>
          <button
            id="export-results"
            class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700"
          >
            <i class="fas fa-download mr-2"></i>å°å‡ºçµæœ
          </button>
        </div>

        <!-- çµ±è¨ˆä¿¡æ¯ -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-4">
          <div class="bg-green-50 p-4 rounded-lg">
            <div class="text-sm text-gray-600">é€šé</div>
            <div class="text-2xl font-bold text-green-600" id="pass-count">
              0
            </div>
          </div>
          <div class="bg-red-50 p-4 rounded-lg">
            <div class="text-sm text-gray-600">å¤±æ•—</div>
            <div class="text-2xl font-bold text-red-600" id="fail-count">0</div>
          </div>
          <div class="bg-yellow-50 p-4 rounded-lg">
            <div class="text-sm text-gray-600">è­¦å‘Š</div>
            <div class="text-2xl font-bold text-yellow-600" id="warn-count">
              0
            </div>
          </div>
          <div class="bg-blue-50 p-4 rounded-lg">
            <div class="text-sm text-gray-600">ä¿¡æ¯</div>
            <div class="text-2xl font-bold text-blue-600" id="info-count">
              0
            </div>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg">
            <div class="text-sm text-gray-600">ç¸½è¨ˆ</div>
            <div class="text-2xl font-bold text-gray-600" id="total-count">
              0
            </div>
          </div>
        </div>
      </div>

      <!-- æ‰‹å‹•æ“ä½œæŒ‡å— -->
      <div class="bg-yellow-50 border-l-4 border-yellow-500 p-6 mb-6 rounded">
        <h3 class="font-bold text-yellow-800 mb-3">
          <i class="fas fa-hand-point-right mr-2"></i>æ‰‹å‹•æ¸¬è©¦æŒ‡å—
        </h3>
        <div class="space-y-2 text-sm text-yellow-700">
          <p><strong>æ¸¬è©¦æ‡‰ä»˜æ¬¾ï¼ˆåƒèˆ‡è€…è¦–è§’ï¼‰ï¼š</strong></p>
          <ol class="list-decimal ml-6 space-y-1">
            <li>
              åœ¨ã€Œæˆ‘çš„è³¬å–®ã€é é¢æ‰¾åˆ°ä¸€å€‹å¾…æ”¯ä»˜çš„æ‡‰ä»˜æ¬¾è³¬å–®ï¼ˆä¾‹å¦‚ï¼šç”Ÿæ—¥èšæœƒï¼‰
            </li>
            <li>é»æ“Šã€Œæ›´æ–°æ”¯ä»˜ã€æŒ‰éˆ•</li>
            <li>é¸æ“‡ã€Œå·²æ”¯ä»˜ã€</li>
            <li>ä¸Šå‚³æ”¶æ“šåœ–ç‰‡ï¼ˆå¯é¸ï¼‰</li>
            <li>é»æ“Šã€Œä¿å­˜ã€</li>
            <li>æª¢æŸ¥è³¬å–®ç‹€æ…‹æ˜¯å¦æ›´æ–°ç‚ºã€Œå·²æ”¯ä»˜ã€</li>
            <li>æª¢æŸ¥çµ±è¨ˆæ•¸æ“šï¼ˆå¾…æ”¯ä»˜ -1ï¼Œå·²æ”¯ä»˜ +1ï¼Œæ‡‰ä»˜æ¬¾ -é‡‘é¡ï¼‰</li>
          </ol>

          <p class="mt-4"><strong>æ¸¬è©¦æ‡‰æ”¶æ¬¾ï¼ˆä»˜æ¬¾äººè¦–è§’ï¼‰ï¼š</strong></p>
          <ol class="list-decimal ml-6 space-y-1">
            <li>
              åœ¨ã€Œæˆ‘çš„è³¬å–®ã€é é¢æ‰¾åˆ°ä¸€å€‹æ‚¨æ˜¯ä»˜æ¬¾äººçš„è³¬å–®ï¼ˆä¾‹å¦‚ï¼šåœ˜éšŠåˆé¤ï¼‰
            </li>
            <li>é»æ“Šã€ŒæŸ¥çœ‹æ‡‰æ”¶æ¬¾ã€æŒ‰éˆ•</li>
            <li>æŸ¥çœ‹å“ªäº›äººå·²ä»˜æ¬¾ã€å“ªäº›äººå¾…ä»˜æ¬¾</li>
            <li>å°æ–¼å·²ä»˜æ¬¾çš„äººï¼Œé»æ“Šã€ŒæŸ¥çœ‹æ”¶æ“šã€æŸ¥çœ‹è½‰è³¬æˆªåœ–</li>
            <li>é»æ“Šã€Œç¢ºèªæ”¶æ¬¾ã€ç¢ºèªå·²æ”¶åˆ°æ¬¾é …</li>
            <li>æª¢æŸ¥è©²äººçš„ç‹€æ…‹æ˜¯å¦é¡¯ç¤ºã€Œâœ“ å·²ç¢ºèªã€</li>
          </ol>
        </div>
      </div>

      <!-- æ¸¬è©¦çµæœ -->
      <div id="test-results" class="space-y-4"></div>
    </div>

    <script type="module">
      let testResults = [];
      let stats = { pass: 0, fail: 0, warn: 0, info: 0, total: 0 };
      let testBills = null;
      let currentUser = null;

      // èªè­‰ fetch
      async function authenticatedFetch(url, options = {}) {
        const sessionId = localStorage.getItem("sessionId");
        if (!sessionId) {
          throw new Error("æœªç™»å…¥");
        }

        const headers = {
          ...options.headers,
          Authorization: `Bearer ${sessionId}`,
        };

        if (!(options.body instanceof FormData)) {
          headers["Content-Type"] = "application/json";
        }

        const response = await fetch(url, { ...options, headers });

        if (response.status === 401) {
          throw new Error("èªè­‰å¤±æ•—");
        }

        return response;
      }

      // æ·»åŠ æ¸¬è©¦çµæœ
      function addResult(category, name, status, message, details = null) {
        const result = {
          timestamp: new Date().toISOString(),
          category,
          name,
          status,
          message,
          details,
        };
        testResults.push(result);
        stats.total++;
        if (stats[status] !== undefined) stats[status]++;
        updateStats();
        renderResult(result);
      }

      function updateStats() {
        document.getElementById("pass-count").textContent = stats.pass;
        document.getElementById("fail-count").textContent = stats.fail;
        document.getElementById("warn-count").textContent = stats.warn;
        document.getElementById("info-count").textContent = stats.info;
        document.getElementById("total-count").textContent = stats.total;
      }

      function renderResult(result) {
        const container = document.getElementById("test-results");
        const statusIcons = {
          pass: '<i class="fas fa-check-circle test-pass"></i>',
          fail: '<i class="fas fa-times-circle test-fail"></i>',
          warn: '<i class="fas fa-exclamation-triangle test-warn"></i>',
          info: '<i class="fas fa-info-circle test-info"></i>',
        };

        const statusClasses = {
          pass: "bg-green-50 border-green-200",
          fail: "bg-red-50 border-red-200",
          warn: "bg-yellow-50 border-yellow-200",
          info: "bg-blue-50 border-blue-200",
        };

        const div = document.createElement("div");
        div.className = `border-l-4 p-4 rounded ${
          statusClasses[result.status]
        }`;
        div.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="text-xl">${statusIcons[result.status]}</div>
            <div class="flex-1">
              <div class="font-semibold">[${result.category}] ${
          result.name
        }</div>
              <div class="text-sm text-gray-600 mt-1 whitespace-pre-wrap">${
                result.message
              }</div>
              ${
                result.details
                  ? `<pre class="mt-2 text-xs bg-white p-2 rounded overflow-auto max-h-40">${JSON.stringify(
                      result.details,
                      null,
                      2
                    )}</pre>`
                  : ""
              }
            </div>
          </div>
        `;
        container.appendChild(div);
      }

      // åˆå§‹åŒ–
      async function init() {
        const sessionId = localStorage.getItem("sessionId");
        const userStr = localStorage.getItem("user");

        if (!sessionId || !userStr) {
          addResult("åˆå§‹åŒ–", "ç™»å…¥ç‹€æ…‹", "fail", "æœªç™»å…¥");
          return false;
        }

        currentUser = JSON.parse(userStr);
        addResult(
          "åˆå§‹åŒ–",
          "ç™»å…¥ç‹€æ…‹",
          "pass",
          `å·²ç™»å…¥: ${currentUser.username}`
        );

        try {
          const response = await authenticatedFetch("/api/bills");
          const data = await response.json();
          testBills = data.bills || data;
          addResult(
            "åˆå§‹åŒ–",
            "è³¬å–®æ•¸æ“š",
            "pass",
            `æˆåŠŸç²å– ${testBills.length} å€‹è³¬å–®`
          );
          return true;
        } catch (error) {
          addResult("åˆå§‹åŒ–", "è³¬å–®æ•¸æ“š", "fail", error.message);
          return false;
        }
      }

      // æ¸¬è©¦ 1: ç²å–è³¬å–®ä¸¦åˆ†æ
      async function testBillAnalysis() {
        addResult("è³¬å–®åˆ†æ", "é–‹å§‹åˆ†æ", "info", "åˆ†æè³¬å–®çµæ§‹å’Œæ•¸æ“š...");

        let userPayerBills = [];
        let userParticipantBills = [];
        let pendingPayables = [];
        let paidPayables = [];
        let receivablesNeedConfirm = [];

        testBills.forEach((bill) => {
          const userParticipant = bill.participants.find(
            (p) => p.name === currentUser.username
          );
          if (!userParticipant) return;

          const isPayer = bill.payerId === userParticipant.id;
          const userResult = bill.results?.find(
            (r) => r.participantId === userParticipant.id
          );

          if (isPayer) {
            userPayerBills.push(bill);

            // æª¢æŸ¥æ‡‰æ”¶æ¬¾ä¸­æ˜¯å¦æœ‰å¾…ç¢ºèªçš„
            const otherResults = bill.results.filter(
              (r) => r.participantId !== userParticipant.id
            );
            otherResults.forEach((r) => {
              if (r.paymentStatus === "paid" && !r.confirmedByPayer) {
                receivablesNeedConfirm.push({
                  billId: bill.id,
                  billName: bill.name,
                  participantId: r.participantId,
                  amount: r.amount,
                });
              }
            });
          } else {
            userParticipantBills.push(bill);

            if (userResult) {
              if (userResult.paymentStatus === "pending") {
                pendingPayables.push({ bill, result: userResult });
              } else {
                paidPayables.push({ bill, result: userResult });
              }
            }
          }
        });

        addResult(
          "è³¬å–®åˆ†æ",
          "è§’è‰²åˆ†é¡",
          "pass",
          `ä»˜æ¬¾äººè³¬å–®: ${userPayerBills.length}, åƒèˆ‡è€…è³¬å–®: ${userParticipantBills.length}`
        );

        addResult(
          "è³¬å–®åˆ†æ",
          "æ‡‰ä»˜æ¬¾ç‹€æ…‹",
          "pass",
          `å¾…æ”¯ä»˜: ${pendingPayables.length}, å·²æ”¯ä»˜: ${paidPayables.length}`
        );

        addResult(
          "è³¬å–®åˆ†æ",
          "å¾…ç¢ºèªæ”¶æ¬¾",
          receivablesNeedConfirm.length > 0 ? "info" : "pass",
          `æœ‰ ${receivablesNeedConfirm.length} ç­†æ”¶æ¬¾å¾…ç¢ºèª`,
          receivablesNeedConfirm.length > 0 ? receivablesNeedConfirm : null
        );

        return {
          userPayerBills,
          userParticipantBills,
          pendingPayables,
          paidPayables,
          receivablesNeedConfirm,
        };
      }

      // æ¸¬è©¦ 2: å¯¦éš›æ¸¬è©¦æ”¯ä»˜ç‹€æ…‹æ›´æ–°
      async function testActualPaymentUpdate() {
        addResult("æ”¯ä»˜æ›´æ–°", "é–‹å§‹æ¸¬è©¦", "info", "æ¸¬è©¦å¯¦éš›æ›´æ–°æ”¯ä»˜ç‹€æ…‹API...");

        const analysis = await testBillAnalysis();

        if (analysis.pendingPayables.length === 0) {
          addResult("æ”¯ä»˜æ›´æ–°", "æ¸¬è©¦æ¡ˆä¾‹", "warn", "æ²’æœ‰å¾…æ”¯ä»˜çš„æ‡‰ä»˜æ¬¾å¯æ¸¬è©¦");
          return;
        }

        const testCase = analysis.pendingPayables[0];
        const bill = testCase.bill;
        const userParticipant = bill.participants.find(
          (p) => p.name === currentUser.username
        );

        addResult(
          "æ”¯ä»˜æ›´æ–°",
          "æ¸¬è©¦æ¡ˆä¾‹",
          "info",
          `é¸æ“‡è³¬å–®: ${bill.name || "(ç„¡åç¨±)"}, é‡‘é¡: $${
            testCase.result.amount
          }`,
          {
            billId: bill.id,
            participantId: userParticipant.id,
            currentStatus: "pending",
            testAction: "æ¨¡æ“¬æ¨™è¨˜ç‚ºå·²æ”¯ä»˜ï¼ˆä¸ä¸Šå‚³æ”¶æ“šï¼‰",
          }
        );

        try {
          // æ¸¬è©¦ APIï¼ˆä¿æŒåŸç‹€æ…‹ï¼Œä¸å¯¦éš›æ›´æ”¹ï¼‰
          const formData = new FormData();
          formData.append("billId", bill.id);
          formData.append("participantId", userParticipant.id);
          formData.append("paymentStatus", "pending"); // ä¿æŒä¸è®Š

          const response = await authenticatedFetch(
            "/api/bill/payment-status",
            {
              method: "POST",
              body: formData,
            }
          );

          if (response.ok) {
            addResult(
              "æ”¯ä»˜æ›´æ–°",
              "APIèª¿ç”¨",
              "pass",
              "æ”¯ä»˜ç‹€æ…‹æ›´æ–° API æ­£å¸¸å·¥ä½œ"
            );
            addResult(
              "æ”¯ä»˜æ›´æ–°",
              "é æœŸå½±éŸ¿",
              "info",
              "å¦‚æœå¯¦éš›æ›´æ–°ç‚º paidï¼Œé æœŸå½±éŸ¿ï¼š\n" +
                `- å¾…æ”¯ä»˜æ•¸é‡: -1\n` +
                `- å·²æ”¯ä»˜æ•¸é‡: +1\n` +
                `- æ‡‰ä»˜æ¬¾ç¸½é¡: -$${testCase.result.amount}\n` +
                `- è©²è³¬å–®å°‡ç§»å‡ºã€Œå¾…æ”¯ä»˜ã€åˆ—è¡¨`
            );
          } else {
            const error = await response.json();
            addResult(
              "æ”¯ä»˜æ›´æ–°",
              "APIèª¿ç”¨",
              "fail",
              `APIéŒ¯èª¤: ${response.status}`,
              error
            );
          }
        } catch (error) {
          addResult("æ”¯ä»˜æ›´æ–°", "APIèª¿ç”¨", "fail", error.message);
        }
      }

      // æ¸¬è©¦ 3: å¯¦éš›æ¸¬è©¦ç¢ºèªæ”¶æ¬¾
      async function testActualConfirmPayment() {
        addResult("ç¢ºèªæ”¶æ¬¾", "é–‹å§‹æ¸¬è©¦", "info", "æ¸¬è©¦å¯¦éš›ç¢ºèªæ”¶æ¬¾API...");

        const analysis = await testBillAnalysis();

        if (analysis.receivablesNeedConfirm.length === 0) {
          addResult("ç¢ºèªæ”¶æ¬¾", "æ¸¬è©¦æ¡ˆä¾‹", "warn", "æ²’æœ‰å¾…ç¢ºèªçš„æ”¶æ¬¾");
          return;
        }

        const testCase = analysis.receivablesNeedConfirm[0];

        addResult(
          "ç¢ºèªæ”¶æ¬¾",
          "æ¸¬è©¦æ¡ˆä¾‹",
          "info",
          `é¸æ“‡è³¬å–®: ${testCase.billName || "(ç„¡åç¨±)"}, é‡‘é¡: $${
            testCase.amount
          }`,
          testCase
        );

        try {
          // æ¸¬è©¦ APIï¼ˆå¯¦éš›åŸ·è¡Œç¢ºèªï¼‰
          const response = await authenticatedFetch(
            "/api/bill/confirm-payment",
            {
              method: "POST",
              body: JSON.stringify({
                billId: testCase.billId,
                participantId: testCase.participantId,
                confirmed: true,
              }),
            }
          );

          if (response.ok) {
            addResult(
              "ç¢ºèªæ”¶æ¬¾",
              "APIèª¿ç”¨",
              "pass",
              "ç¢ºèªæ”¶æ¬¾ API æ­£å¸¸å·¥ä½œï¼Œå·²å¯¦éš›åŸ·è¡Œç¢ºèª"
            );
            addResult(
              "ç¢ºèªæ”¶æ¬¾",
              "å¯¦éš›å½±éŸ¿",
              "info",
              "å·²åŸ·è¡Œç¢ºèªï¼Œå½±éŸ¿ï¼š\n" +
                `- è©²ç­†æ”¶æ¬¾æ¨™è¨˜ç‚ºã€Œå·²ç¢ºèªã€\n` +
                `- å¾…ç¢ºèªæ•¸é‡: -1\n` +
                `- è«‹åˆ·æ–°ã€Œæˆ‘çš„è³¬å–®ã€é é¢æŸ¥çœ‹è®ŠåŒ–`
            );
          } else {
            const error = await response.json();
            addResult(
              "ç¢ºèªæ”¶æ¬¾",
              "APIèª¿ç”¨",
              "fail",
              `APIéŒ¯èª¤: ${response.status}`,
              error
            );
          }
        } catch (error) {
          addResult("ç¢ºèªæ”¶æ¬¾", "APIèª¿ç”¨", "fail", error.message);
        }
      }

      // æ¸¬è©¦ 4: çµ±è¨ˆæ•¸æ“šé©—è­‰
      async function testStatisticsCalculation() {
        addResult("çµ±è¨ˆé©—è­‰", "é–‹å§‹è¨ˆç®—", "info", "é©—è­‰çµ±è¨ˆæ•¸æ“šè¨ˆç®—é‚è¼¯...");

        let pending = 0,
          paid = 0;
        let totalReceivables = 0,
          totalPayables = 0;
        let receivablesCount = 0,
          payablesCount = 0;

        testBills.forEach((bill) => {
          const userParticipant = bill.participants.find(
            (p) => p.name === currentUser.username
          );
          if (!userParticipant) return;

          const userResult = bill.results?.find(
            (r) => r.participantId === userParticipant.id
          );
          if (!userResult) return;

          const isPayer = bill.payerId === userParticipant.id;
          const totalAmount =
            bill.items?.reduce((sum, item) => sum + item.amount, 0) || 0;

          if (userResult.paymentStatus === "pending") pending++;
          else paid++;

          if (isPayer) {
            const receivables = totalAmount - userResult.amount;
            totalReceivables += receivables;
            receivablesCount += bill.participants.length - 1;
          } else {
            totalPayables += userResult.amount;
            payablesCount++;
          }
        });

        const stats = {
          totalBills: testBills.length,
          pending,
          paid,
          totalReceivables: totalReceivables.toFixed(2),
          totalPayables: totalPayables.toFixed(2),
          receivablesCount,
          payablesCount,
        };

        addResult("çµ±è¨ˆé©—è­‰", "è¨ˆç®—çµæœ", "pass", "çµ±è¨ˆæ•¸æ“šè¨ˆç®—å®Œæˆ", stats);

        addResult(
          "çµ±è¨ˆé©—è­‰",
          "å°æ¯”èªªæ˜",
          "info",
          "è«‹å°æ¯”ã€Œæˆ‘çš„è³¬å–®ã€é é¢é¡¯ç¤ºçš„çµ±è¨ˆæ•¸æ“šï¼š\n" +
            `- ç¸½è³¬å–®æ•¸æ‡‰ç‚º: ${stats.totalBills}\n` +
            `- å¾…æ”¯ä»˜æ‡‰ç‚º: ${stats.pending}\n` +
            `- å·²æ”¯ä»˜æ‡‰ç‚º: ${stats.paid}\n` +
            `- æ‡‰æ”¶æ¬¾æ‡‰ç‚º: $${stats.totalReceivables} (${stats.receivablesCount}ç­†)\n` +
            `- æ‡‰ä»˜æ¬¾æ‡‰ç‚º: $${stats.totalPayables} (${stats.payablesCount}ç­†)`
        );
      }

      // æ¸¬è©¦ 5: æ•¸æ“šå®Œæ•´æ€§
      async function testDataIntegrity() {
        addResult("æ•¸æ“šå®Œæ•´æ€§", "é–‹å§‹æª¢æŸ¥", "info", "æª¢æŸ¥è³¬å–®æ•¸æ“šå®Œæ•´æ€§...");

        let issues = [];

        testBills.forEach((bill) => {
          // æª¢æŸ¥åƒèˆ‡è€…å’ŒçµæœåŒ¹é…
          const participantIds = bill.participants.map((p) => p.id);
          const resultIds = bill.results?.map((r) => r.participantId) || [];

          const missing = participantIds.filter(
            (id) => !resultIds.includes(id)
          );
          const extra = resultIds.filter((id) => !participantIds.includes(id));

          if (missing.length > 0 || extra.length > 0) {
            issues.push({
              bill: bill.name || bill.id,
              type: "åƒèˆ‡è€…IDä¸åŒ¹é…",
              missing,
              extra,
            });
          }

          // æª¢æŸ¥ä»˜æ¬¾äºº
          if (bill.payerId && !participantIds.includes(bill.payerId)) {
            issues.push({
              bill: bill.name || bill.id,
              type: "ä»˜æ¬¾äººä¸åœ¨åƒèˆ‡è€…åˆ—è¡¨",
              payerId: bill.payerId,
            });
          }

          // æª¢æŸ¥å·²æ”¯ä»˜è¨˜éŒ„
          bill.results?.forEach((r) => {
            if (r.paymentStatus === "paid" && !r.paidAt) {
              issues.push({
                bill: bill.name || bill.id,
                type: "å·²æ”¯ä»˜è¨˜éŒ„ç¼ºå°‘æ™‚é–“",
                participantId: r.participantId,
              });
            }
          });
        });

        if (issues.length === 0) {
          addResult("æ•¸æ“šå®Œæ•´æ€§", "å®Œæ•´æ€§æª¢æŸ¥", "pass", "æ‰€æœ‰æ•¸æ“šå®Œæ•´ä¸”ä¸€è‡´");
        } else {
          addResult(
            "æ•¸æ“šå®Œæ•´æ€§",
            "å®Œæ•´æ€§æª¢æŸ¥",
            "fail",
            `ç™¼ç¾ ${issues.length} å€‹å•é¡Œ`,
            issues
          );
        }
      }

      // é‹è¡Œæ‰€æœ‰æ¸¬è©¦
      async function runAllTests() {
        clearResults();
        addResult(
          "ç³»çµ±",
          "æ¸¬è©¦é–‹å§‹",
          "info",
          new Date().toLocaleString("zh-TW")
        );

        const ok = await init();
        if (!ok) return;

        await testBillAnalysis();
        await testStatisticsCalculation();
        await testDataIntegrity();

        const passRate = ((stats.pass / stats.total) * 100).toFixed(1);
        addResult(
          "ç³»çµ±",
          "æ¸¬è©¦å®Œæˆ",
          "info",
          `å®Œæˆæ™‚é–“: ${new Date().toLocaleString(
            "zh-TW"
          )}\né€šéç‡: ${passRate}%`
        );
      }

      // å°å‡º
      function generateMarkdown() {
        let md = `# æˆ‘çš„è³¬å–®é é¢å®Œæ•´æ¸¬è©¦çµæœ V2ï¼ˆç¬¬äºŒéšæ®µï¼‰\n\n`;
        md += `**æ¸¬è©¦æ™‚é–“**: ${new Date().toLocaleString("zh-TW")}\n`;
        md += `**æ¸¬è©¦ç”¨æˆ¶**: ${currentUser?.username || "N/A"}\n\n`;

        md += `## ğŸ“Š æ¸¬è©¦çµ±è¨ˆ\n\n`;
        md += `- ç¸½è¨ˆ: ${stats.total} é …\n`;
        md += `- é€šé: ${stats.pass} é … âœ…\n`;
        md += `- å¤±æ•—: ${stats.fail} é … âŒ\n`;
        md += `- è­¦å‘Š: ${stats.warn} é … âš ï¸\n`;
        md += `- ä¿¡æ¯: ${stats.info} é … â„¹ï¸\n\n`;
        md += `**é€šéç‡**: ${((stats.pass / stats.total) * 100).toFixed(
          1
        )}%\n\n`;

        md += `## ğŸ“‹ è©³ç´°æ¸¬è©¦çµæœ\n\n`;

        const categories = [...new Set(testResults.map((r) => r.category))];
        categories.forEach((category) => {
          md += `### ${category}\n\n`;
          testResults
            .filter((r) => r.category === category)
            .forEach((result) => {
              const icon = { pass: "âœ…", fail: "âŒ", warn: "âš ï¸", info: "â„¹ï¸" }[
                result.status
              ];
              md += `**${icon} ${result.name}**\n${result.message}\n`;
              if (result.details)
                md += `\n\`\`\`json\n${JSON.stringify(
                  result.details,
                  null,
                  2
                )}\n\`\`\`\n`;
              md += `\n`;
            });
        });

        md += `---\n*PBCèšè³¬é€š æ¸¬è©¦ç³»çµ±è‡ªå‹•ç”Ÿæˆ*\n`;
        return md;
      }

      function exportResults() {
        const md = generateMarkdown();
        const blob = new Blob([md], { type: "text/markdown" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `æˆ‘çš„è³¬å–®æ¸¬è©¦V2_${
          new Date().toISOString().split("T")[0]
        }.md`;
        a.click();
        URL.revokeObjectURL(url);
        navigator.clipboard.writeText(md).then(() => alert("å·²ä¸‹è¼‰ä¸¦è¤‡è£½ï¼"));
      }

      function clearResults() {
        document.getElementById("test-results").innerHTML = "";
        testResults = [];
        stats = { pass: 0, fail: 0, warn: 0, info: 0, total: 0 };
        updateStats();
      }

      // äº‹ä»¶
      document
        .getElementById("run-all-tests")
        .addEventListener("click", runAllTests);
      document
        .getElementById("test-payment-update")
        .addEventListener("click", async () => {
          clearResults();
          await init();
          await testActualPaymentUpdate();
        });
      document
        .getElementById("test-confirm-payment")
        .addEventListener("click", async () => {
          clearResults();
          await init();
          await testActualConfirmPayment();
        });
      document
        .getElementById("export-results")
        .addEventListener("click", exportResults);

      // é é¢åŠ è¼‰
      window.addEventListener("DOMContentLoaded", () => {
        const userStr = localStorage.getItem("user");
        if (!userStr) {
          alert("è«‹å…ˆç™»å…¥ï¼");
          window.location.href = "/login-page.html";
        }
      });
    </script>
  </body>
</html>
