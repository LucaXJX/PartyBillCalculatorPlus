<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>我的消息 - PBC聚賬通</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4F46E5",
              secondary: "#EC4899",
              accent: "#F59E0B",
              light: "#F3F4F6",
              dark: "#1F2937",
            },
          },
        },
      };
    </script>
    <style type="text/tailwindcss">
      @layer utilities {
        .btn-primary {
          @apply bg-primary text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg hover:bg-primary/90 transition-all duration-300;
        }
        .btn-secondary {
          @apply bg-white text-primary border-2 border-primary font-semibold py-2 px-4 rounded-lg shadow-sm hover:shadow-md hover:bg-primary/5 transition-all duration-300;
        }
        .btn-danger {
          @apply bg-red-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg hover:bg-red-600 transition-all duration-300;
        }
        .btn-success {
          @apply bg-green-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg hover:bg-green-600 transition-all duration-300;
        }
      }
    </style>
  </head>
  <body
    class="font-sans text-dark bg-gray-50"
    style="background-color: #f9fafb"
  >
    <!-- Header 將由組件系統插入 -->

    <!-- 主要內容 -->
    <main class="pt-24 pb-20 min-h-[calc(100vh-200px)]">
      <section class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="max-w-6xl mx-auto">
          <!-- 頁面標題 -->
          <div class="mb-8">
            <div class="flex items-center justify-between">
              <div>
                <h1 class="text-3xl font-bold text-dark flex items-center">
                  <i class="fa fa-envelope text-primary mr-3"></i>我的消息
                </h1>
                <p class="text-gray-600 mt-2">查看系統通知和賬單相關消息</p>
              </div>
              <button
                id="mark-all-read-btn"
                class="btn-secondary text-sm"
                style="display: none"
              >
                <i class="fa fa-check-double mr-1"></i>全部已讀
              </button>
            </div>
          </div>

          <!-- 消息統計卡片 -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div
              class="bg-white rounded-lg shadow-md p-4 border-l-4 border-blue-500"
            >
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-xs text-gray-600 mb-1">全部消息</div>
                  <div
                    class="text-2xl font-bold text-gray-800"
                    id="total-count"
                  >
                    0
                  </div>
                </div>
                <i class="fa fa-envelope text-blue-500 text-2xl opacity-20"></i>
              </div>
            </div>

            <div
              class="bg-white rounded-lg shadow-md p-4 border-l-4 border-orange-500"
            >
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-xs text-gray-600 mb-1">未讀消息</div>
                  <div
                    class="text-2xl font-bold text-orange-600"
                    id="unread-count"
                  >
                    0
                  </div>
                </div>
                <i
                  class="fa fa-envelope-open text-orange-500 text-2xl opacity-20"
                ></i>
              </div>
            </div>

            <div
              class="bg-white rounded-lg shadow-md p-4 border-l-4 border-green-500"
            >
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-xs text-gray-600 mb-1">支付通知</div>
                  <div
                    class="text-2xl font-bold text-green-600"
                    id="payment-count"
                  >
                    0
                  </div>
                </div>
                <i
                  class="fa fa-money-bill-wave text-green-500 text-2xl opacity-20"
                ></i>
              </div>
            </div>

            <div
              class="bg-white rounded-lg shadow-md p-4 border-l-4 border-purple-500"
            >
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-xs text-gray-600 mb-1">待處理</div>
                  <div
                    class="text-2xl font-bold text-purple-600"
                    id="actionable-count"
                  >
                    0
                  </div>
                </div>
                <i class="fa fa-tasks text-purple-500 text-2xl opacity-20"></i>
              </div>
            </div>
          </div>

          <!-- 消息列表 -->
          <div class="bg-white rounded-lg shadow-md">
            <!-- 加載狀態 -->
            <div id="loading-state" class="p-8 text-center">
              <i class="fa fa-spinner fa-spin text-4xl text-primary mb-4"></i>
              <p class="text-gray-600">加載消息中...</p>
            </div>

            <!-- 空狀態 -->
            <div
              id="empty-state"
              class="p-12 text-center"
              style="display: none"
            >
              <i class="fa fa-inbox text-6xl text-gray-300 mb-4"></i>
              <p class="text-gray-500 text-lg">暫無消息</p>
              <p class="text-gray-400 text-sm mt-2">
                當有新的賬單或付款時，您會在這裡收到通知
              </p>
            </div>

            <!-- 消息列表容器 -->
            <div id="messages-container" style="display: none">
              <!-- 消息將動態插入這裡 -->
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer 將由組件系統插入 -->

    <!-- 認證管理器 -->
    <script src="/js/auth.js"></script>
    <!-- 組件管理器 -->
    <script src="/js/components.js"></script>

    <!-- 消息頁面邏輯 -->
    <script type="module">
      import { PageSetup } from "/js/page-setup-module.js";

      let allMessages = [];

      // 使用全局的 authenticatedFetch
      const authFetch = window.authManager.authenticatedFetch.bind(
        window.authManager
      );

      // 初始化頁面
      (async () => {
        const pageSetup = new PageSetup();
        await pageSetup.init({
          requireAuth: true,
          currentPage: "messages",
          redirectIfNotAuth: "/login-page.html",
        });

        // 加載消息
        await loadMessages();

        // 設置全部已讀按鈕
        document
          .getElementById("mark-all-read-btn")
          .addEventListener("click", markAllAsRead);
      })();

      /**
       * 加載消息
       */
      async function loadMessages() {
        try {
          const response = await authFetch("/api/messages");
          const data = await response.json();

          allMessages = data.messages || [];

          // 更新統計
          updateStatistics();

          // 顯示消息
          displayMessages();
        } catch (error) {
          console.error("加載消息失敗:", error);
          document.getElementById("loading-state").innerHTML = `
            <i class="fa fa-exclamation-circle text-4xl text-red-500 mb-4"></i>
            <p class="text-red-600">加載消息失敗</p>
            <button onclick="location.reload()" class="btn-primary mt-4">
              <i class="fa fa-sync mr-1"></i>重試
            </button>
          `;
        }
      }

      /**
       * 更新統計數據
       */
      function updateStatistics() {
        const totalCount = allMessages.length;
        const unreadCount = allMessages.filter((m) => !m.isRead).length;
        const paymentCount = allMessages.filter(
          (m) =>
            m.type === "payment_submitted" ||
            m.type === "payment_confirmed" ||
            m.type === "payment_rejected"
        ).length;
        const actionableCount = allMessages.filter(
          (m) => m.actionable && !m.actionCompleted
        ).length;

        document.getElementById("total-count").textContent = totalCount;
        document.getElementById("unread-count").textContent = unreadCount;
        document.getElementById("payment-count").textContent = paymentCount;
        document.getElementById("actionable-count").textContent =
          actionableCount;

        // 顯示/隱藏全部已讀按鈕
        if (unreadCount > 0) {
          document.getElementById("mark-all-read-btn").style.display = "block";
        } else {
          document.getElementById("mark-all-read-btn").style.display = "none";
        }
      }

      /**
       * 顯示消息列表
       */
      function displayMessages() {
        document.getElementById("loading-state").style.display = "none";

        if (allMessages.length === 0) {
          document.getElementById("empty-state").style.display = "block";
          return;
        }

        document.getElementById("empty-state").style.display = "none";
        document.getElementById("messages-container").style.display = "block";

        const container = document.getElementById("messages-container");
        container.innerHTML = allMessages
          .map((message) => createMessageCard(message))
          .join("");

        // 綁定事件
        attachMessageEvents();
      }

      /**
       * 創建消息卡片
       */
      function createMessageCard(message) {
        const isUnread = !message.isRead;
        const messageTypeInfo = getMessageTypeInfo(message.type);
        const timeAgo = getTimeAgo(message.createdAt);
        const hasActions =
          message.actionable &&
          !message.actionCompleted &&
          message.type === "payment_submitted";

        return `
          <div
            class="border-b last:border-b-0 p-4 hover:bg-gray-50 transition-colors ${
              isUnread ? "bg-blue-50" : ""
            }"
            data-message-id="${message.id}"
          >
            <div class="flex items-start gap-4">
              <!-- 消息圖標 -->
              <div class="flex-shrink-0">
                <div
                  class="w-12 h-12 rounded-full ${
                    messageTypeInfo.bgColor
                  } flex items-center justify-center"
                >
                  <i class="${messageTypeInfo.icon} ${
          messageTypeInfo.iconColor
        } text-xl"></i>
                </div>
              </div>

              <!-- 消息內容 -->
              <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                      <h3 class="font-semibold text-gray-900">${
                        message.title
                      }</h3>
                      ${
                        isUnread
                          ? '<span class="px-2 py-0.5 bg-orange-500 text-white text-xs rounded-full">未讀</span>'
                          : ""
                      }
                    </div>
                    <p class="text-gray-600 text-sm mb-2">${message.content}</p>
                    <div class="flex items-center gap-4 text-xs text-gray-500">
                      <span><i class="fa fa-clock mr-1"></i>${timeAgo}</span>
                      <span><i class="fa fa-file-invoice mr-1"></i>${
                        message.billName
                      }</span>
                    </div>
                  </div>

                  <!-- 時間和操作 -->
                  <div class="flex items-center gap-2">
                    ${
                      isUnread
                        ? `<button
                        onclick="markAsRead('${message.id}')"
                        class="text-xs text-blue-600 hover:text-blue-800"
                        title="標記已讀"
                      >
                        <i class="fa fa-check"></i>
                      </button>`
                        : ""
                    }
                    <button
                      onclick="deleteMessage('${message.id}')"
                      class="text-xs text-red-600 hover:text-red-800"
                      title="刪除"
                    >
                      <i class="fa fa-trash"></i>
                    </button>
                  </div>
                </div>

                <!-- 圖片（如果有） -->
                ${
                  message.imageUrl
                    ? `
                <div class="mt-3">
                  <button
                    onclick="viewMessageReceipt('${message.imageUrl}')"
                    class="px-3 py-1.5 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-sm"
                  >
                    <i class="fa fa-image mr-1"></i>查看憑證
                  </button>
                </div>
                `
                    : ""
                }

                <!-- 操作按鈕 -->
                ${
                  hasActions
                    ? `
                <div class="mt-3 flex gap-2">
                  <button
                    onclick="confirmPaymentFromMessage('${message.id}', '${message.billId}', '${message.metadata?.participantId}')"
                    class="btn-success text-sm"
                  >
                    <i class="fa fa-check mr-1"></i>確認收款
                  </button>
                  <button
                    onclick="rejectPaymentFromMessage('${message.id}', '${message.billId}', '${message.metadata?.participantId}')"
                    class="btn-danger text-sm"
                  >
                    <i class="fa fa-times mr-1"></i>拒絕收款
                  </button>
                </div>
                `
                    : ""
                }
              </div>
            </div>
          </div>
        `;
      }

      /**
       * 獲取消息類型信息
       */
      function getMessageTypeInfo(type) {
        const types = {
          new_bill: {
            icon: "fa fa-file-invoice",
            iconColor: "text-blue-600",
            bgColor: "bg-blue-100",
          },
          payment_submitted: {
            icon: "fa fa-money-bill-wave",
            iconColor: "text-green-600",
            bgColor: "bg-green-100",
          },
          payment_confirmed: {
            icon: "fa fa-check-circle",
            iconColor: "text-green-600",
            bgColor: "bg-green-100",
          },
          payment_rejected: {
            icon: "fa fa-times-circle",
            iconColor: "text-red-600",
            bgColor: "bg-red-100",
          },
          overdue_reminder: {
            icon: "fa fa-exclamation-triangle",
            iconColor: "text-orange-600",
            bgColor: "bg-orange-100",
          },
        };

        return (
          types[type] || {
            icon: "fa fa-bell",
            iconColor: "text-gray-600",
            bgColor: "bg-gray-100",
          }
        );
      }

      /**
       * 獲取相對時間
       */
      function getTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) return `${days} 天前`;
        if (hours > 0) return `${hours} 小時前`;
        if (minutes > 0) return `${minutes} 分鐘前`;
        return "剛剛";
      }

      /**
       * 綁定消息事件
       */
      function attachMessageEvents() {
        // 點擊消息卡片標記已讀（如果未讀）
        document.querySelectorAll("[data-message-id]").forEach((card) => {
          card.addEventListener("click", async (e) => {
            // 如果點擊的是按鈕，不處理
            if (e.target.tagName === "BUTTON" || e.target.closest("button")) {
              return;
            }

            const messageId = card.dataset.messageId;
            const message = allMessages.find((m) => m.id === messageId);

            if (message && !message.isRead) {
              await markAsRead(messageId);
            }
          });
        });
      }

      /**
       * 標記消息為已讀
       */
      window.markAsRead = async function (messageId) {
        try {
          await authFetch("/api/messages/mark-read", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ messageId }),
          });

          // 更新本地數據
          const message = allMessages.find((m) => m.id === messageId);
          if (message) {
            message.isRead = true;
          }

          // 重新渲染
          updateStatistics();
          displayMessages();
        } catch (error) {
          console.error("標記已讀失敗:", error);
          alert("標記已讀失敗，請重試");
        }
      };

      /**
       * 全部標記為已讀
       */
      async function markAllAsRead() {
        if (!confirm("確定要將所有消息標記為已讀嗎？")) return;

        try {
          await authFetch("/api/messages/mark-all-read", {
            method: "POST",
          });

          // 更新本地數據
          allMessages.forEach((m) => (m.isRead = true));

          // 重新渲染
          updateStatistics();
          displayMessages();
        } catch (error) {
          console.error("全部標記已讀失敗:", error);
          alert("操作失敗，請重試");
        }
      }

      /**
       * 刪除消息
       */
      window.deleteMessage = async function (messageId) {
        if (!confirm("確定要刪除這條消息嗎？")) return;

        try {
          await authFetch(`/api/messages/${messageId}`, {
            method: "DELETE",
          });

          // 從本地數據中移除
          allMessages = allMessages.filter((m) => m.id !== messageId);

          // 重新渲染
          updateStatistics();
          displayMessages();
        } catch (error) {
          console.error("刪除消息失敗:", error);
          alert("刪除失敗，請重試");
        }
      };

      /**
       * 查看消息中的收據
       */
      window.viewMessageReceipt = async function (receiptUrl) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black bg-opacity-75 flex items-start justify-center z-50 overflow-y-auto p-4";
        modal.innerHTML = `
          <div class="max-w-4xl w-full my-4">
            <div class="bg-white rounded-lg p-4">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">付款憑證</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                  <i class="fa fa-times text-xl"></i>
                </button>
              </div>
              <div class="flex justify-center items-center min-h-[200px]">
                <i class="fa fa-spinner fa-spin text-4xl text-primary"></i>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);

        modal.addEventListener("click", (e) => {
          if (e.target === modal) modal.remove();
        });

        try {
          const sessionId = localStorage.getItem("sessionId");
          const response = await fetch(receiptUrl, {
            headers: { "X-Session-ID": sessionId },
          });

          if (!response.ok) throw new Error("無法加載收據圖片");

          const blob = await response.blob();
          const imageUrl = URL.createObjectURL(blob);

          const contentDiv = modal.querySelector(".min-h-\\[200px\\]");
          if (contentDiv) {
            contentDiv.innerHTML = `<img src="${imageUrl}" class="max-w-full h-auto rounded-lg" />`;
          }
        } catch (error) {
          console.error("加載收據失敗:", error);
          const contentDiv = modal.querySelector(".min-h-\\[200px\\]");
          if (contentDiv) {
            contentDiv.innerHTML = `
              <div class="text-center text-red-600">
                <i class="fa fa-exclamation-circle text-4xl mb-2"></i>
                <p>無法加載收據圖片</p>
              </div>
            `;
          }
        }
      };

      /**
       * 從消息確認收款
       */
      window.confirmPaymentFromMessage = async function (
        messageId,
        billId,
        participantId
      ) {
        if (!confirm("確定要確認收到這筆款項嗎？")) return;

        try {
          await authFetch("/api/messages/confirm-payment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ messageId, billId, participantId }),
          });

          alert("收款已確認！");
          await loadMessages(); // 重新加載消息
        } catch (error) {
          console.error("確認收款失敗:", error);
          alert("確認收款失敗，請重試");
        }
      };

      /**
       * 從消息拒絕收款
       */
      window.rejectPaymentFromMessage = async function (
        messageId,
        billId,
        participantId
      ) {
        const reason = await showRejectReasonDialog();
        if (!reason) return;

        try {
          await authFetch("/api/messages/reject-payment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ messageId, billId, participantId, reason }),
          });

          alert("已拒絕收款並通知對方");
          await loadMessages(); // 重新加載消息
        } catch (error) {
          console.error("拒絕收款失敗:", error);
          alert("拒絕收款失敗，請重試");
        }
      };

      /**
       * 顯示拒絕原因對話框
       */
      function showRejectReasonDialog() {
        return new Promise((resolve) => {
          const modal = document.createElement("div");
          modal.className =
            "fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto p-4";
          modal.innerHTML = `
            <div class="bg-white rounded-lg max-w-md w-full my-4">
              <div class="p-6">
                <h3 class="text-lg font-bold mb-4">選擇拒絕原因</h3>
                <div class="space-y-3 mb-6">
                  <button
                    onclick="window.__rejectReason='not_received'"
                    class="w-full p-4 border-2 border-gray-300 rounded-lg hover:border-red-500 hover:bg-red-50 transition-colors text-left"
                  >
                    <div class="font-semibold">未收到款項</div>
                    <div class="text-sm text-gray-600">未在賬戶中看到該筆款項</div>
                  </button>
                  <button
                    onclick="window.__rejectReason='wrong_receipt'"
                    class="w-full p-4 border-2 border-gray-300 rounded-lg hover:border-red-500 hover:bg-red-50 transition-colors text-left"
                  >
                    <div class="font-semibold">錯誤單據</div>
                    <div class="text-sm text-gray-600">提交的付款憑證有誤</div>
                  </button>
                </div>
                <button
                  onclick="window.__rejectReason=null;this.closest('.fixed').remove()"
                  class="w-full btn-secondary"
                >
                  取消
                </button>
              </div>
            </div>
          `;

          document.body.appendChild(modal);

          // 監聽選擇
          modal.addEventListener("click", (e) => {
            if (e.target.closest("button") && window.__rejectReason) {
              const reason = window.__rejectReason;
              window.__rejectReason = null;
              modal.remove();
              resolve(reason);
            }
          });

          // 點擊外部關閉
          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              window.__rejectReason = null;
              modal.remove();
              resolve(null);
            }
          });
        });
      }
    </script>
  </body>
</html>
