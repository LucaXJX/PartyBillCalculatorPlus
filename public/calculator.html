<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/img/icon32x32.png" sizes="16x16" />
    <title>智能計算 - PBC聚賬通</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
      :root {
        --primary: #4f46e5;
        --primary-light: #e0e7ff;
        --dark: #1f2937;
        --light: #f8fafc;
      }

      .text-primary {
        color: var(--primary);
      }

      .bg-primary {
        background-color: var(--primary);
      }

      .bg-light {
        background-color: var(--light);
      }

      .text-dark {
        color: var(--dark);
      }

      .input-focus:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
      }

      .btn-primary:hover {
        background-color: #3730a3;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      }

      .btn-secondary {
        background-color: #f3f4f6;
        color: var(--dark);
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        border: 1px solid #d1d5db;
        cursor: pointer;
      }

      .btn-secondary:hover {
        background-color: #e5e7eb;
        transform: translateY(-1px);
      }
    </style>
  </head>
  <body
    class="font-sans text-dark bg-gray-50 min-h-screen"
    style="background-color: #f9fafb"
  >
    <!-- Header 將由 JavaScript 動態插入 -->

    <!-- 主要內容 -->
    <main class="pt-24 pb-20">
      <section class="container mx-auto px-4 sm:px-6 lg:px-8">
        <!-- 頁面標題 -->
        <div class="text-center mb-12">
          <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold mb-4 text-dark">
            智能賬單<span class="text-primary">計算</span>
          </h1>
          <p class="text-gray-600 max-w-2xl mx-auto text-lg">
            簡單輸入，公平分攤，輕鬆搞定每一筆聚會賬單
          </p>
        </div>

        <div class="max-w-5xl mx-auto">
          <!-- 步驟導航 -->
          <div class="flex flex-wrap justify-center mb-10">
            <div class="flex items-center">
              <div
                class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold shadow-md shadow-primary/20"
              >
                1
              </div>
              <div class="h-1 w-16 bg-primary mx-2"></div>
              <span class="text-primary font-medium">基本信息</span>
            </div>
            <div class="flex items-center ml-8">
              <div
                class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold shadow-md shadow-primary/20"
              >
                2
              </div>
              <div class="h-1 w-16 bg-primary mx-2"></div>
              <span class="text-primary font-medium">添加項目</span>
            </div>
            <div class="flex items-center ml-8">
              <div
                class="w-10 h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold"
              >
                3
              </div>
              <div class="h-1 w-16 bg-gray-200 mx-2"></div>
              <span class="text-gray-500">計算結果</span>
            </div>
          </div>

          <!-- 計算卡片 -->
          <div
            class="bg-white rounded-2xl shadow-xl overflow-hidden transform transition-all duration-500 hover:shadow-2xl"
          >
            <!-- 卡片頭部 -->
            <div
              class="bg-gradient-to-r from-primary to-primary/80 p-6 text-white"
            >
              <h2 class="text-2xl font-bold mb-2">創建新賬單</h2>
              <p class="text-white/90">
                輸入聚會信息和消費項目，我們將為您自動計算
              </p>
            </div>

            <!-- 卡片內容 -->
            <div class="p-6 md:p-8">
              <!-- 基本信息表單 -->
              <div class="mb-10">
                <h3 class="text-xl font-semibold mb-6 flex items-center">
                  <i class="fa fa-info-circle text-primary mr-3"></i>基本信息
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label
                      for="bill-name"
                      class="block text-gray-700 font-medium mb-2"
                      >聚會名稱</label
                    >
                    <input
                      type="text"
                      id="bill-name"
                      placeholder="例如：週末聚餐、公司下午茶"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus transition-all duration-300"
                    />
                  </div>
                  <div>
                    <label
                      for="bill-date"
                      class="block text-gray-700 font-medium mb-2"
                      >日期</label
                    >
                    <input
                      type="date"
                      id="bill-date"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus transition-all duration-300"
                    />
                  </div>
                  <div>
                    <label
                      for="bill-location"
                      class="block text-gray-700 font-medium mb-2"
                      >地點</label
                    >
                    <input
                      type="text"
                      id="bill-location"
                      placeholder="例如：麥當勞、鼎泰豐"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus transition-all duration-300"
                    />
                  </div>
                  <div>
                    <label
                      for="bill-tip"
                      class="block text-gray-700 font-medium mb-2"
                      >小費比例 (%)</label
                    >
                    <input
                      type="number"
                      id="bill-tip"
                      placeholder="0"
                      min="0"
                      max="100"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus transition-all duration-300"
                    />
                  </div>
                  <div class="md:col-span-2">
                    <label
                      for="bill-payer"
                      class="block text-gray-700 font-medium mb-2"
                      >付款人</label
                    >
                    <select
                      id="bill-payer"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus transition-all duration-300"
                    >
                      <option value="">請選擇付款人（可稍後選擇）</option>
                    </select>
                    <p class="text-sm text-gray-500 mt-1">
                      選擇誰先付錢，其他人需要向此人支付相應金額
                    </p>
                  </div>
                </div>
              </div>

              <!-- 參與者 -->
              <div class="mb-10">
                <div class="flex justify-between items-center mb-6">
                  <h3 class="text-xl font-semibold flex items-center">
                    <i class="fa fa-users text-primary mr-3"></i>參與者
                  </h3>
                  <button
                    id="add-person-btn"
                    class="flex items-center text-primary hover:text-primary/80 transition-colors"
                  >
                    <i class="fa fa-plus-circle mr-1"></i> 添加參與者
                  </button>
                </div>

                <div id="participants-container" class="space-y-4">
                  <!-- 初始參與者將通過JavaScript動態創建 -->
                </div>
              </div>

              <!-- 消費項目 -->
              <div class="mb-10">
                <div class="flex justify-between items-center mb-6">
                  <h3 class="text-xl font-semibold flex items-center">
                    <i class="fa fa-shopping-basket text-primary mr-3"></i
                    >消費項目
                  </h3>
                  <button
                    id="add-item-btn"
                    class="flex items-center text-primary hover:text-primary/80 transition-colors"
                  >
                    <i class="fa fa-plus-circle mr-1"></i> 添加項目
                  </button>
                </div>

                <div id="items-container" class="space-y-6">
                  <!-- 初始为空，通过JS添加 -->
                </div>
              </div>

              <!-- 操作按鈕 -->
              <div
                class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 pt-6 border-t border-gray-200"
              >
                <!-- 保存草稿按鈕已暫時移除
                <button
                  id="save-draft-btn"
                  class="btn-secondary w-full sm:w-auto"
                >
                  <i class="fa fa-save mr-2"></i> 保存草稿
                </button>
                -->
                <button id="calculate-btn" class="btn-primary w-full sm:w-auto">
                  <i class="fa fa-calculator mr-2"></i> 開始計算
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer 將由 JavaScript 動態插入 -->

    <!-- 用戶搜尋模態框 -->
    <div
      id="user-search-modal"
      class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 transition-all duration-300 opacity-0 invisible"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all duration-300 scale-95"
      >
        <div
          class="bg-gradient-to-r from-primary to-primary/80 p-6 text-white flex justify-between items-center"
        >
          <h3 class="text-xl font-bold">搜尋用戶</h3>
          <button
            id="close-user-search-btn"
            class="text-white hover:text-white/80 transition-colors"
          >
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        <div class="p-6">
          <div class="mb-4">
            <input
              type="text"
              id="user-search-input"
              placeholder="輸入用戶名或郵箱..."
              class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus transition-all duration-300"
            />
          </div>
          <div class="mb-4">
            <button
              id="add-self-btn"
              class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/80 transition-colors"
            >
              <i class="fa fa-user-plus mr-2"></i>加入自己
            </button>
          </div>
          <div id="user-search-results" class="max-h-60 overflow-y-auto">
            <!-- 搜尋結果將在這裡顯示 -->
          </div>
        </div>
      </div>
    </div>

    <!-- 計算結果模態框 -->
    <div
      id="result-modal"
      class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto transform scale-95 transition-all duration-300"
      >
        <div
          class="bg-gradient-to-r from-primary to-primary/80 p-6 text-white flex justify-between items-center sticky top-0"
        >
          <h3 class="text-2xl font-bold">計算結果</h3>
          <button
            id="close-modal-btn"
            class="text-white hover:text-white/80 transition-colors"
          >
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        <div class="p-6">
          <div class="mb-8">
            <h4 class="text-xl font-semibold mb-4">聚會信息</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
              <div class="flex items-center">
                <i class="fa fa-tag text-primary mr-3 w-5 text-center"></i>
                <span id="result-bill-name">週末聚餐</span>
              </div>
              <div class="flex items-center">
                <i class="fa fa-calendar text-primary mr-3 w-5 text-center"></i>
                <span id="result-bill-date">2024年5月25日</span>
              </div>
              <div class="flex items-center">
                <i
                  class="fa fa-map-marker text-primary mr-3 w-5 text-center"
                ></i>
                <span id="result-bill-location">麥當勞</span>
              </div>
              <div class="flex items-center">
                <i class="fa fa-users text-primary mr-3 w-5 text-center"></i>
                <span id="result-bill-participants">2位參與者</span>
              </div>
              <div class="flex items-center">
                <i
                  class="fa fa-credit-card text-primary mr-3 w-5 text-center"
                ></i>
                <span id="result-bill-payer">未指定付款人</span>
              </div>
            </div>
          </div>

          <div class="mb-8">
            <h4 class="text-xl font-semibold mb-4">費用明細</h4>
            <div class="overflow-x-auto">
              <table class="w-full border-collapse">
                <thead>
                  <tr class="bg-light">
                    <th
                      class="py-3 px-4 text-left text-gray-700 font-semibold border-b"
                    >
                      項目
                    </th>
                    <th
                      class="py-3 px-4 text-right text-gray-700 font-semibold border-b"
                    >
                      金額 (HKD)
                    </th>
                  </tr>
                </thead>
                <tbody id="result-items-table" class="text-gray-600">
                  <!-- 结果将通过JS填充 -->
                </tbody>
              </table>
            </div>
          </div>

          <div class="mb-8">
            <h4 class="text-xl font-semibold mb-4">分攤結果</h4>
            <div id="result-participants-container" class="space-y-4">
              <!-- 结果将通过JS填充 -->
            </div>
          </div>

          <div
            class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 pt-6 border-t border-gray-200"
          >
            <button
              class="btn-secondary w-full sm:w-auto"
              id="print-to-jpg-btn"
            >
              <i class="fa fa-print mr-2"></i> 列印報告
            </button>
            <div class="flex space-x-4 w-full sm:w-auto">
              <button
                class="btn-secondary w-full sm:w-auto"
                onclick="alert('上傳功能即將推出')"
              >
                <i class="fa fa-upload mr-2"></i> 上傳賬單
              </button>
              <button id="save-result-btn" class="btn-primary w-full sm:w-auto">
                <i class="fa fa-save mr-2"></i> 保存賬單
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 引入必要的腳本 -->
    <script src="/js/auth.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/page-setup.js"></script>

    <script type="module">
      // 頁面初始化
      document.addEventListener("DOMContentLoaded", async () => {
        // 設置頁面組件
        const pageInitialized = await window.pageSetup.init({
          currentPage: "calculator",
          requireAuth: true,
          showHeader: true,
          showFooter: true,
        });

        if (!pageInitialized) {
          return; // 認證失敗，頁面會重定向
        }

        // 設置頁面特定功能
        window.pageSetup.setupPageFeatures({
          updateUserDisplay: true,
          setupLogout: true,
          setupAuthCheck: true,
        });

        // 使用全局認證管理器
        const authManager = window.authManager;
        let currentUser = authManager.getCurrentUser();
        let sessionId = authManager.getSessionId();

        // 使用認證管理器的fetch方法
        const authenticatedFetch =
          authManager.authenticatedFetch.bind(authManager);

        // DOM元素
        const billNameInput = document.getElementById("bill-name");
        const billDateInput = document.getElementById("bill-date");
        const billLocationInput = document.getElementById("bill-location");
        const billTipInput = document.getElementById("bill-tip");
        const billPayerSelect = document.getElementById("bill-payer");
        const participantsContainer = document.getElementById(
          "participants-container"
        );
        const itemsContainer = document.getElementById("items-container");
        const addPersonBtn = document.getElementById("add-person-btn");
        const addItemBtn = document.getElementById("add-item-btn");
        const calculateBtn = document.getElementById("calculate-btn");
        // const saveDraftBtn = document.getElementById("save-draft-btn"); // 已暫時移除
        const resultModal = document.getElementById("result-modal");
        const closeModalBtn = document.getElementById("close-modal-btn");
        const saveResultBtn = document.getElementById("save-result-btn");

        // 初始化日期為今天
        billDateInput.value = new Date().toISOString().split("T")[0];

        // 當頁面加載時，重置服務器上的賬單狀態
        authenticatedFetch("/api/bill/reset", { method: "POST" })
          .then((response) => (response ? response.json() : null))
          .then((data) => (data ? console.log(data.message) : null))
          .catch((error) => console.error("Error resetting bill:", error));

        // --- 所有與數據相關的函數都需要修改 ---

        // 更新賬單基本信息 (現在是異步操作)
        async function updateBillInfo() {
          const billInfo = {
            name: billNameInput.value,
            date: billDateInput.value,
            location: billLocationInput.value,
            tipPercentage: parseInt(billTipInput.value) || 0,
            payerId: billPayerSelect.value || undefined,
          };
          try {
            const response = await authenticatedFetch("/api/bill/info", {
              method: "POST",
              body: JSON.stringify(billInfo),
            });
            if (!response) return; // 認證失敗，已重定向
            if (!response.ok) {
              throw new Error("更新賬單信息失敗");
            }
            const data = await response.json();
            console.log(data.message);
          } catch (error) {
            console.error("Error updating bill info:", error);
            alert("更新賬單信息時出錯，請查看控制台");
          }
        }

        // 添加參與者
        addPersonBtn.addEventListener("click", async () => {
          const newParticipantInput = document.createElement("input");
          newParticipantInput.type = "text";
          newParticipantInput.placeholder = "參與者姓名";
          newParticipantInput.className =
            "flex-grow px-4 py-2 border border-gray-300 rounded-lg input-focus transition-all duration-300";

          // 創建新的參與者DOM元素
          const newParticipant = document.createElement("div");
          newParticipant.className =
            "participant-item flex items-center p-4 bg-light rounded-lg transform transition-all duration-300 opacity-0 translate-y-2";
          newParticipant.innerHTML = `
            <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold mr-4 cursor-pointer hover:bg-primary/20 transition-colors user-avatar-btn">
                <i class="fa fa-user"></i>
            </div>
            <input type="text" placeholder="參與者姓名" 
                class="flex-grow px-4 py-2 border border-gray-300 rounded-lg input-focus transition-all duration-300">
            <button class="remove-person-btn ml-4 text-gray-400 hover:text-red-500 transition-colors">
                <i class="fa fa-times-circle text-xl"></i>
            </button>
        `;
          participantsContainer.appendChild(newParticipant);

          // 觸發動畫
          setTimeout(() => {
            newParticipant.classList.remove("opacity-0", "translate-y-2");
          }, 10);

          // 綁定刪除按鈕事件
          newParticipant
            .querySelector(".remove-person-btn")
            .addEventListener("click", function () {
              newParticipant.classList.add("opacity-0", "translate-y-2");
              setTimeout(() => {
                newParticipant.remove();
                // 刪除參與者後，更新所有項目的參與者標籤
                updateParticipantTags();
                updatePayerSelect();
              }, 300);
            });

          // 自動聚焦新輸入框
          const inputField = newParticipant.querySelector("input");
          inputField.focus();

          // 當用戶輸入完成後（例如，按下回車或失去焦點），發送請求
          inputField.addEventListener("blur", async () => {
            const name = inputField.value.trim();
            if (name) {
              try {
                const response = await authenticatedFetch("/api/participant", {
                  method: "POST",
                  body: JSON.stringify({ name: name }),
                });
                if (!response) return; // 認證失敗，已重定向
                if (!response.ok) {
                  throw new Error("添加參與者失敗");
                }
                const participant = await response.json();
                console.log("參與者已添加:", participant);
                // 將返回的ID存儲在DOM元素上，用於後續操作
                newParticipant.dataset.participantId = participant.id;
                newParticipant.dataset.participantName = participant.name;
                // 更新輸入框的值為服務器返回的完整名稱
                inputField.value = participant.name;
                // 更新所有項目的參與者標籤
                updateParticipantTags();
                updatePayerSelect();
              } catch (error) {
                console.error("Error adding participant:", error);
                alert("添加參與者時出錯，請查看控制台");
              }
            }
          });
        });

        // 計算按鈕點擊事件
        calculateBtn.addEventListener("click", async function () {
          try {
            // 首先保存所有表單數據到服務器
            await updateBillInfo();

            // 收集參與者信息
            const participantItems =
              participantsContainer.querySelectorAll(".participant-item");
            const participants = Array.from(participantItems)
              .map((item) => {
                const input = item.querySelector("input");
                const name = item.dataset.participantName || input.value.trim();
                const id = item.dataset.participantId;
                // 嚴格要求：必須同時有ID和名稱，否則忽略
                if (!name || name.length === 0 || !id) return null;
                return { name, id };
              })
              .filter((p) => p !== null);

            // 先從服務器獲取最新的參與者信息，確保ID匹配
            let serverParticipants = [];
            try {
              const billInfoResponse = await authenticatedFetch(
                "/api/bill/info",
                {
                  method: "POST",
                  body: JSON.stringify({
                    name: billNameInput.value,
                    date: billDateInput.value,
                    location: billLocationInput.value,
                    tipPercentage: parseInt(billTipInput.value) || 0,
                  }),
                }
              );

              if (billInfoResponse && billInfoResponse.ok) {
                // 重新獲取服務器端的參與者信息
                const participantsResponse = await authenticatedFetch(
                  "/api/participants"
                );
                if (participantsResponse && participantsResponse.ok) {
                  serverParticipants = await participantsResponse.json();
                }
              }
            } catch (error) {
              console.error("獲取服務器參與者信息失敗:", error);
            }

            if (participants.length === 0) {
              alert("請至少添加一個參與者");
              return;
            }

            // 使用服務器端的參與者信息，確保ID匹配
            const finalParticipants =
              serverParticipants.length > 0 ? serverParticipants : participants;

            // 收集並上傳項目信息
            const items = Array.from(
              itemsContainer.querySelectorAll(".item-card")
            )
              .map((item) => {
                const name = item.querySelector(".item-name").value.trim();
                const amount =
                  parseFloat(item.querySelector(".item-amount").value) || 0;
                const isShared = item.querySelector(".item-is-shared").checked;

                let participantIds = [];
                if (isShared) {
                  // 如果是共享項目，所有參與者都參與
                  participantIds = finalParticipants.map((p) => p.id);
                } else {
                  // 如果不是共享項目，只包含選中的參與者
                  participantIds = Array.from(
                    item.querySelectorAll(".person-tag.bg-primary")
                  )
                    .map((tag) => tag.dataset.participantId)
                    .filter((id) => id);
                }

                return {
                  name,
                  amount,
                  isShared,
                  participantIds,
                };
              })
              .filter(
                (item) =>
                  item.name && item.amount > 0 && item.participantIds.length > 0
              );

            if (items.length === 0) {
              alert("請至少添加一個消費項目");
              return;
            }

            // 批量上傳項目
            for (const item of items) {
              try {
                const response = await authenticatedFetch("/api/item", {
                  method: "POST",
                  body: JSON.stringify(item),
                });
                if (!response) return; // 認證失敗，已重定向
                if (!response.ok) {
                  throw new Error("上傳項目失敗");
                }
              } catch (error) {
                console.error("Error adding item:", error);
                alert("上傳項目時出錯，請查看控制台");
                return;
              }
            }

            // 調用計算API
            const response = await authenticatedFetch("/api/calculate");
            if (!response) return; // 認證失敗，已重定向
            if (!response.ok) {
              throw new Error("計算賬單失敗");
            }
            const { bill, results } = await response.json();

            // 更新結果模態框
            updateResultModal(bill, results);

            // 顯示模態框
            resultModal.classList.remove("opacity-0", "invisible");
            resultModal.querySelector(".bg-white").classList.remove("scale-95");
            resultModal.querySelector(".bg-white").classList.add("scale-100");
            document.body.style.overflow = "hidden";
          } catch (error) {
            console.error("Error calculating bill:", error);
            alert("計算賬單時出錯，請查看控制台");
          }
        });

        // 更新結果模態框的函數
        function updateResultModal(bill, results) {
          // 更新聚會信息
          document.getElementById("result-bill-name").textContent =
            bill.name || "未命名聚會";
          document.getElementById("result-bill-date").textContent =
            formatDateForDisplay(bill.date);
          document.getElementById("result-bill-location").textContent =
            bill.location || "未指定地點";
          document.getElementById(
            "result-bill-participants"
          ).textContent = `${bill.participants.length}位參與者`;

          // 顯示付款人信息
          const payerInfo = document.getElementById("result-bill-payer");
          if (payerInfo) {
            if (bill.payerId) {
              const payer = bill.participants.find(
                (p) => p.id === bill.payerId
              );
              payerInfo.textContent = payer ? payer.name : "未知付款人";
            } else {
              payerInfo.textContent = "未指定付款人";
            }
          }

          // 更新費用明細表格
          const itemsTableBody = document.getElementById("result-items-table");
          itemsTableBody.innerHTML = "";
          bill.items.forEach((item) => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td class="py-3 px-4 border-b">${item.name}</td>
            <td class="py-3 px-4 text-right border-b">$${item.amount.toFixed(
              2
            )}</td>
          `;
            itemsTableBody.appendChild(row);
          });

          // 添加小費行
          const subtotal = bill.items.reduce(
            (sum, item) => sum + item.amount,
            0
          );
          const tipAmount = subtotal * (bill.tipPercentage / 100);
          const tipRow = document.createElement("tr");
          tipRow.innerHTML = `
          <td class="py-3 px-4 border-b font-semibold">小費 (${
            bill.tipPercentage
          }%)</td>
          <td class="py-3 px-4 text-right border-b font-semibold">$${tipAmount.toFixed(
            2
          )}</td>
        `;
          itemsTableBody.appendChild(tipRow);

          // 添加總計行
          const totalRow = document.createElement("tr");
          totalRow.className = "bg-primary/5";
          totalRow.innerHTML = `
          <td class="py-3 px-4 font-bold">總計</td>
          <td class="py-3 px-4 text-right font-bold">$${(
            subtotal + tipAmount
          ).toFixed(2)}</td>
        `;
          itemsTableBody.appendChild(totalRow);

          // 更新分攤結果
          const participantsContainer = document.getElementById(
            "result-participants-container"
          );
          participantsContainer.innerHTML = "";
          results.forEach((result) => {
            const participant = bill.participants.find(
              (p) => p.id === result.participantId
            );
            if (participant && participant.name && participant.name.trim()) {
              const participantCard = document.createElement("div");
              participantCard.className = "bg-light rounded-lg p-4";
              const isPayer = bill.payerId === participant.id;
              const paymentStatus = result.paymentStatus || "pending";
              const statusColor =
                paymentStatus === "paid" ? "text-green-600" : "text-orange-600";
              const statusText = paymentStatus === "paid" ? "已支付" : "待支付";
              const statusIcon =
                paymentStatus === "paid" ? "fa-check-circle" : "fa-clock";

              participantCard.innerHTML = `
              <div class="flex justify-between items-center">
                <div>
                  <div class="flex items-center gap-2">
                    <h5 class="font-semibold text-gray-800">${participant.name.trim()}</h5>
                    ${
                      isPayer
                        ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">付款人</span>'
                        : ""
                    }
                  </div>
                  <p class="text-sm text-gray-600">${
                    result.breakdown || "無明細"
                  }</p>
                  <div class="flex items-center gap-1 mt-1">
                    <i class="fa ${statusIcon} ${statusColor} text-xs"></i>
                    <span class="text-xs ${statusColor}">${statusText}</span>
                  </div>
                </div>
                <div class="text-right">
                  <span class="text-xl font-bold text-primary">$${result.amount.toFixed(
                    2
                  )}</span>
                  ${
                    !isPayer
                      ? `<p class="text-xs text-gray-500 mt-1">需支付給 ${
                          bill.participants.find((p) => p.id === bill.payerId)
                            ?.name || "付款人"
                        }</p>`
                      : ""
                  }
                </div>
              </div>
            `;
              participantsContainer.appendChild(participantCard);
            }
          });
        }

        // 格式化日期顯示
        function formatDateForDisplay(dateString) {
          const date = new Date(dateString);
          return `${date.getFullYear()}年${
            date.getMonth() + 1
          }月${date.getDate()}日`;
        }

        // 關閉模態框
        closeModalBtn.addEventListener("click", async () => {
          resultModal.classList.add("opacity-0", "invisible");
          resultModal.querySelector(".bg-white").classList.add("scale-95");
          resultModal.querySelector(".bg-white").classList.remove("scale-100");
          document.body.style.overflow = "auto";

          // 不要重置服務器狀態，保持參與者數據
          // 只清空項目數據，但保留參與者
          try {
            // 獲取當前參與者列表
            const participantItems =
              participantsContainer.querySelectorAll(".participant-item");
            const participants = Array.from(participantItems)
              .map((item) => {
                const input = item.querySelector("input");
                const name = item.dataset.participantName || input.value.trim();
                const id = item.dataset.participantId;
                // 確保名稱不為空且有效，如果沒有ID但有名字，暫時使用名字作為標識
                if (!name || name.length === 0) return null;
                return { name, id: id || `temp_${name}` };
              })
              .filter((p) => p !== null);

            // 重置服務器狀態
            await authenticatedFetch("/api/bill/reset", { method: "POST" });

            // 重新添加參與者到服務器
            for (const participant of participants) {
              await authenticatedFetch("/api/participant", {
                method: "POST",
                body: JSON.stringify({ name: participant.name }),
              });
            }

            console.log("賬單狀態已重置，參與者已重新添加");
          } catch (error) {
            console.error("重置賬單狀態失敗:", error);
          }
        });

        // 點擊模態框背景關閉
        resultModal.addEventListener("click", async (e) => {
          if (e.target === resultModal) {
            resultModal.classList.add("opacity-0", "invisible");
            resultModal.querySelector(".bg-white").classList.add("scale-95");
            resultModal
              .querySelector(".bg-white")
              .classList.remove("scale-100");
            document.body.style.overflow = "auto";

            // 不要重置服務器狀態，保持參與者數據
            // 只清空項目數據，但保留參與者
            try {
              // 獲取當前參與者列表
              const participantItems =
                participantsContainer.querySelectorAll(".participant-item");
              const participants = Array.from(participantItems)
                .map((item) => {
                  const input = item.querySelector("input");
                  const name =
                    item.dataset.participantName || input.value.trim();
                  const id = item.dataset.participantId;
                  // 確保名稱不為空且有效，如果沒有ID但有名字，暫時使用名字作為標識
                  if (!name || name.length === 0) return null;
                  return { name, id: id || `temp_${name}` };
                })
                .filter((p) => p !== null);

              // 重置服務器狀態
              await authenticatedFetch("/api/bill/reset", { method: "POST" });

              // 重新添加參與者到服務器
              for (const participant of participants) {
                await authenticatedFetch("/api/participant", {
                  method: "POST",
                  body: JSON.stringify({ name: participant.name }),
                });
              }

              console.log("賬單狀態已重置，參與者已重新添加");
            } catch (error) {
              console.error("重置賬單狀態失敗:", error);
            }
          }
        });

        // 保存草稿功能已暫時移除
        /*
        saveDraftBtn.addEventListener("click", async () => {
          try {
            await updateBillInfo();
            alert("草稿已保存");
          } catch (error) {
            console.error("Error saving draft:", error);
            alert("保存草稿時出錯");
          }
        });
        */

        // 保存結果功能
        saveResultBtn.addEventListener("click", async () => {
          try {
            const response = await authenticatedFetch("/api/bill/save", {
              method: "POST",
            });

            if (!response) return; // 認證失敗，已重定向

            if (response.ok) {
              const data = await response.json();
              alert(`賬單已保存，ID: ${data.billId}`);
            } else {
              const errorData = await response.json();
              alert(`保存失敗: ${errorData.error}`);
            }
          } catch (error) {
            console.error("Error saving result:", error);
            alert("保存賬單時出錯");
          }
        });

        // 添加消費項目的功能
        addItemBtn.addEventListener("click", () => {
          const itemCard = document.createElement("div");
          itemCard.className =
            "item-card bg-light rounded-lg p-6 transform transition-all duration-300 opacity-0 translate-y-2";
          itemCard.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-gray-700 font-medium mb-2">項目名稱</label>
              <input type="text" class="item-name w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-all duration-300" placeholder="例如：漢堡套餐">
            </div>
            <div>
              <label class="block text-gray-700 font-medium mb-2">金額 (HKD)</label>
              <input type="number" class="item-amount w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-all duration-300" placeholder="0.00" min="0" step="0.01">
            </div>
          </div>
          <div class="mb-4">
            <label class="flex items-center">
              <input type="checkbox" class="item-is-shared mr-2" checked>
              <span class="text-gray-700">共享項目（所有參與者分攤）</span>
            </label>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">參與者</label>
            <div class="participants-selection flex flex-wrap gap-2">
              <!-- 參與者選擇標籤將通過JS動態生成 -->
            </div>
          </div>
          <div class="flex justify-end">
            <button class="remove-item-btn text-red-500 hover:text-red-700 transition-colors">
              <i class="fa fa-trash mr-1"></i> 刪除項目
            </button>
          </div>
        `;

          itemsContainer.appendChild(itemCard);

          // 觸發動畫
          setTimeout(() => {
            itemCard.classList.remove("opacity-0", "translate-y-2");
          }, 10);

          // 獲取參與者選擇容器
          const participantsSelection = itemCard.querySelector(
            ".participants-selection"
          );

          // 更新參與者選擇標籤（只更新新添加的項目）
          updateParticipantTagsForSelection(participantsSelection);

          // 綁定刪除按鈕事件
          itemCard
            .querySelector(".remove-item-btn")
            .addEventListener("click", () => {
              itemCard.classList.add("opacity-0", "translate-y-2");
              setTimeout(() => {
                itemCard.remove();
              }, 300);
            });

          // 綁定共享項目切換事件
          const isSharedCheckbox = itemCard.querySelector(".item-is-shared");

          isSharedCheckbox.addEventListener("change", () => {
            if (isSharedCheckbox.checked) {
              participantsSelection.style.display = "none";
            } else {
              participantsSelection.style.display = "block";
              // 只更新當前項目的參與者標籤，不影響其他項目
              updateParticipantTagsForSelection(participantsSelection);
            }
          });
        });

        // 更新付款人選擇框
        function updatePayerSelect() {
          const participantItems =
            participantsContainer.querySelectorAll(".participant-item");
          const participants = Array.from(participantItems)
            .map((item) => {
              const input = item.querySelector("input");
              const name = item.dataset.participantName || input.value.trim();
              const id = item.dataset.participantId;
              if (!name || name.length === 0 || !id) return null;
              return { name, id };
            })
            .filter((p) => p !== null);

          // 保存當前選擇
          const currentPayerId = billPayerSelect.value;

          // 清空並重新填充選項
          billPayerSelect.innerHTML =
            '<option value="">請選擇付款人（可稍後選擇）</option>';

          participants.forEach((participant) => {
            const option = document.createElement("option");
            option.value = participant.id;
            option.textContent = participant.name;
            if (participant.id === currentPayerId) {
              option.selected = true;
            }
            billPayerSelect.appendChild(option);
          });
        }

        // 更新參與者選擇標籤的函數
        function updateParticipantTags() {
          const participantItems =
            participantsContainer.querySelectorAll(".participant-item");
          const participants = Array.from(participantItems)
            .map((item) => {
              const input = item.querySelector("input");
              const name = item.dataset.participantName || input.value.trim();
              const id = item.dataset.participantId;
              // 嚴格要求：必須同時有ID和名稱
              if (!name || name.length === 0 || !id) return null;
              return { name, id };
            })
            .filter((p) => p !== null);

          // 更新所有項目卡片中的參與者選擇
          document
            .querySelectorAll(".participants-selection")
            .forEach((selection) => {
              // 保存當前選中的參與者ID
              const selectedIds = new Set();
              selection
                .querySelectorAll(".person-tag.bg-primary")
                .forEach((tag) => {
                  selectedIds.add(tag.dataset.participantId);
                });

              // 清空並重新創建標籤
              selection.innerHTML = "";
              participants.forEach((participant) => {
                const tag = document.createElement("span");
                const isSelected = selectedIds.has(participant.id);
                tag.className = isSelected
                  ? "person-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-primary text-white cursor-pointer hover:bg-primary/80 transition-colors"
                  : "person-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-primary/10 text-primary cursor-pointer hover:bg-primary/20 transition-colors";
                tag.textContent = participant.name;
                tag.dataset.participantId = participant.id;
                tag.dataset.participantName = participant.name;
                selection.appendChild(tag);

                // 綁定點擊事件來切換選擇狀態
                tag.addEventListener("click", () => {
                  tag.classList.toggle("bg-primary");
                  tag.classList.toggle("text-white");
                  tag.classList.toggle("bg-primary/10");
                  tag.classList.toggle("text-primary");
                });
              });
            });
        }

        // 更新特定選擇容器的參與者標籤
        function updateParticipantTagsForSelection(selection) {
          const participantItems =
            participantsContainer.querySelectorAll(".participant-item");
          const participants = Array.from(participantItems)
            .map((item) => {
              const input = item.querySelector("input");
              const name = item.dataset.participantName || input.value.trim();
              const id = item.dataset.participantId;
              // 確保名稱不為空且有效，如果沒有ID但有名字，暫時使用名字作為標識
              if (!name || name.length === 0) return null;
              return { name, id: id || `temp_${name}` };
            })
            .filter((p) => p !== null);

          // 保存當前選中的參與者ID
          const selectedIds = new Set();
          selection
            .querySelectorAll(".person-tag.bg-primary")
            .forEach((tag) => {
              selectedIds.add(tag.dataset.participantId);
            });

          // 清空並重新創建標籤
          selection.innerHTML = "";
          participants.forEach((participant) => {
            const tag = document.createElement("span");
            const isSelected = selectedIds.has(participant.id);
            tag.className = isSelected
              ? "person-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-primary text-white cursor-pointer hover:bg-primary/80 transition-colors"
              : "person-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-primary/10 text-primary cursor-pointer hover:bg-primary/20 transition-colors";
            tag.textContent = participant.name;
            tag.dataset.participantId = participant.id;
            tag.dataset.participantName = participant.name;
            selection.appendChild(tag);

            // 綁定點擊事件來切換選擇狀態
            tag.addEventListener("click", () => {
              tag.classList.toggle("bg-primary");
              tag.classList.toggle("text-white");
              tag.classList.toggle("bg-primary/10");
              tag.classList.toggle("text-primary");
            });
          });
        }

        // 當參與者輸入框內容改變時，更新所有項目的參與者標籤
        participantsContainer.addEventListener("input", async (e) => {
          const input = e.target;
          const participantItem = input.closest(".participant-item");
          const name = input.value.trim();

          // 如果參與者還沒有ID但有名字，則創建參與者
          if (
            name &&
            name.length > 0 &&
            !participantItem.dataset.participantId
          ) {
            try {
              const response = await authenticatedFetch("/api/participant", {
                method: "POST",
                body: JSON.stringify({ name: name }),
              });
              if (response.ok) {
                const participant = await response.json();
                participantItem.dataset.participantId = participant.id;
                participantItem.dataset.participantName = participant.name;
                // 更新輸入框的值為服務器返回的完整名稱
                input.value = participant.name;
                updateParticipantTags();
                updatePayerSelect();
              }
            } catch (error) {
              console.error("Error creating participant:", error);
            }
          } else if (!name || name.length === 0) {
            // 如果名字被清空，清除ID
            participantItem.dataset.participantId = "";
            participantItem.dataset.participantName = "";
            updateParticipantTags();
            updatePayerSelect();
          } else {
            // 更新名字 - 只有在沒有ID的情況下才更新dataset
            if (!participantItem.dataset.participantId) {
              participantItem.dataset.participantName = name;
            }
            updateParticipantTags();
            updatePayerSelect();
          }
        });

        // 為初始參與者添加刪除事件
        document.querySelectorAll(".remove-person-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const participantItem = btn.closest(".participant-item");
            participantItem.classList.add("opacity-0", "translate-y-2");
            setTimeout(() => {
              participantItem.remove();
              // 刪除參與者後，更新所有項目的參與者標籤
              updateParticipantTags();
              updatePayerSelect();
            }, 300);
          });
        });

        // 用戶搜尋功能
        let currentParticipantItem = null;
        const userSearchModal = document.getElementById("user-search-modal");
        const closeUserSearchBtn = document.getElementById(
          "close-user-search-btn"
        );
        const userSearchInput = document.getElementById("user-search-input");
        const userSearchResults = document.getElementById(
          "user-search-results"
        );
        const addSelfBtn = document.getElementById("add-self-btn");

        // 打開用戶搜尋彈窗
        function openUserSearch(participantItem) {
          currentParticipantItem = participantItem;
          userSearchModal.classList.remove("opacity-0", "invisible");
          userSearchModal
            .querySelector(".bg-white")
            .classList.remove("scale-95");
          userSearchModal.querySelector(".bg-white").classList.add("scale-100");
          userSearchInput.focus();
          userSearchInput.value = "";
          userSearchResults.innerHTML = "";
        }

        // 關閉用戶搜尋彈窗
        function closeUserSearch() {
          userSearchModal.classList.add("opacity-0", "invisible");
          userSearchModal.querySelector(".bg-white").classList.add("scale-95");
          userSearchModal
            .querySelector(".bg-white")
            .classList.remove("scale-100");
          currentParticipantItem = null;
        }

        // 搜尋用戶
        async function searchUsers(query) {
          if (!query || query.length < 1) {
            userSearchResults.innerHTML = "";
            return;
          }

          try {
            const response = await authenticatedFetch(
              `/api/users/search?query=${encodeURIComponent(query)}`
            );
            if (!response) return;

            const data = await response.json();
            displaySearchResults(data.users);
          } catch (error) {
            console.error("搜尋用戶失敗:", error);
          }
        }

        // 顯示搜尋結果
        function displaySearchResults(users) {
          userSearchResults.innerHTML = "";

          if (users.length === 0) {
            userSearchResults.innerHTML =
              '<div class="text-gray-500 text-center py-4">沒有找到匹配的用戶</div>';
            return;
          }

          users.forEach((user) => {
            const userItem = document.createElement("div");
            userItem.className =
              "flex items-center justify-between p-3 border border-gray-200 rounded-lg mb-2 hover:bg-gray-50 cursor-pointer";
            userItem.innerHTML = `
            <div>
              <div class="font-medium">${user.username}</div>
              <div class="text-sm text-gray-500">${user.email}</div>
            </div>
            <button class="add-user-btn text-primary hover:text-primary/80" data-user-id="${user.id}" data-user-name="${user.username}">
              <i class="fa fa-plus"></i>
            </button>
          `;
            userSearchResults.appendChild(userItem);
          });
        }

        // 添加用戶為參與者
        async function addUserAsParticipant(userId, userName) {
          try {
            const response = await authenticatedFetch("/api/participant", {
              method: "POST",
              body: JSON.stringify({ name: userName }),
            });

            if (!response) return;

            if (response.ok) {
              const participant = await response.json();

              // 更新當前參與者項目的數據
              if (currentParticipantItem) {
                const input = currentParticipantItem.querySelector("input");
                currentParticipantItem.dataset.participantId = participant.id;
                currentParticipantItem.dataset.participantName =
                  participant.name;
                input.value = participant.name;
              }

              // 更新所有項目的參與者標籤
              updateParticipantTags();
              // 更新付款人選擇框
              updatePayerSelect();
              closeUserSearch();
            }
          } catch (error) {
            console.error("添加參與者失敗:", error);
          }
        }

        // 添加自己為參與者
        async function addSelfAsParticipant() {
          const currentUser = authManager.getCurrentUser();
          if (currentUser) {
            await addUserAsParticipant(currentUser.id, currentUser.username);
          }
        }

        // 事件監聽器
        closeUserSearchBtn.addEventListener("click", closeUserSearch);

        userSearchModal.addEventListener("click", (e) => {
          if (e.target === userSearchModal) {
            closeUserSearch();
          }
        });

        userSearchInput.addEventListener("input", (e) => {
          searchUsers(e.target.value);
        });

        addSelfBtn.addEventListener("click", addSelfAsParticipant);

        userSearchResults.addEventListener("click", (e) => {
          if (e.target.closest(".add-user-btn")) {
            const btn = e.target.closest(".add-user-btn");
            const userId = btn.dataset.userId;
            const userName = btn.dataset.userName;
            addUserAsParticipant(userId, userName);
          }
        });

        // 為所有參與者頭像添加點擊事件
        document.addEventListener("click", (e) => {
          if (e.target.closest(".user-avatar-btn")) {
            const participantItem = e.target.closest(".participant-item");
            openUserSearch(participantItem);
          }
        });

        // 列印為JPG功能
        const printToJpgBtn = document.getElementById("print-to-jpg-btn");
        if (printToJpgBtn) {
          printToJpgBtn.addEventListener("click", async () => {
            try {
              const modalContent = resultModal.querySelector(".bg-white");
              if (!modalContent) {
                alert("沒有找到要列印的內容");
                return;
              }

              // 使用html2canvas截圖
              const canvas = await html2canvas(modalContent, {
                backgroundColor: "#ffffff",
                scale: 2,
                useCORS: true,
                allowTaint: true,
              });

              // 轉換為JPG並下載
              const link = document.createElement("a");
              link.download = `賬單報告_${
                new Date().toISOString().split("T")[0]
              }.jpg`;
              link.href = canvas.toDataURL("image/jpeg", 0.9);
              link.click();
            } catch (error) {
              console.error("列印失敗:", error);
              alert("列印失敗，請稍後再試");
            }
          });
        }

        // 初始化時添加一個參與者和一個項目輸入框
        setTimeout(() => {
          // 添加初始參與者
          addPersonBtn.click();
          // 添加初始項目
          addItemBtn.click();
        }, 100);
      });
    </script>
  </body>
</html>
