<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/img/icon32x32.png" sizes="16x16" />
    <title>智能計算 - PBC聚賬通</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
      :root {
        --primary: #4f46e5;
        --primary-light: #e0e7ff;
        --dark: #1f2937;
        --light: #f8fafc;
      }

      .text-primary {
        color: var(--primary);
      }

      .bg-primary {
        background-color: var(--primary);
      }

      .bg-light {
        background-color: var(--light);
      }

      .text-dark {
        color: var(--dark);
      }

      .input-focus:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
        padding: 0.75rem 1.5rem;
        min-height: 44px;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn-primary:hover {
        background-color: #3730a3;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      }

      .btn-secondary {
        background-color: #f3f4f6;
        color: var(--dark);
        padding: 0.75rem 1.5rem;
        min-height: 44px;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        border: 1px solid #d1d5db;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn-secondary:hover {
        background-color: #e5e7eb;
        transform: translateY(-1px);
      }
    </style>
  </head>
  <body
    class="font-sans text-dark bg-gray-50 min-h-screen"
    style="background-color: #f9fafb"
  >
    <!-- Header 將由 JavaScript 動態插入 -->

    <!-- 主要內容 -->
    <main class="pt-24 pb-20">
      <section class="container mx-auto px-4 sm:px-6 lg:px-8">
        <!-- 頁面標題 -->
        <div class="text-center mb-12">
          <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold mb-4 text-dark">
            智能賬單<span class="text-primary">計算</span>
          </h1>
          <p class="text-gray-600 max-w-2xl mx-auto text-lg">
            簡單輸入，公平分攤，輕鬆搞定每一筆聚會賬單
          </p>
        </div>

        <div class="max-w-5xl mx-auto">
          <!-- 步驟導航 -->
          <div class="flex flex-wrap justify-center gap-4 sm:gap-8 mb-10">
            <div class="flex items-center">
              <div
                class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold shadow-md shadow-primary/20 text-sm sm:text-base"
              >
                1
              </div>
              <div class="h-1 w-8 sm:w-16 bg-primary mx-1 sm:mx-2"></div>
              <span class="text-primary font-medium text-sm sm:text-base"
                >基本信息</span
              >
            </div>
            <div class="flex items-center">
              <div
                class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-primary text-white flex items-center justify-center font-bold shadow-md shadow-primary/20 text-sm sm:text-base"
              >
                2
              </div>
              <div class="h-1 w-8 sm:w-16 bg-primary mx-1 sm:mx-2"></div>
              <span class="text-primary font-medium text-sm sm:text-base"
                >添加項目</span
              >
            </div>
            <div class="flex items-center">
              <div
                class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-sm sm:text-base"
              >
                3
              </div>
              <div class="h-1 w-8 sm:w-16 bg-gray-200 mx-1 sm:mx-2"></div>
              <span class="text-gray-500 text-sm sm:text-base">計算結果</span>
            </div>
          </div>

          <!-- 計算卡片 -->
          <div
            class="bg-white rounded-2xl shadow-xl overflow-hidden transform transition-all duration-500 hover:shadow-2xl"
          >
            <!-- 卡片頭部 -->
            <div
              class="bg-gradient-to-r from-primary to-primary/80 p-4 sm:p-6 text-white"
            >
              <h2 class="text-xl sm:text-2xl font-bold mb-2">創建新賬單</h2>
              <p class="text-white/90 text-sm sm:text-base">
                輸入聚會信息和消費項目，我們將為您自動計算
              </p>
            </div>

            <!-- 卡片內容 -->
            <div class="p-4 sm:p-6 md:p-8">
              <!-- 基本信息表單 -->
              <div class="mb-10">
                <h3 class="text-xl font-semibold mb-6 flex items-center">
                  <i class="fa fa-info-circle text-primary mr-3"></i>基本信息
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label
                      for="bill-name"
                      class="block text-gray-700 font-medium mb-2"
                      >聚會名稱</label
                    >
                    <input
                      type="text"
                      id="bill-name"
                      placeholder="例如：週末聚餐、公司下午茶"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus transition-all duration-300"
                    />
                  </div>
                  <div>
                    <label
                      for="bill-date"
                      class="block text-gray-700 font-medium mb-2"
                      >日期</label
                    >
                    <input
                      type="date"
                      id="bill-date"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus transition-all duration-300"
                    />
                  </div>
                  <div>
                    <label
                      for="bill-location"
                      class="block text-gray-700 font-medium mb-2"
                      >地點</label
                    >
                    <input
                      type="text"
                      id="bill-location"
                      placeholder="例如：麥當勞、鼎泰豐"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus transition-all duration-300"
                    />
                  </div>
                  <div>
                    <label
                      for="bill-tip"
                      class="block text-gray-700 font-medium mb-2"
                      >小費比例 (%)</label
                    >
                    <input
                      type="number"
                      id="bill-tip"
                      placeholder="0"
                      step="0.01"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus transition-all duration-300"
                    />
                    <p class="text-xs text-gray-500 mt-1">
                      正數表示小費比例（%），負數表示折扣比例（%）
                    </p>
                  </div>
                  <div class="md:col-span-2">
                    <label
                      for="bill-payer"
                      class="block text-gray-700 font-medium mb-2"
                      >付款人 <span class="text-red-500">*</span></label
                    >
                    <select
                      id="bill-payer"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus transition-all duration-300"
                      required
                    >
                      <option value="">請選擇付款人（必選）</option>
                    </select>
                    <p class="text-sm text-gray-500 mt-1">
                      選擇誰先付錢，其他人需要向此人支付相應金額（保存賬單時必須選擇）
                    </p>
                  </div>
                  <!-- AI 賬單識別區域（OCR + LLM） -->
                  <div class="md:col-span-2 mt-4">
                    <div
                      class="border border-dashed border-primary/40 rounded-xl p-4 md:p-5 bg-primary/5 flex flex-col md:flex-row md:items-center md:justify-between gap-4"
                    >
                      <div>
                        <h4 class="font-semibold text-primary mb-1">
                          <i class="fa fa-magic mr-2"></i>AI 賬單識別（Beta）
                        </h4>
                        <p class="text-sm text-gray-600">
                          上傳餐廳賬單照片，由系統自動識別並預填聚會名稱、日期、地點與項目草稿。
                          請在保存前仔細檢查與修改。
                        </p>
                        <p
                          id="ocr-status"
                          class="mt-2 text-xs text-gray-500"
                        ></p>
                        <p
                          id="ocr-usage-info"
                          class="mt-2 text-xs text-gray-600"
                        >
                          <i class="fa fa-info-circle mr-1"></i>
                          今日使用：<span id="ocr-usage-used">0</span>/<span id="ocr-usage-limit">10</span> 次
                          （剩餘 <span id="ocr-usage-remaining">10</span> 次）
                        </p>
                      </div>
                      <div class="flex flex-col sm:flex-row gap-2 md:gap-3">
                        <input
                          type="file"
                          id="ocr-bill-image-input"
                          accept="image/*"
                          class="hidden"
                        />
                        <button
                          type="button"
                          id="ocr-select-image-btn"
                          class="btn-secondary w-full sm:w-auto"
                        >
                          <i class="fa fa-image mr-2"></i> 選擇賬單圖片
                        </button>
                        <button
                          type="button"
                          id="ocr-bill-upload-btn"
                          class="btn-primary w-full sm:w-auto"
                        >
                          <i class="fa fa-wand-magic-sparkles mr-2"></i>
                          從圖片識別賬單
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 參與者 -->
              <div class="mb-10">
                <h3 class="text-xl font-semibold flex items-center mb-6">
                  <i class="fa fa-users text-primary mr-3"></i>參與者
                </h3>

                <div id="participants-container" class="flex flex-wrap gap-3">
                  <!-- 參與者卡片將通過JavaScript動態創建 -->
                </div>
              </div>

              <!-- 消費項目 -->
              <div class="mb-10">
                <div class="flex justify-between items-center mb-6">
                  <h3 class="text-xl font-semibold flex items-center">
                    <i class="fa fa-shopping-basket text-primary mr-3"></i
                    >消費項目
                  </h3>
                  <button
                    id="add-item-btn"
                    class="flex items-center text-primary hover:text-primary/80 transition-colors"
                  >
                    <i class="fa fa-plus-circle mr-1"></i> 添加項目
                  </button>
                </div>

                <div id="items-container" class="space-y-6">
                  <!-- 初始为空，通过JS添加 -->
                </div>
              </div>

              <!-- 操作按鈕 -->
              <div
                class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 pt-6 border-t border-gray-200"
              >
                <!-- 保存草稿按鈕已暫時移除
                <button
                  id="save-draft-btn"
                  class="btn-secondary w-full sm:w-auto"
                >
                  <i class="fa fa-save mr-2"></i> 保存草稿
                </button>
                -->
                <button id="calculate-btn" class="btn-primary w-full sm:w-auto">
                  <i class="fa fa-calculator mr-2"></i> 開始計算
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer 將由 JavaScript 動態插入 -->

    <!-- 用戶搜尋模態框 -->
    <div
      id="user-search-modal"
      class="fixed inset-0 bg-black/50 flex items-start justify-center z-50 transition-all duration-300 opacity-0 invisible overflow-y-auto p-4"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-md w-full my-4 transform transition-all duration-300 scale-95"
      >
        <div
          class="bg-gradient-to-r from-primary to-primary/80 p-6 text-white flex justify-between items-center"
        >
          <h3 class="text-xl font-bold">搜尋用戶</h3>
          <button
            id="close-user-search-btn"
            class="text-white hover:text-white/80 transition-colors"
          >
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        <div class="p-6">
          <div class="mb-4">
            <input
              type="text"
              id="user-search-input"
              placeholder="輸入用戶名或郵箱..."
              class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus transition-all duration-300"
            />
          </div>
          <div class="mb-4">
            <button
              id="add-self-btn"
              class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/80 transition-colors"
            >
              <i class="fa fa-user-plus mr-2"></i>加入自己
            </button>
          </div>
          <div id="user-search-results" class="max-h-60 overflow-y-auto">
            <!-- 搜尋結果將在這裡顯示 -->
          </div>
        </div>
      </div>
    </div>

    <!-- 計算結果模態框 -->
    <div
      id="result-modal"
      class="fixed inset-0 bg-black/50 flex items-start justify-center z-50 opacity-0 invisible transition-all duration-300 overflow-y-auto p-4"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full my-4 transform scale-95 transition-all duration-300"
      >
        <div
          class="bg-gradient-to-r from-primary to-primary/80 p-6 text-white flex justify-between items-center rounded-t-2xl"
        >
          <h3 class="text-2xl font-bold text-primary">計算結果</h3>
          <button
            id="close-modal-btn"
            class="text-white hover:text-white/80 transition-colors"
          >
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        <div class="p-6">
          <div class="mb-8">
            <h4 class="text-xl font-semibold mb-4">聚會信息</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
              <div class="flex items-center">
                <i class="fa fa-tag text-primary mr-3 w-5 text-center"></i>
                <span id="result-bill-name">週末聚餐</span>
              </div>
              <div class="flex items-center">
                <i class="fa fa-calendar text-primary mr-3 w-5 text-center"></i>
                <span id="result-bill-date">2024年5月25日</span>
              </div>
              <div class="flex items-center">
                <i
                  class="fa fa-map-marker text-primary mr-3 w-5 text-center"
                ></i>
                <span id="result-bill-location">麥當勞</span>
              </div>
              <div class="flex items-center">
                <i class="fa fa-users text-primary mr-3 w-5 text-center"></i>
                <span id="result-bill-participants">2位參與者</span>
              </div>
              <div class="flex items-center">
                <i
                  class="fa fa-credit-card text-primary mr-3 w-5 text-center"
                ></i>
                <span id="result-bill-payer">未指定付款人</span>
              </div>
            </div>
          </div>

          <div class="mb-8">
            <h4 class="text-xl font-semibold mb-4">費用明細</h4>
            <div class="overflow-x-auto">
              <table class="w-full border-collapse">
                <thead>
                  <tr class="bg-light">
                    <th
                      class="py-3 px-4 text-left text-gray-700 font-semibold border-b"
                    >
                      項目
                    </th>
                    <th
                      class="py-3 px-4 text-right text-gray-700 font-semibold border-b"
                    >
                      金額 (HKD)
                    </th>
                  </tr>
                </thead>
                <tbody id="result-items-table" class="text-gray-600">
                  <!-- 结果将通过JS填充 -->
                </tbody>
              </table>
            </div>
          </div>

          <div class="mb-8">
            <h4 class="text-xl font-semibold mb-4">分攤結果</h4>
            <div id="result-participants-container" class="space-y-4">
              <!-- 结果将通过JS填充 -->
            </div>
          </div>

          <!-- 付款人上傳收據區域 -->
          <div
            id="payer-receipt-section"
            class="mb-6 p-4 bg-blue-50 rounded-lg"
            style="display: none"
          >
            <h4 class="text-lg font-semibold mb-3 text-blue-800">
              <i class="fa fa-camera mr-2"></i>付款憑證上傳（付款人專用）
            </h4>
            <p class="text-sm text-gray-600 mb-3">
              作為付款人，您可以上傳付款憑證（如收據、發票照片），最多6張圖片。
            </p>
            <div class="flex items-center space-x-4">
              <input
                type="file"
                id="payer-receipt-input"
                accept="image/*"
                multiple
                class="hidden"
              />
              <button
                id="upload-payer-receipt-btn"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
              >
                <i class="fa fa-camera mr-2"></i>選擇圖片（最多6張）
              </button>
              <span
                id="receipt-file-count"
                class="text-sm text-gray-600"
              ></span>
            </div>
            <div
              id="receipt-preview-container"
              class="mt-3 grid grid-cols-3 gap-3"
              style="display: none"
            >
              <!-- 圖片預覽將在這裡顯示 -->
            </div>
          </div>

          <!-- 食物圖片上傳區域 -->
          <div
            id="food-images-section"
            class="mb-6 p-4 bg-green-50 border border-green-200 rounded-lg"
          >
            <h4 class="font-semibold text-green-900 mb-2">
              <i class="fa fa-utensils mr-2"></i>分享美食照片
            </h4>
            <p class="text-sm text-green-700 mb-3">
              上傳本次聚會的美食照片，系統會自動識別菜品（每訂單最多 2 張）。
              <span id="food-image-status" class="text-xs text-gray-600"></span>
            </p>
            <input
              type="file"
              id="food-image-input"
              accept="image/*"
              class="hidden"
            />
            <button
              type="button"
              id="upload-food-image-btn"
              class="btn-secondary mb-3"
            >
              <i class="fa fa-camera mr-2"></i>選擇美食照片
              <span id="food-image-count" class="ml-2 text-xs">(0/2)</span>
            </button>
            <div
              id="food-images-preview-container"
              class="grid grid-cols-2 sm:grid-cols-2 gap-3"
            ></div>
            <div id="food-recognition-results" class="mt-3 space-y-2"></div>
          </div>

          <div
            class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 pt-6 border-t border-gray-200"
          >
            <button
              class="btn-secondary w-full sm:w-auto"
              id="print-to-jpg-btn"
            >
              <i class="fa fa-print mr-2"></i> 列印報告
            </button>
            <div class="flex space-x-4 w-full sm:w-auto">
              <!-- 上傳賬單按鈕已註釋（通過保存賬單自動上傳）
              <button
                class="btn-secondary w-full sm:w-auto"
                id="upload-bill-btn"
              >
                <i class="fa fa-upload mr-2"></i> 上傳賬單
              </button>
              -->
              <button id="save-result-btn" class="btn-primary w-full sm:w-auto">
                <i class="fa fa-save mr-2"></i> 保存賬單
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 引入必要的腳本 -->
    <script src="/js/auth.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/page-setup.js"></script>

    <script type="module">
      /**
       * 轉義 HTML 特殊字符以防止 XSS 攻擊
       */
      function escapeHtml(text) {
        if (text == null) return "";
        const div = document.createElement("div");
        div.textContent = String(text);
        return div.innerHTML;
      }

      // 頁面初始化
      document.addEventListener("DOMContentLoaded", async () => {
        // 設置頁面組件
        const pageInitialized = await window.pageSetup.init({
          currentPage: "calculator",
          requireAuth: true,
          showHeader: true,
          showFooter: true,
          headerOptions: {
            showCalculator: true,
            showMyBills: true,
            showContact: true,
          },
        });

        if (!pageInitialized) {
          return; // 認證失敗，頁面會重定向
        }

        // 設置頁面特定功能
        window.pageSetup.setupPageFeatures({
          updateUserDisplay: true,
          setupLogout: true,
          setupAuthCheck: true,
        });

        // 使用全局認證管理器
        const authManager = window.authManager;
        let currentUser = authManager.getCurrentUser();
        let sessionId = authManager.getSessionId();

        // 使用認證管理器的fetch方法
        const authenticatedFetch =
          authManager.authenticatedFetch.bind(authManager);

        // DOM元素
        const billNameInput = document.getElementById("bill-name");
        const billDateInput = document.getElementById("bill-date");
        const billLocationInput = document.getElementById("bill-location");
        const billTipInput = document.getElementById("bill-tip");
        const billPayerSelect = document.getElementById("bill-payer");
        const participantsContainer = document.getElementById(
          "participants-container"
        );
        const itemsContainer = document.getElementById("items-container");
        const addItemBtn = document.getElementById("add-item-btn");
        const calculateBtn = document.getElementById("calculate-btn");
        // const saveDraftBtn = document.getElementById("save-draft-btn"); // 已暫時移除
        const resultModal = document.getElementById("result-modal");
        const closeModalBtn = document.getElementById("close-modal-btn");
        const saveResultBtn = document.getElementById("save-result-btn");
        // OCR + LLM 元素
        const ocrBillImageInput = document.getElementById(
          "ocr-bill-image-input"
        );
        const ocrSelectImageBtn = document.getElementById(
          "ocr-select-image-btn"
        );
        const ocrBillUploadBtn = document.getElementById(
          "ocr-bill-upload-btn"
        );
        const ocrStatus = document.getElementById("ocr-status");
        const ocrUsageInfo = document.getElementById("ocr-usage-info");
        const ocrUsageUsed = document.getElementById("ocr-usage-used");
        const ocrUsageLimit = document.getElementById("ocr-usage-limit");
        const ocrUsageRemaining = document.getElementById("ocr-usage-remaining");

        // 獲取並更新使用量信息
        async function updateOcrUsage() {
          try {
            const response = await authenticatedFetch("/api/bill/ocr-usage");
            if (response && response.ok) {
              const data = await response.json();
              if (ocrUsageUsed) ocrUsageUsed.textContent = data.used || 0;
              if (ocrUsageLimit) ocrUsageLimit.textContent = data.limit || 10;
              if (ocrUsageRemaining) ocrUsageRemaining.textContent = data.remaining || 10;
              
              // 如果已用完，顯示警告
              if (ocrUsageInfo) {
                if (data.remaining === 0) {
                  ocrUsageInfo.className = "mt-2 text-xs text-red-600";
                  ocrUsageInfo.innerHTML = `
                    <i class="fa fa-exclamation-triangle mr-1"></i>
                    今日使用次數已用完（${data.used}/${data.limit}），請明天再試
                  `;
                } else if (data.remaining <= 2) {
                  ocrUsageInfo.className = "mt-2 text-xs text-orange-600";
                } else {
                  ocrUsageInfo.className = "mt-2 text-xs text-gray-600";
                }
              }
            }
          } catch (error) {
            console.error("獲取使用量信息失敗:", error);
          }
        }

        // 初始化日期為今天
        billDateInput.value = new Date().toISOString().split("T")[0];

        // 頁面加載時獲取使用量信息
        updateOcrUsage();

        // 當頁面加載時，重置服務器上的賬單狀態並初始化默認值
        authenticatedFetch("/api/bill/reset", { method: "POST" })
          .then((response) => (response ? response.json() : null))
          .then((data) => {
            if (data) {
              console.log(data.message);
              // 初始化默認設置
              initializeDefaults();
            }
          })
          .catch((error) => console.error("Error resetting bill:", error));

        // 初始化默認設置
        async function initializeDefaults() {
          try {
            const currentUser = window.authManager.getCurrentUser();
            if (!currentUser) return;

            // 1. 添加當前用戶為第一個參與者
            const response1 = await authenticatedFetch("/api/participant", {
              method: "POST",
              body: JSON.stringify({ name: currentUser.username }),
            });

            if (response1 && response1.ok) {
              const participant1 = await response1.json();

              // 創建第一個參與者卡片
              createParticipantCard(participant1.id, participant1.name);

              // 設置默認付款人為當前用戶
              updatePayerSelect();
              billPayerSelect.value = participant1.id;
            }

            // 2. 創建"添加參與者"按鈕卡片
            createAddParticipantCard();

            console.log("默認參與者已初始化");
          } catch (error) {
            console.error("初始化默認設置失敗:", error);
          }
        }

        // --- OCR + LLM 自動識別賬單 ---

        function setOcrStatus(message, type = "info") {
          if (!ocrStatus) return;
          const colorMap = {
            info: "text-gray-600",
            success: "text-green-600",
            error: "text-red-600",
          };
          ocrStatus.className = `mt-2 text-xs ${colorMap[type] || "text-gray-600"}`;
          ocrStatus.textContent = message;
        }

        if (ocrSelectImageBtn && ocrBillImageInput) {
          ocrSelectImageBtn.addEventListener("click", () => {
            ocrBillImageInput.click();
          });

          ocrBillImageInput.addEventListener("change", () => {
            const file = ocrBillImageInput.files?.[0];
            if (file) {
              setOcrStatus(`已選擇圖片：${file.name}`, "info");
            } else {
              setOcrStatus("");
            }
          });
        }

        if (ocrBillUploadBtn && ocrBillImageInput) {
          ocrBillUploadBtn.addEventListener("click", async () => {
            try {
              let file = ocrBillImageInput.files?.[0];
              if (!file) {
                // 若尚未選擇，先打開選擇框
                ocrBillImageInput.click();
                setOcrStatus("請先選擇一張賬單圖片，再點擊識別。", "info");
                return;
              }

              setOcrStatus("正在上傳並識別賬單圖片，可能需要幾秒鐘，請稍候...", "info");
              ocrBillUploadBtn.disabled = true;
              ocrBillUploadBtn.innerHTML =
                '<i class="fa fa-spinner fa-spin mr-2"></i> 識別中...';

              const formData = new FormData();
              formData.append("billImage", file);

              const response = await authenticatedFetch(
                "/api/bill/ocr-upload",
                {
                  method: "POST",
                  body: formData,
                }
              );

              if (!response) {
                setOcrStatus("認證失敗，請重新登入後再試。", "error");
                return;
              }

              const data = await response.json();

              if (!response.ok || data.error) {
                // 檢查是否因為使用量限制失敗
                if (response.status === 429) {
                  setOcrStatus(
                    data.error || "今日識別次數已用完，請明天再試。",
                    "error"
                  );
                  if (data.usage) {
                    updateOcrUsage();
                  }
                } else {
                  setOcrStatus(
                    data.error ||
                      "識別失敗，請確保圖片清晰並包含完整賬單信息。",
                    "error"
                  );
                }
                return;
              }

              // 即使 LLM 解析失敗，後端也會返回 success: false，但仍有 ocrText
              if (!data.success) {
                setOcrStatus(
                  "已識別出文字，但自動解析失敗，請手動參考文字填寫賬單信息。",
                  "error"
                );
                console.log("OCR 文本：", data.ocrText);
                return;
              }

              const bill = data.bill;

              // 將 OCR 識別使用的圖片加入到收據上傳列表
              if (file && payerReceiptFiles.length < 6) {
                payerReceiptFiles.push(file);
                // 更新收據預覽
                updateReceiptPreview();
                setOcrStatus(
                  `識別成功！圖片已自動加入收據列表（${payerReceiptFiles.length}/6）`,
                  "success"
                );
              }

              // 使用解析結果預填基本信息
              if (bill) {
                if (bill.restaurant && !billNameInput.value) {
                  billNameInput.value = bill.restaurant;
                }
                if (bill.date) {
                  try {
                    const date = new Date(bill.date);
                    if (!isNaN(date.getTime())) {
                      billDateInput.value = date
                        .toISOString()
                        .split("T")[0];
                    }
                  } catch {}
                }
                if (bill.currency && !billLocationInput.value) {
                  // 若沒有地點但有餐廳名稱，已填在名稱；此處暫不使用 currency
                }
                if (bill.tip != null && !Number.isNaN(bill.tip)) {
                  // 將 tip 金額轉換為百分比
                  // 如果 tip 是金額（>= 1 或 <= -1），需要轉換為百分比
                  // 如果 tip 是百分比（0~1 之間或 -1~0 之間），直接轉換為百分比
                  const subtotal = bill.items.reduce(
                    (sum, item) => sum + (item.price || 0) * (item.quantity || 1),
                    0
                  );
                  
                  let tipPercentage = 0;
                  if (Math.abs(bill.tip) < 1) {
                    // tip 是百分比（小數形式，如 0.1 表示 10%，-0.1 表示 -10%）
                    tipPercentage = bill.tip * 100;
                  } else if (Math.abs(subtotal) > 0.01) {
                    // tip 是金額，轉換為百分比（支持負數）
                    tipPercentage = (bill.tip / subtotal) * 100;
                  } else {
                    // 無法轉換（subtotal 為 0 或接近 0），直接使用 tip 值（可能是百分比）
                    // 如果 tip 看起來是金額（>= 1），可能需要用戶手動調整
                    tipPercentage = bill.tip;
                  }
                  
                  billTipInput.value = tipPercentage.toFixed(2);
                }

                // 根據 items 建立項目草稿（清空舊項目）
                itemsContainer.innerHTML = "";
                if (Array.isArray(bill.items) && bill.items.length > 0) {
                  bill.items.forEach((item) => {
                    // 觸發現有邏輯創建一個項目卡片
                    addItemBtn.click();
                    const itemCard =
                      itemsContainer.lastElementChild;
                    if (!itemCard) return;
                    const nameInput =
                      itemCard.querySelector(".item-name");
                    const amountInput =
                      itemCard.querySelector(".item-amount");
                    const isSharedCheckbox =
                      itemCard.querySelector(".item-is-shared");
                    const participantsSelection =
                      itemCard.querySelector(
                        ".participants-selection"
                      );

                    if (nameInput) {
                      nameInput.value = item.name || "";
                    }
                    if (amountInput) {
                      // 支持 item.price 或 item.amount，並支持負數（折扣）
                      const itemAmount = typeof item.price === "number" 
                        ? item.price * (item.quantity || 1)
                        : (typeof item.amount === "number" ? item.amount : 0);
                      amountInput.value = itemAmount.toFixed(2);
                    }
                    if (isSharedCheckbox) {
                      isSharedCheckbox.checked = true;
                    }
                    if (participantsSelection) {
                      // 先更新參與者標籤，即使當前是共享項目
                      // 這樣當用戶取消勾選共享項目時，標籤已經準備好了
                      updateParticipantTagsForSelection(participantsSelection);
                      participantsSelection.style.display = "none";
                    }
                  });
                }
              }

              // 根據使用量狀態顯示不同的消息
              if (data.usage?.exceeded) {
                setOcrStatus(
                  "識別成功！但今日次數已用完，下次請明天再試。",
                  "error"
                );
              } else {
                setOcrStatus("賬單識別成功，已為你預填部分信息，請檢查並補充。", "success");
              }
              
              // 更新使用量信息
              if (data.usage) {
                updateOcrUsage();
              }
            } catch (error) {
              console.error("OCR 上傳/解析失敗:", error);
              setOcrStatus(
                "處理失敗，請稍後重試，或改為手動輸入賬單信息。",
                "error"
              );
            } finally {
              ocrBillUploadBtn.disabled = false;
              ocrBillUploadBtn.innerHTML =
                '<i class="fa fa-wand-magic-sparkles mr-2"></i> 從圖片識別賬單';
            }
          });
        }

        // --- 參與者卡片管理函數 ---

        // 創建參與者卡片
        function createParticipantCard(participantId, participantName) {
          const card = document.createElement("div");
          card.className =
            "participant-card flex flex-col items-center justify-center w-24 h-24 bg-white border-2 border-primary/30 rounded-lg cursor-pointer hover:border-primary hover:shadow-md transition-all duration-300 relative group";
          card.dataset.participantId = participantId;
          card.dataset.participantName = participantName;
          card.innerHTML = `
            <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center text-primary text-xl font-bold mb-1">
              ${escapeHtml(participantName.charAt(0).toUpperCase())}
            </div>
            <div class="text-xs text-gray-700 font-medium text-center px-1 truncate w-full">${escapeHtml(
              participantName
            )}</div>
            <button class="remove-participant-btn absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 flex items-center justify-center">
              <i class="fa fa-times text-xs"></i>
            </button>
          `;

          // 插入到"添加參與者"按鈕之前
          const addCard = participantsContainer.querySelector(".add-card");
          if (addCard) {
            participantsContainer.insertBefore(card, addCard);
          } else {
            participantsContainer.appendChild(card);
          }

          // 綁定刪除事件
          const removeBtn = card.querySelector(".remove-participant-btn");
          removeBtn.addEventListener("click", async (e) => {
            e.stopPropagation();
            await removeParticipantCard(card, participantId);
          });

          // 更新付款人選擇和項目標籤
          updatePayerSelect();
          updateParticipantTags();

          return card;
        }

        // 創建"添加參與者"按鈕卡片
        function createAddParticipantCard() {
          // 移除舊的添加卡片（如果存在）
          const oldAddCard = participantsContainer.querySelector(".add-card");
          if (oldAddCard) oldAddCard.remove();

          const addCard = document.createElement("div");
          addCard.className =
            "participant-card add-card flex flex-col items-center justify-center w-24 h-24 bg-primary/5 border-2 border-dashed border-primary/30 rounded-lg cursor-pointer hover:bg-primary/10 hover:border-primary/50 transition-all duration-300";
          addCard.innerHTML = `
            <i class="fa fa-plus text-2xl text-primary mb-1"></i>
            <span class="text-xs text-primary font-medium">添加參與者</span>
          `;

          addCard.addEventListener("click", () => {
            openUserSearchForNewParticipant();
          });

          participantsContainer.appendChild(addCard);
        }

        // 刪除參與者卡片
        async function removeParticipantCard(card, participantId) {
          if (!confirm("確定要移除此參與者嗎？")) return;

          // 添加淡出動畫
          card.style.opacity = "0";
          card.style.transform = "scale(0.8)";

          setTimeout(async () => {
            // 從服務器刪除
            if (participantId) {
              try {
                await authenticatedFetch(`/api/participant/${participantId}`, {
                  method: "DELETE",
                });
              } catch (error) {
                console.error("刪除參與者失敗:", error);
              }
            }

            card.remove();
            updatePayerSelect();
            updateParticipantTags();
          }, 300);
        }

        // --- 所有與數據相關的函數都需要修改 ---

        // 更新賬單基本信息 (現在是異步操作)
        async function updateBillInfo() {
          const billInfo = {
            name: billNameInput.value,
            date: billDateInput.value,
            location: billLocationInput.value,
            tipPercentage: parseInt(billTipInput.value) || 0,
            payerId: billPayerSelect.value || undefined,
          };
          try {
            const response = await authenticatedFetch("/api/bill/info", {
              method: "POST",
              body: JSON.stringify(billInfo),
            });
            if (!response) return; // 認證失敗，已重定向
            if (!response.ok) {
              throw new Error("更新賬單信息失敗");
            }
            const data = await response.json();
            console.log(data.message);
          } catch (error) {
            console.error("Error updating bill info:", error);
            alert("更新賬單信息時出錯，請查看控制台");
          }
        }

        // 計算按鈕點擊事件
        calculateBtn.addEventListener("click", async function () {
          try {
            // 首先保存所有表單數據到服務器
            await updateBillInfo();

            // 收集參與者信息（從卡片中）
            const participantCards = participantsContainer.querySelectorAll(
              ".participant-card:not(.add-card)"
            );
            const participants = Array.from(participantCards)
              .map((card) => {
                const name = card.dataset.participantName;
                const id = card.dataset.participantId;
                // 必須同時有ID和名稱
                if (!name || name.length === 0 || !id) return null;
                return { name, id };
              })
              .filter((p) => p !== null);

            // 先從服務器獲取最新的參與者信息，確保ID匹配
            let serverParticipants = [];
            try {
              const billInfoResponse = await authenticatedFetch(
                "/api/bill/info",
                {
                  method: "POST",
                  body: JSON.stringify({
                    name: billNameInput.value,
                    date: billDateInput.value,
                    location: billLocationInput.value,
                    tipPercentage: parseInt(billTipInput.value) || 0,
                  }),
                }
              );

              if (billInfoResponse && billInfoResponse.ok) {
                // 重新獲取服務器端的參與者信息
                const participantsResponse = await authenticatedFetch(
                  "/api/participants"
                );
                if (participantsResponse && participantsResponse.ok) {
                  serverParticipants = await participantsResponse.json();
                }
              }
            } catch (error) {
              console.error("獲取服務器參與者信息失敗:", error);
            }

            if (participants.length === 0) {
              alert("請至少添加一個參與者");
              return;
            }

            // 使用服務器端的參與者信息，確保ID匹配
            const finalParticipants =
              serverParticipants.length > 0 ? serverParticipants : participants;

            // 收集並上傳項目信息
            const items = Array.from(
              itemsContainer.querySelectorAll(".item-card")
            )
              .map((item) => {
                const name = item.querySelector(".item-name").value.trim();
                const amount =
                  parseFloat(item.querySelector(".item-amount").value) || 0;
                const isShared = item.querySelector(".item-is-shared").checked;

                let participantIds = [];
                if (isShared) {
                  // 如果是共享項目，所有參與者都參與
                  participantIds = finalParticipants.map((p) => p.id);
                } else {
                  // 如果不是共享項目，只包含選中的參與者
                  participantIds = Array.from(
                    item.querySelectorAll(".person-tag.bg-primary")
                  )
                    .map((tag) => tag.dataset.participantId)
                    .filter((id) => id);
                }

                // 如果項目沒有參與者，自動設為共享項目（確保項目不會被過濾掉）
                let finalIsShared = isShared;
                if (participantIds.length === 0 && finalParticipants.length > 0) {
                  participantIds = finalParticipants.map((p) => p.id);
                  finalIsShared = true;
                }

                return {
                  name,
                  amount,
                  isShared: finalIsShared,
                  participantIds,
                };
              })
              .filter(
                (item) =>
                  item.name && 
                  item.amount !== 0 && // 允許負數（折扣），但不允許 0
                  item.participantIds.length > 0
              );

            if (items.length === 0) {
              alert("請至少添加一個消費項目");
              return;
            }

            // 批量上傳項目
            for (const item of items) {
              try {
                const response = await authenticatedFetch("/api/item", {
                  method: "POST",
                  body: JSON.stringify(item),
                });
                if (!response) return; // 認證失敗，已重定向
                if (!response.ok) {
                  throw new Error("上傳項目失敗");
                }
              } catch (error) {
                console.error("Error adding item:", error);
                alert("上傳項目時出錯，請查看控制台");
                return;
              }
            }

            // 調用計算API
            const response = await authenticatedFetch("/api/calculate");
            if (!response) return; // 認證失敗，已重定向
            if (!response.ok) {
              throw new Error("計算賬單失敗");
            }
            const { bill, results } = await response.json();

            // 更新結果模態框
            updateResultModal(bill, results);

            // 顯示模態框
            resultModal.classList.remove("opacity-0", "invisible");
            resultModal.querySelector(".bg-white").classList.remove("scale-95");
            resultModal.querySelector(".bg-white").classList.add("scale-100");
            document.body.style.overflow = "hidden";
          } catch (error) {
            console.error("Error calculating bill:", error);
            alert("計算賬單時出錯，請查看控制台");
          }
        });

        // 更新結果模態框的函數
        function updateResultModal(bill, results) {
          // 更新聚會信息
          document.getElementById("result-bill-name").textContent =
            bill.name || "未命名聚會";
          document.getElementById("result-bill-date").textContent =
            formatDateForDisplay(bill.date);
          document.getElementById("result-bill-location").textContent =
            bill.location || "未指定地點";
          document.getElementById(
            "result-bill-participants"
          ).textContent = `${bill.participants.length}位參與者`;

          // 顯示付款人信息
          const payerInfo = document.getElementById("result-bill-payer");
          const payerReceiptSection = document.getElementById(
            "payer-receipt-section"
          );
          const currentUser = window.authManager.getCurrentUser();

          if (payerInfo) {
            if (bill.payerId) {
              const payer = bill.participants.find(
                (p) => p.id === bill.payerId
              );
              payerInfo.textContent = payer ? payer.name : "未知付款人";

              // 如果當前用戶是付款人，顯示上傳收據區域
              if (currentUser && payer && payer.name === currentUser.username) {
                payerReceiptSection.style.display = "block";
              } else {
                payerReceiptSection.style.display = "none";
              }
            } else {
              payerInfo.textContent = "未指定付款人";
              payerReceiptSection.style.display = "none";
            }
          }

          // 更新費用明細表格
          const itemsTableBody = document.getElementById("result-items-table");
          itemsTableBody.innerHTML = "";
          bill.items.forEach((item) => {
            const row = document.createElement("tr");
            // 支持負數顯示（折扣）
            const amount = item.amount || 0;
            const amountDisplay = amount >= 0 ? `$${amount.toFixed(2)}` : `-$${Math.abs(amount).toFixed(2)}`;
            row.innerHTML = `
            <td class="py-3 px-4 border-b">${escapeHtml(item.name)}</td>
            <td class="py-3 px-4 text-right border-b ${amount < 0 ? 'text-red-600' : ''}">${amountDisplay}</td>
          `;
            itemsTableBody.appendChild(row);
          });

          // 添加小費行（支持負數代表折扣）
          const subtotal = bill.items.reduce(
            (sum, item) => sum + item.amount,
            0
          );
          const tipAmount = subtotal * (bill.tipPercentage / 100);
          const tipRow = document.createElement("tr");
          const tipLabel = bill.tipPercentage >= 0 ? "小費" : "折扣";
          const tipSign = bill.tipPercentage >= 0 ? "+" : "";
          tipRow.innerHTML = `
          <td class="py-3 px-4 border-b font-semibold">${tipLabel} (${tipSign}${
            bill.tipPercentage.toFixed(2)
          }%)</td>
          <td class="py-3 px-4 text-right border-b font-semibold">${tipSign}$${tipAmount.toFixed(
            2
          )}</td>
        `;
          itemsTableBody.appendChild(tipRow);

          // 添加總計行
          const totalRow = document.createElement("tr");
          totalRow.className = "bg-primary/5";
          totalRow.innerHTML = `
          <td class="py-3 px-4 font-bold">總計</td>
          <td class="py-3 px-4 text-right font-bold">$${(
            subtotal + tipAmount
          ).toFixed(2)}</td>
        `;
          itemsTableBody.appendChild(totalRow);

          // 更新分攤結果
          const participantsContainer = document.getElementById(
            "result-participants-container"
          );
          participantsContainer.innerHTML = "";
          results.forEach((result) => {
            const participant = bill.participants.find(
              (p) => p.id === result.participantId
            );
            if (participant && participant.name && participant.name.trim()) {
              const participantCard = document.createElement("div");
              participantCard.className = "bg-light rounded-lg p-4";
              const isPayer = bill.payerId === participant.id;
              const paymentStatus = result.paymentStatus || "pending";
              const statusColor =
                paymentStatus === "paid" ? "text-green-600" : "text-orange-600";
              const statusText = paymentStatus === "paid" ? "已支付" : "待支付";
              const statusIcon =
                paymentStatus === "paid" ? "fa-check-circle" : "fa-clock";

              participantCard.innerHTML = `
              <div class="flex justify-between items-center">
                <div>
                  <div class="flex items-center gap-2">
                    <h5 class="font-semibold text-gray-800">${escapeHtml(
                      participant.name.trim()
                    )}</h5>
                    ${
                      isPayer
                        ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">付款人</span>'
                        : ""
                    }
                  </div>
                  <p class="text-sm text-gray-600">${escapeHtml(
                    result.breakdown || "無明細"
                  )}</p>
                  <div class="flex items-center gap-1 mt-1">
                    <i class="fa ${statusIcon} ${statusColor} text-xs"></i>
                    <span class="text-xs ${statusColor}">${escapeHtml(
                statusText
              )}</span>
                  </div>
                </div>
                <div class="text-right">
                  <span class="text-xl font-bold text-primary">$${result.amount.toFixed(
                    2
                  )}</span>
                  ${
                    !isPayer
                      ? `<p class="text-xs text-gray-500 mt-1">需支付給 ${escapeHtml(
                          bill.participants.find((p) => p.id === bill.payerId)
                            ?.name || "付款人"
                        )}</p>`
                      : ""
                  }
                </div>
              </div>
            `;
              participantsContainer.appendChild(participantCard);
            }
          });
        }

        // 格式化日期顯示
        function formatDateForDisplay(dateString) {
          const date = new Date(dateString);
          return `${date.getFullYear()}年${
            date.getMonth() + 1
          }月${date.getDate()}日`;
        }

        // 關閉結果模態框的函數
        async function closeResultModal() {
          resultModal.classList.add("opacity-0", "invisible");
          resultModal.querySelector(".bg-white").classList.add("scale-95");
          resultModal.querySelector(".bg-white").classList.remove("scale-100");
          document.body.style.overflow = "auto";

          // 不要重置服務器狀態，保持參與者數據
          // 只清空項目數據，但保留參與者
          try {
            // 獲取當前參與者列表（從卡片中）
            const participantCards = participantsContainer.querySelectorAll(
              ".participant-card:not(.add-card)"
            );
            const participants = Array.from(participantCards)
              .map((card) => {
                const name = card.dataset.participantName;
                const id = card.dataset.participantId;
                // 必須同時有ID和名稱
                if (!name || name.length === 0 || !id) return null;
                return { name, id };
              })
              .filter((p) => p !== null);

            // 保存當前選中的付款人名稱
            const currentPayerId = billPayerSelect.value;
            const currentPayerName =
              billPayerSelect.options[billPayerSelect.selectedIndex]?.text;

            // 重置服務器狀態
            await authenticatedFetch("/api/bill/reset", { method: "POST" });

            // 重新添加參與者到服務器，並更新前端卡片的 ID
            const oldIdToNewId = new Map();
            for (const participant of participants) {
              const response = await authenticatedFetch("/api/participant", {
                method: "POST",
                body: JSON.stringify({ name: participant.name }),
              });

              if (response && response.ok) {
                const newParticipant = await response.json();
                oldIdToNewId.set(participant.id, newParticipant.id);

                // 更新前端卡片的 participantId
                const participantCard = Array.from(participantCards).find(
                  (card) => card.dataset.participantId === participant.id
                );
                if (participantCard) {
                  participantCard.dataset.participantId = newParticipant.id;
                }
              }
            }

            // 更新付款人選擇框
            updatePayerSelect();

            // 恢復付款人選擇（根據名稱匹配）
            if (currentPayerName) {
              const options = Array.from(billPayerSelect.options);
              const matchingOption = options.find(
                (opt) => opt.text === currentPayerName
              );
              if (matchingOption) {
                billPayerSelect.value = matchingOption.value;
              }
            }

            console.log("賬單狀態已重置，參與者已重新添加");
          } catch (error) {
            console.error("重置賬單狀態失敗:", error);
          }
        }

        // 關閉模態框按鈕事件
        closeModalBtn.addEventListener("click", closeResultModal);

        // 點擊模態框背景關閉
        resultModal.addEventListener("click", async (e) => {
          if (e.target === resultModal) {
            await closeResultModal();
          }
        });

        // 保存草稿功能已暫時移除
        /*
        saveDraftBtn.addEventListener("click", async () => {
          try {
            await updateBillInfo();
            alert("草稿已保存");
          } catch (error) {
            console.error("Error saving draft:", error);
            alert("保存草稿時出錯");
          }
        });
        */

        // 付款人上傳收據功能（支持多張圖片，最多6張）
        let payerReceiptFiles = [];

        const uploadPayerReceiptBtn = document.getElementById(
          "upload-payer-receipt-btn"
        );
        const payerReceiptInput = document.getElementById(
          "payer-receipt-input"
        );
        const receiptFileCount = document.getElementById("receipt-file-count");
        const receiptPreviewContainer = document.getElementById(
          "receipt-preview-container"
        );

        uploadPayerReceiptBtn.addEventListener("click", () => {
          payerReceiptInput.click();
        });

        // 更新收據預覽的函數
        function updateReceiptPreview() {
          if (!receiptPreviewContainer || !receiptFileCount) return;

          receiptFileCount.textContent = `已選擇 ${payerReceiptFiles.length} 張圖片`;

          // 清空預覽容器
          receiptPreviewContainer.innerHTML = "";
          receiptPreviewContainer.style.display =
            payerReceiptFiles.length > 0 ? "grid" : "none";

          // 預覽所有圖片
          payerReceiptFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
              const previewDiv = document.createElement("div");
              previewDiv.className = "relative group";
              previewDiv.innerHTML = `
                <img src="${
                  e.target.result
                }" alt="收據預覽 ${index + 1}" class="w-full h-32 object-cover rounded-lg border border-gray-300">
                <button onclick="removeReceiptImage(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600">
                  <i class="fa fa-times text-xs"></i>
                </button>
              `;
              receiptPreviewContainer.appendChild(previewDiv);
            };
            reader.readAsDataURL(file);
          });
        }

        payerReceiptInput.addEventListener("change", (e) => {
          const newFiles = Array.from(e.target.files);

          // 合併新文件到現有文件列表
          const combinedFiles = [...payerReceiptFiles, ...newFiles];

          // 限制最多6張圖片
          if (combinedFiles.length > 6) {
            alert(
              `最多只能上傳6張圖片，已選擇${payerReceiptFiles.length}張，再選擇${newFiles.length}張將超過限制`
            );
            payerReceiptInput.value = "";
            return;
          }

          payerReceiptFiles = combinedFiles;
          updateReceiptPreview();
        });

        // 刪除指定的收據圖片
        window.removeReceiptImage = function (index) {
          // 從數組中移除指定的圖片
          payerReceiptFiles.splice(index, 1);
          // 更新預覽
          updateReceiptPreview();
        };

        // 食物圖片上傳功能（每訂單最多 2 張）
        let foodImages = []; // 存儲已上傳的圖片信息 {id, filename, storedPath, recognitionStatus}
        let currentBillId = null; // 當前訂單 ID（保存後才有）
        let pendingFoodImages = []; // 臨時存儲的圖片（保存前上傳的）

        const uploadFoodImageBtn = document.getElementById("upload-food-image-btn");
        const foodImageInput = document.getElementById("food-image-input");
        const foodImageCount = document.getElementById("food-image-count");
        const foodImagesPreviewContainer = document.getElementById("food-images-preview-container");
        const foodImageStatus = document.getElementById("food-image-status");
        const foodRecognitionResults = document.getElementById("food-recognition-results");

        // 更新食物圖片預覽（定義在 if 塊外，但只在元素存在時使用）
        function updateFoodImagesPreview() {
          if (!foodImagesPreviewContainer || !foodImageCount) return;

          const totalImages = foodImages.length + pendingFoodImages.length;
          foodImageCount.textContent = `(${totalImages}/2)`;

          foodImagesPreviewContainer.innerHTML = "";

          // 顯示已上傳的圖片
          foodImages.forEach((image, index) => {
            const previewDiv = document.createElement("div");
            previewDiv.className = "relative group";
            const statusText = image.recognitionStatus === 0 ? "待識別" : 
                             image.recognitionStatus === 1 ? "識別中..." :
                             image.recognitionStatus === 2 ? "已識別" : "識別失敗";
            const statusColor = image.recognitionStatus === 0 ? "bg-gray-500" :
                              image.recognitionStatus === 1 ? "bg-yellow-500" :
                              image.recognitionStatus === 2 ? "bg-green-500" : "bg-red-500";
            
            previewDiv.innerHTML = `
              <div class="relative">
                <img src="/food_images/${image.storedPath.split(/[/\\]/).pop()}" 
                     alt="${image.filename}" 
                     class="w-full h-32 object-cover rounded-lg border border-gray-300"
                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'200\\' height=\\'200\\'%3E%3Crect fill=\\'%23ddd\\' width=\\'200\\' height=\\'200\\'/%3E%3Ctext x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dy=\\'.3em\\' fill=\\'%23999\\'%3E圖片加載失敗%3C/text%3E%3C/svg%3E'">
                <div class="absolute top-1 left-1 ${statusColor} text-white text-xs px-2 py-1 rounded">${statusText}</div>
                <button onclick="removeFoodImage(${index}, false)" 
                        class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600">
                  <i class="fa fa-times text-xs"></i>
                </button>
              </div>
              <p class="text-xs text-gray-600 mt-1 truncate">${image.filename}</p>
            `;
            foodImagesPreviewContainer.appendChild(previewDiv);
          });

          // 顯示臨時圖片（保存前選擇的）
          pendingFoodImages.forEach((image, index) => {
            const previewDiv = document.createElement("div");
            previewDiv.className = "relative group";
            
            // 使用 FileReader 顯示預覽
            const reader = new FileReader();
            reader.onload = (e) => {
              previewDiv.innerHTML = `
                <div class="relative">
                  <img src="${e.target.result}" 
                       alt="${image.filename}" 
                       class="w-full h-32 object-cover rounded-lg border border-gray-300">
                  <div class="absolute top-1 left-1 bg-yellow-500 text-white text-xs px-2 py-1 rounded">待上傳</div>
                  <button onclick="removeFoodImage(${index}, true)" 
                          class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600">
                    <i class="fa fa-times text-xs"></i>
                  </button>
                </div>
                <p class="text-xs text-gray-600 mt-1 truncate">${image.filename}</p>
              `;
            };
            reader.readAsDataURL(image.file);
            foodImagesPreviewContainer.appendChild(previewDiv);
          });
        }

        // 加載訂單的食物圖片（定義在 if 塊外，確保可以在任何地方調用）
        async function loadFoodImages(billId) {
          if (!billId) return;
          currentBillId = billId;
          
          // 如果元素不存在，直接返回
          if (!foodImagesPreviewContainer || !foodImageCount) {
            return;
          }
          
          try {
            const response = await authenticatedFetch(`/api/food/images/${billId}`);
            if (response && response.ok) {
              const data = await response.json();
              foodImages = data.images || [];
              updateFoodImagesPreview();
              updateFoodRecognitionResults();
            }
          } catch (error) {
            console.error("加載食物圖片失敗:", error);
          }
        }

        // 更新識別結果顯示（定義在 if 塊外，確保總是被定義）
        function updateFoodRecognitionResults() {
          if (!foodRecognitionResults) return;

          foodRecognitionResults.innerHTML = "";

          foodImages.forEach((image) => {
            if (image.recognitionStatus === 2 && image.recognitionResult) {
              const result = Array.isArray(image.recognitionResult) ? image.recognitionResult : 
                           typeof image.recognitionResult === 'string' ? JSON.parse(image.recognitionResult) : 
                           image.recognitionResult;
              
              if (result && result.length > 0) {
                const resultDiv = document.createElement("div");
                resultDiv.className = "p-3 bg-green-50 border border-green-200 rounded-lg";
                resultDiv.innerHTML = `
                  <p class="text-sm font-semibold text-green-900 mb-2">
                    <i class="fa fa-check-circle mr-2"></i>${image.filename}
                  </p>
                  <div class="space-y-1">
                    ${result.map(item => `
                      <p class="text-sm text-gray-700">
                        <span class="font-medium">${item.name}</span>
                        ${item.confidence ? `<span class="text-gray-500">（置信度: ${(item.confidence * 100).toFixed(1)}%）</span>` : ''}
                        ${item.calories ? `<span class="text-blue-600 ml-2">${item.calories} 卡路里</span>` : ''}
                      </p>
                    `).join('')}
                  </div>
                `;
                foodRecognitionResults.appendChild(resultDiv);
              }
            } else if (image.recognitionStatus === 3) {
              const errorDiv = document.createElement("div");
              errorDiv.className = "p-3 bg-red-50 border border-red-200 rounded-lg";
              errorDiv.innerHTML = `
                <p class="text-sm font-semibold text-red-900 mb-1">
                  <i class="fa fa-exclamation-circle mr-2"></i>${image.filename}
                </p>
                <p class="text-xs text-red-700">${image.recognitionError || '識別失敗'}</p>
              `;
              foodRecognitionResults.appendChild(errorDiv);
            }
          });
        }

        // 如果元素不存在，跳過食物圖片功能的初始化（避免錯誤）
        if (uploadFoodImageBtn && foodImageInput && foodImageCount && foodImagesPreviewContainer) {

          // 上傳食物圖片
          uploadFoodImageBtn.addEventListener("click", () => {
            // 允許在保存前上傳，圖片會先存儲在臨時變量中
            foodImageInput.click();
          });

          foodImageInput.addEventListener("change", async (e) => {
            const file = e.target.files?.[0];
            if (!file) return;

            // 檢查上傳限制（包括臨時存儲的圖片）
            const totalImages = foodImages.length + pendingFoodImages.length;
            if (totalImages >= 2) {
              alert("每訂單最多只能上傳 2 張食物圖片");
              foodImageInput.value = "";
              return;
            }

            // 如果還沒有保存訂單，先存儲在臨時變量中
            if (!currentBillId) {
              // 創建臨時圖片對象
              const tempImage = {
                id: null,
                filename: file.name,
                storedPath: null,
                recognitionStatus: 0,
                file: file, // 保存文件對象，稍後上傳
                isPending: true,
              };
              pendingFoodImages.push(tempImage);
              
              // 更新預覽（顯示臨時圖片）
              updateFoodImagesPreview();
              
              if (foodImageStatus) {
                foodImageStatus.textContent = "圖片已選擇，將在保存訂單後自動上傳";
                foodImageStatus.className = "text-xs text-yellow-600";
              }
              
              // 清除文件選擇
              foodImageInput.value = "";
              return;
            }

            // 如果已經保存訂單，直接上傳
            try {
              // 顯示上傳狀態
              if (foodImageStatus) {
                foodImageStatus.textContent = "上傳中...";
                foodImageStatus.className = "text-xs text-blue-600";
              }

              const formData = new FormData();
              formData.append("foodImage", file);
              formData.append("billId", currentBillId);

              const response = await authenticatedFetch("/api/food/upload", {
                method: "POST",
                body: formData,
              });

              if (response && response.ok) {
                const data = await response.json();
                foodImages.push(data.image);
                updateFoodImagesPreview();

                if (foodImageStatus) {
                  foodImageStatus.textContent = "上傳成功！系統將在 1 分鐘後自動識別";
                  foodImageStatus.className = "text-xs text-green-600";
                }

                // 清除文件選擇
                foodImageInput.value = "";
              } else {
                const errorData = await response.json();
                alert(errorData.error || "上傳失敗");
                if (foodImageStatus) {
                  foodImageStatus.textContent = "";
                }
              }
            } catch (error) {
              console.error("上傳食物圖片失敗:", error);
              alert("上傳失敗，請重試");
              if (foodImageStatus) {
                foodImageStatus.textContent = "";
              }
            }
          });

          // 刪除食物圖片
          window.removeFoodImage = async function (index, isPending = false) {
            if (isPending) {
              // 刪除臨時圖片
              if (!confirm("確定要刪除這張圖片嗎？")) return;
              pendingFoodImages.splice(index, 1);
              updateFoodImagesPreview();
              return;
            }

            // 刪除已上傳的圖片
            const image = foodImages[index];
            if (!image) return;

            if (!confirm("確定要刪除這張圖片嗎？")) return;

            try {
              // TODO: 實現刪除 API
              // const response = await authenticatedFetch(`/api/food/images/${image.id}`, {
              //   method: "DELETE",
              // });
              
              foodImages.splice(index, 1);
              updateFoodImagesPreview();
              updateFoodRecognitionResults();
            } catch (error) {
              console.error("刪除食物圖片失敗:", error);
              alert("刪除失敗，請重試");
            }
          };
        } // 結束食物圖片功能的 if 檢查

        // 上傳賬單功能已註釋（通過保存賬單自動上傳收據）
        /*
        const uploadBillBtn = document.getElementById("upload-bill-btn");
        if (uploadBillBtn) {
          uploadBillBtn.addEventListener("click", () => {
            alert("上傳賬單功能即將推出");
          });
        }
        */

        // 保存結果功能
        saveResultBtn.addEventListener("click", async () => {
          // 防止重複提交
          if (saveResultBtn.disabled) {
            return;
          }

          try {
            // 禁用按鈕防止重複提交
            saveResultBtn.disabled = true;
            saveResultBtn.innerHTML =
              '<i class="fa fa-spinner fa-spin mr-2"></i> 保存中...';
            
            let savedBillId = null;

            // 驗證付款人
            const payerId = billPayerSelect.value;
            if (!payerId || payerId.trim() === "") {
              alert("請先選擇付款人後再保存賬單");
              billPayerSelect.focus();
              // 恢復按鈕狀態
              saveResultBtn.disabled = false;
              saveResultBtn.innerHTML =
                '<i class="fa fa-save mr-2"></i> 保存賬單';
              return;
            }

            // 驗證付款人是否在參與者列表中
            const participantCards = participantsContainer.querySelectorAll(
              ".participant-card:not(.add-card)"
            );
            const participantIds = Array.from(participantCards)
              .map((card) => card.dataset.participantId)
              .filter((id) => id);

            if (!participantIds.includes(payerId)) {
              alert("付款人必須是參與者之一，請重新選擇");
              billPayerSelect.focus();
              // 恢復按鈕狀態
              saveResultBtn.disabled = false;
              saveResultBtn.innerHTML =
                '<i class="fa fa-save mr-2"></i> 保存賬單';
              return;
            }

            // 首先保存賬單
            const response = await authenticatedFetch("/api/bill/save", {
              method: "POST",
            });

            if (!response) return; // 認證失敗，已重定向

            if (response.ok) {
              const data = await response.json();
              const billId = data.billId;

              // 如果付款人上傳了收據，上傳收據圖片
              if (payerReceiptFiles.length > 0 && billId) {
                let uploadedCount = 0;
                let failedCount = 0;

                for (let i = 0; i < payerReceiptFiles.length; i++) {
                  const file = payerReceiptFiles[i];
                  const formData = new FormData();
                  formData.append("receipt", file);
                  formData.append("billId", billId);
                  formData.append("type", "payer");
                  formData.append("index", i.toString());

                  try {
                    const uploadResponse = await fetch("/api/receipt/upload", {
                      method: "POST",
                      headers: {
                        Authorization: `Bearer ${localStorage.getItem(
                          "sessionId"
                        )}`,
                      },
                      body: formData,
                    });

                    if (uploadResponse.ok) {
                      uploadedCount++;
                    } else {
                      failedCount++;
                      console.error(
                        `圖片 ${i + 1} 上傳失敗:`,
                        await uploadResponse.text()
                      );
                    }
                  } catch (error) {
                    failedCount++;
                    console.error(`圖片 ${i + 1} 上傳錯誤:`, error);
                  }
                }

                if (uploadedCount > 0 && failedCount === 0) {
                  alert(
                    `賬單已保存（ID: ${billId}），${uploadedCount}張付款憑證已上傳`
                  );
                } else if (uploadedCount > 0 && failedCount > 0) {
                  alert(
                    `賬單已保存（ID: ${billId}），${uploadedCount}張上傳成功，${failedCount}張失敗`
                  );
                } else {
                  alert(`賬單已保存（ID: ${billId}），但所有付款憑證上傳失敗`);
                }

                // 清空上傳狀態
                payerReceiptFiles = [];
                payerReceiptInput.value = "";
                receiptFileCount.textContent = "";
                receiptPreviewContainer.innerHTML = "";
                receiptPreviewContainer.style.display = "none";
              } else {
                alert(`賬單已保存（ID: ${billId}）`);
              }

              // 上傳臨時存儲的食物圖片（如果有的話）
              // 等待一小段時間確保訂單已完全保存到數據庫
              if (billId && pendingFoodImages.length > 0) {
                // 等待 100ms 確保數據庫操作完成
                await new Promise(resolve => setTimeout(resolve, 100));
                
                let uploadedCount = 0;
                let failedCount = 0;

                for (let i = 0; i < pendingFoodImages.length; i++) {
                  const tempImage = pendingFoodImages[i];
                  try {
                    const formData = new FormData();
                    formData.append("foodImage", tempImage.file);
                    formData.append("billId", billId);

                    const response = await authenticatedFetch("/api/food/upload", {
                      method: "POST",
                      body: formData,
                    });

                    if (response && response.ok) {
                      const data = await response.json();
                      foodImages.push(data.image);
                      uploadedCount++;
                    } else {
                      const errorData = await response.json().catch(() => ({}));
                      console.error(`臨時圖片 ${i + 1} 上傳失敗:`, errorData.error || "未知錯誤");
                      failedCount++;
                    }
                  } catch (error) {
                    console.error(`臨時圖片 ${i + 1} 上傳失敗:`, error);
                    failedCount++;
                  }
                }

                // 清空臨時圖片列表
                pendingFoodImages = [];
                updateFoodImagesPreview();

                if (uploadedCount > 0) {
                  console.log(`${uploadedCount} 張臨時圖片已上傳`);
                }
                if (failedCount > 0) {
                  console.warn(`${failedCount} 張臨時圖片上傳失敗`);
                }
              }

              // 加載食物圖片（如果已上傳）
              if (billId) {
                loadFoodImages(billId);
                
                // 啟動輪詢，定期檢查識別結果（每 5 秒檢查一次，持續 2 分鐘）
                let pollCount = 0;
                const maxPolls = 24; // 2 分鐘 = 120 秒，每 5 秒一次 = 24 次
                const pollInterval = setInterval(async () => {
                  pollCount++;
                  try {
                    await loadFoodImages(billId);
                    // 檢查是否所有圖片都已識別完成
                    const allRecognized = foodImages.every(
                      (img) => img.recognitionStatus === 2 || img.recognitionStatus === 3
                    );
                    if (allRecognized || pollCount >= maxPolls) {
                      clearInterval(pollInterval);
                      if (allRecognized) {
                        console.log("所有食物圖片識別完成");
                      }
                    }
                  } catch (error) {
                    console.error("輪詢識別結果失敗:", error);
                  }
                }, 5000); // 每 5 秒檢查一次
              }

              // 提交成功後自動關閉彈窗
              closeResultModal();
            } else {
              const errorData = await response.json();
              alert(`保存失敗: ${errorData.error}`);
            }
          } catch (error) {
            console.error("Error saving result:", error);
            alert("保存賬單時出錯");
          } finally {
            // 恢復按鈕狀態
            saveResultBtn.disabled = false;
            saveResultBtn.innerHTML =
              '<i class="fa fa-save mr-2"></i> 保存賬單';
          }
        });

        // 添加消費項目的功能
        addItemBtn.addEventListener("click", () => {
          const itemCard = document.createElement("div");
          itemCard.className =
            "item-card bg-light rounded-lg p-6 transform transition-all duration-300 opacity-0 translate-y-2";
          itemCard.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-gray-700 font-medium mb-2">項目名稱</label>
              <input type="text" class="item-name w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-all duration-300" placeholder="例如：漢堡套餐">
            </div>
            <div>
              <label class="block text-gray-700 font-medium mb-2">金額 (HKD)</label>
              <input type="number" class="item-amount w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-all duration-300" placeholder="0.00" step="0.01">
            </div>
          </div>
          <div class="mb-4">
            <label class="flex items-center">
              <input type="checkbox" class="item-is-shared mr-2" checked>
              <span class="text-gray-700">共享項目（所有參與者分攤）</span>
            </label>
          </div>
          <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">參與者</label>
            <div class="participants-selection flex flex-wrap gap-2">
              <!-- 參與者選擇標籤將通過JS動態生成 -->
            </div>
          </div>
          <div class="flex justify-end">
            <button class="remove-item-btn text-red-500 hover:text-red-700 transition-colors">
              <i class="fa fa-trash mr-1"></i> 刪除項目
            </button>
          </div>
        `;

          itemsContainer.appendChild(itemCard);

          // 觸發動畫
          setTimeout(() => {
            itemCard.classList.remove("opacity-0", "translate-y-2");
          }, 10);

          // 獲取參與者選擇容器
          const participantsSelection = itemCard.querySelector(
            ".participants-selection"
          );

          // 更新參與者選擇標籤（只更新新添加的項目）
          updateParticipantTagsForSelection(participantsSelection);

          // 綁定刪除按鈕事件
          itemCard
            .querySelector(".remove-item-btn")
            .addEventListener("click", () => {
              itemCard.classList.add("opacity-0", "translate-y-2");
              setTimeout(() => {
                itemCard.remove();
              }, 300);
            });

          // 綁定共享項目切換事件
          const isSharedCheckbox = itemCard.querySelector(".item-is-shared");

          isSharedCheckbox.addEventListener("change", () => {
            if (isSharedCheckbox.checked) {
              participantsSelection.style.display = "none";
            } else {
              participantsSelection.style.display = "block";
              // 只更新當前項目的參與者標籤，不影響其他項目
              updateParticipantTagsForSelection(participantsSelection);
            }
          });
        });

        // 更新付款人選擇框
        function updatePayerSelect() {
          const participantCards = participantsContainer.querySelectorAll(
            ".participant-card:not(.add-card)"
          );
          const participants = Array.from(participantCards)
            .map((card) => {
              const name = card.dataset.participantName;
              const id = card.dataset.participantId;
              if (!name || name.length === 0 || !id) return null;
              return { name, id };
            })
            .filter((p) => p !== null);

          // 保存當前選擇
          const currentPayerId = billPayerSelect.value;

          // 清空並重新填充選項
          billPayerSelect.innerHTML =
            '<option value="">請選擇付款人（必選）</option>';

          participants.forEach((participant) => {
            const option = document.createElement("option");
            option.value = participant.id;
            option.textContent = participant.name;
            if (participant.id === currentPayerId) {
              option.selected = true;
            }
            billPayerSelect.appendChild(option);
          });
        }

        // 更新參與者選擇標籤的函數
        function updateParticipantTags() {
          const participantCards = participantsContainer.querySelectorAll(
            ".participant-card:not(.add-card)"
          );
          const participants = Array.from(participantCards)
            .map((card) => {
              const name = card.dataset.participantName;
              const id = card.dataset.participantId;
              // 必須同時有ID和名稱
              if (!name || name.length === 0 || !id) return null;
              return { name, id };
            })
            .filter((p) => p !== null);

          // 更新所有項目卡片中的參與者選擇
          document
            .querySelectorAll(".participants-selection")
            .forEach((selection) => {
              // 保存當前選中的參與者ID
              const selectedIds = new Set();
              selection
                .querySelectorAll(".person-tag.bg-primary")
                .forEach((tag) => {
                  selectedIds.add(tag.dataset.participantId);
                });

              // 清空並重新創建標籤
              selection.innerHTML = "";
              participants.forEach((participant) => {
                const tag = document.createElement("span");
                const isSelected = selectedIds.has(participant.id);
                tag.className = isSelected
                  ? "person-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-primary text-white cursor-pointer hover:bg-primary/80 transition-colors"
                  : "person-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-primary/10 text-primary cursor-pointer hover:bg-primary/20 transition-colors";
                tag.textContent = participant.name;
                tag.dataset.participantId = participant.id;
                tag.dataset.participantName = participant.name;
                selection.appendChild(tag);

                // 綁定點擊事件來切換選擇狀態
                tag.addEventListener("click", () => {
                  tag.classList.toggle("bg-primary");
                  tag.classList.toggle("text-white");
                  tag.classList.toggle("bg-primary/10");
                  tag.classList.toggle("text-primary");
                });
              });
            });
        }

        // 更新特定選擇容器的參與者標籤
        function updateParticipantTagsForSelection(selection) {
          const participantCards = participantsContainer.querySelectorAll(
            ".participant-card:not(.add-card)"
          );
          const participants = Array.from(participantCards)
            .map((card) => {
              const name = card.dataset.participantName;
              const id = card.dataset.participantId;
              // 必須同時有ID和名稱
              if (!name || name.length === 0 || !id) return null;
              return { name, id };
            })
            .filter((p) => p !== null);

          // 保存當前選中的參與者ID
          const selectedIds = new Set();
          selection
            .querySelectorAll(".person-tag.bg-primary")
            .forEach((tag) => {
              selectedIds.add(tag.dataset.participantId);
            });

          // 清空並重新創建標籤
          selection.innerHTML = "";
          participants.forEach((participant) => {
            const tag = document.createElement("span");
            const isSelected = selectedIds.has(participant.id);
            tag.className = isSelected
              ? "person-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-primary text-white cursor-pointer hover:bg-primary/80 transition-colors"
              : "person-tag inline-flex items-center px-3 py-1 rounded-full text-sm bg-primary/10 text-primary cursor-pointer hover:bg-primary/20 transition-colors";
            tag.textContent = participant.name;
            tag.dataset.participantId = participant.id;
            tag.dataset.participantName = participant.name;
            selection.appendChild(tag);

            // 綁定點擊事件來切換選擇狀態
            tag.addEventListener("click", () => {
              tag.classList.toggle("bg-primary");
              tag.classList.toggle("text-white");
              tag.classList.toggle("bg-primary/10");
              tag.classList.toggle("text-primary");
            });
          });
        }

        // 用戶搜尋功能
        let isAddingNewParticipant = false; // 標記是否在添加新參與者
        const userSearchModal = document.getElementById("user-search-modal");
        const closeUserSearchBtn = document.getElementById(
          "close-user-search-btn"
        );
        const userSearchInput = document.getElementById("user-search-input");
        const userSearchResults = document.getElementById(
          "user-search-results"
        );
        const addSelfBtn = document.getElementById("add-self-btn");

        // 打開用戶搜尋彈窗（用於添加新參與者）
        function openUserSearchForNewParticipant() {
          isAddingNewParticipant = true;

          userSearchModal.classList.remove("opacity-0", "invisible");
          userSearchModal
            .querySelector(".bg-white")
            .classList.remove("scale-95");
          userSearchModal.querySelector(".bg-white").classList.add("scale-100");
          userSearchInput.focus();
          userSearchInput.value = "";
          userSearchResults.innerHTML = "";
        }

        // 關閉用戶搜尋彈窗
        function closeUserSearch() {
          userSearchModal.classList.add("opacity-0", "invisible");
          userSearchModal.querySelector(".bg-white").classList.add("scale-95");
          userSearchModal
            .querySelector(".bg-white")
            .classList.remove("scale-100");
          isAddingNewParticipant = false;
        }

        // 搜尋用戶
        async function searchUsers(query) {
          if (!query || query.length < 1) {
            userSearchResults.innerHTML = "";
            return;
          }

          try {
            const response = await authenticatedFetch(
              `/api/users/search?query=${encodeURIComponent(query)}`
            );
            if (!response) return;

            const data = await response.json();
            displaySearchResults(data.users);
          } catch (error) {
            console.error("搜尋用戶失敗:", error);
          }
        }

        // 顯示搜尋結果
        function displaySearchResults(users) {
          userSearchResults.innerHTML = "";

          if (users.length === 0) {
            userSearchResults.innerHTML =
              '<div class="text-gray-500 text-center py-4">沒有找到匹配的用戶</div>';
            return;
          }

          users.forEach((user) => {
            const userItem = document.createElement("div");
            userItem.className =
              "user-result-item flex items-center justify-between p-3 border border-gray-200 rounded-lg mb-2 hover:bg-primary/5 hover:border-primary cursor-pointer transition-all";
            userItem.dataset.userId = user.id;
            userItem.dataset.userName = user.username;
            userItem.innerHTML = `
            <div class="flex-1">
              <div class="font-medium">${escapeHtml(user.username)}</div>
              <div class="text-sm text-gray-500">${escapeHtml(user.email)}</div>
            </div>
            <div class="text-primary">
              <i class="fa fa-plus-circle text-xl"></i>
            </div>
          `;
            userSearchResults.appendChild(userItem);
          });
        }

        // 添加用戶為參與者
        async function addUserAsParticipant(userId, userName) {
          try {
            // 檢查是否已經存在此參與者
            const existingCards = participantsContainer.querySelectorAll(
              ".participant-card:not(.add-card)"
            );
            const exists = Array.from(existingCards).some(
              (card) => card.dataset.participantName === userName
            );

            if (exists) {
              alert("此參與者已存在");
              closeUserSearch();
              return;
            }

            const response = await authenticatedFetch("/api/participant", {
              method: "POST",
              body: JSON.stringify({ name: userName }),
            });

            if (!response) return;

            if (response.ok) {
              const participant = await response.json();

              // 創建參與者卡片
              createParticipantCard(participant.id, participant.name);

              closeUserSearch();
            }
          } catch (error) {
            console.error("添加參與者失敗:", error);
            alert("添加參與者失敗，請重試");
          }
        }

        // 添加自己為參與者
        async function addSelfAsParticipant() {
          const currentUser = authManager.getCurrentUser();
          if (currentUser) {
            await addUserAsParticipant(currentUser.id, currentUser.username);
          }
        }

        // 事件監聽器
        closeUserSearchBtn.addEventListener("click", closeUserSearch);

        userSearchModal.addEventListener("click", (e) => {
          if (e.target === userSearchModal) {
            closeUserSearch();
          }
        });

        userSearchInput.addEventListener("input", (e) => {
          searchUsers(e.target.value);
        });

        addSelfBtn.addEventListener("click", addSelfAsParticipant);

        userSearchResults.addEventListener("click", (e) => {
          const userItem = e.target.closest(".user-result-item");
          if (userItem) {
            const userId = userItem.dataset.userId;
            const userName = userItem.dataset.userName;
            addUserAsParticipant(userId, userName);
          }
        });

        // 為所有參與者頭像添加點擊事件
        document.addEventListener("click", (e) => {
          if (e.target.closest(".user-avatar-btn")) {
            const participantItem = e.target.closest(".participant-item");
            openUserSearch(participantItem);
          }
        });

        // 列印為JPG功能
        const printToJpgBtn = document.getElementById("print-to-jpg-btn");
        if (printToJpgBtn) {
          printToJpgBtn.addEventListener("click", async () => {
            try {
              const modalContent = resultModal.querySelector(".bg-white");
              if (!modalContent) {
                alert("沒有找到要列印的內容");
                return;
              }

              // 使用html2canvas截圖
              const canvas = await html2canvas(modalContent, {
                backgroundColor: "#ffffff",
                scale: 2,
                useCORS: true,
                allowTaint: true,
              });

              // 轉換為JPG並下載
              const link = document.createElement("a");
              link.download = `賬單報告_${
                new Date().toISOString().split("T")[0]
              }.jpg`;
              link.href = canvas.toDataURL("image/jpeg", 0.9);
              link.click();
            } catch (error) {
              console.error("列印失敗:", error);
              alert("列印失敗，請稍後再試");
            }
          });
        }

        // 初始化時添加一個項目輸入框
        setTimeout(() => {
          // 添加初始項目
          addItemBtn.click();
        }, 500); // 延遲以確保默認參與者已加載
      });
    </script>
  </body>
</html>
