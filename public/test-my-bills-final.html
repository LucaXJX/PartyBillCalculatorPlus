<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æˆ‘çš„è³¬å–®é é¢å®Œæ•´æ¸¬è©¦ - æœ€çµ‚ç‰ˆV2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <style>
      .test-pass { color: #10b981; }
      .test-fail { color: #ef4444; }
      .test-warn { color: #f59e0b; }
      .test-info { color: #3b82f6; }
      .section-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1.5rem 0 1rem 0;
        font-weight: bold;
      }
    </style>
  </head>
  <body class="bg-gray-100 p-8">
    <div class="max-w-7xl mx-auto">
      <div class="mb-6">
        <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
          <i class="fas fa-clipboard-check mr-2 text-purple-600"></i>æˆ‘çš„è³¬å–®é é¢å®Œæ•´æ¸¬è©¦ï¼ˆæœ€çµ‚ç‰ˆV2ï¼‰
        </h1>
        <p class="text-gray-600 text-lg">
          å…¨é¢é©—è­‰æ‰€æœ‰åŠŸèƒ½ï¼šçµ±è¨ˆã€ç¯©é¸ã€ç‹€æ…‹æ›´æ–°ã€æ‡‰æ”¶æ¬¾ã€æ‡‰ä»˜æ¬¾ã€ç¢ºèªæ”¶æ¬¾ã€æ‹’çµ•æ”¶æ¬¾
        </p>
      </div>

      <!-- æ§åˆ¶é¢æ¿ -->
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <div class="flex flex-wrap items-center gap-4 mb-4">
          <button
            id="run-all-tests"
            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 shadow-md transition-all"
          >
            <i class="fas fa-play mr-2"></i>é‹è¡Œå®Œæ•´æ¸¬è©¦
          </button>
          <button
            id="clear-results"
            class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 shadow-md transition-all"
          >
            <i class="fas fa-eraser mr-2"></i>æ¸…é™¤çµæœ
          </button>
          <button
            id="export-results"
            class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 shadow-md transition-all"
          >
            <i class="fas fa-download mr-2"></i>å°å‡ºå ±å‘Š
          </button>
          <a
            href="/my-bills.html"
            target="_blank"
            class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 shadow-md transition-all"
          >
            <i class="fas fa-external-link-alt mr-2"></i>æ‰“é–‹æˆ‘çš„è³¬å–®
          </a>
        </div>

        <!-- çµ±è¨ˆä¿¡æ¯ -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-6">
          <div class="bg-green-50 p-4 rounded-lg border-2 border-green-200">
            <div class="text-sm text-gray-600 mb-1">é€šé</div>
            <div class="text-3xl font-bold text-green-600" id="pass-count">0</div>
          </div>
          <div class="bg-red-50 p-4 rounded-lg border-2 border-red-200">
            <div class="text-sm text-gray-600 mb-1">å¤±æ•—</div>
            <div class="text-3xl font-bold text-red-600" id="fail-count">0</div>
          </div>
          <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-200">
            <div class="text-sm text-gray-600 mb-1">è­¦å‘Š</div>
            <div class="text-3xl font-bold text-yellow-600" id="warn-count">0</div>
          </div>
          <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
            <div class="text-sm text-gray-600 mb-1">ä¿¡æ¯</div>
            <div class="text-3xl font-bold text-blue-600" id="info-count">0</div>
          </div>
          <div class="bg-gray-50 p-4 rounded-lg border-2 border-gray-200">
            <div class="text-sm text-gray-600 mb-1">ç¸½è¨ˆ</div>
            <div class="text-3xl font-bold text-gray-600" id="total-count">0</div>
          </div>
        </div>

        <!-- é€²åº¦æ¢ -->
        <div class="mt-4">
          <div class="flex justify-between text-sm text-gray-600 mb-1">
            <span id="progress-text">æº–å‚™æ¸¬è©¦...</span>
            <span id="progress-percent">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div id="progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>
      </div>

      <!-- æ¸¬è©¦çµæœ -->
      <div id="test-results" class="space-y-4"></div>
    </div>

    <script type="module">
      let testResults = [];
      let stats = { pass: 0, fail: 0, warn: 0, info: 0, total: 0 };
      let testBills = null;
      let currentUser = null;
      let totalTests = 0;
      let completedTests = 0;

      // èªè­‰ fetch
      async function authenticatedFetch(url, options = {}) {
        const sessionId = localStorage.getItem("sessionId");
        if (!sessionId) throw new Error("æœªç™»å…¥");

        const headers = {
          ...options.headers,
          Authorization: `Bearer ${sessionId}`,
        };

        if (!(options.body instanceof FormData)) {
          headers["Content-Type"] = "application/json";
        }

        const response = await fetch(url, { ...options, headers });
        if (response.status === 401) throw new Error("èªè­‰å¤±æ•—");
        return response;
      }

      // æ›´æ–°é€²åº¦
      function updateProgress(text, percent) {
        document.getElementById("progress-text").textContent = text;
        document.getElementById("progress-percent").textContent = `${percent}%`;
        document.getElementById("progress-bar").style.width = `${percent}%`;
      }

      // æ·»åŠ æ¸¬è©¦çµæœ
      function addResult(category, name, status, message, details = null) {
        const result = {
          timestamp: new Date().toISOString(),
          category,
          name,
          status,
          message,
          details,
        };
        testResults.push(result);
        stats.total++;
        if (stats[status] !== undefined) stats[status]++;
        updateStats();
        renderResult(result);
        
        completedTests++;
        const percent = Math.round((completedTests / totalTests) * 100);
        updateProgress(`æ­£åœ¨æ¸¬è©¦... (${completedTests}/${totalTests})`, percent);
      }

      function updateStats() {
        document.getElementById("pass-count").textContent = stats.pass;
        document.getElementById("fail-count").textContent = stats.fail;
        document.getElementById("warn-count").textContent = stats.warn;
        document.getElementById("info-count").textContent = stats.info;
        document.getElementById("total-count").textContent = stats.total;
      }

      function renderResult(result) {
        const container = document.getElementById("test-results");
        const statusIcons = {
          pass: '<i class="fas fa-check-circle test-pass"></i>',
          fail: '<i class="fas fa-times-circle test-fail"></i>',
          warn: '<i class="fas fa-exclamation-triangle test-warn"></i>',
          info: '<i class="fas fa-info-circle test-info"></i>',
        };

        const statusClasses = {
          pass: "bg-green-50 border-l-4 border-green-500",
          fail: "bg-red-50 border-l-4 border-red-500",
          warn: "bg-yellow-50 border-l-4 border-yellow-500",
          info: "bg-blue-50 border-l-4 border-blue-500",
        };

        const div = document.createElement("div");
        div.className = `p-4 rounded shadow-sm ${statusClasses[result.status]}`;
        div.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="text-2xl">${statusIcons[result.status]}</div>
            <div class="flex-1">
              <div class="font-bold text-lg mb-1">[${result.category}] ${result.name}</div>
              <div class="text-sm text-gray-700 whitespace-pre-wrap">${result.message}</div>
              ${
                result.details
                  ? `<details class="mt-2">
                      <summary class="cursor-pointer text-xs text-gray-500 hover:text-gray-700">æŸ¥çœ‹è©³ç´°æ•¸æ“š</summary>
                      <pre class="mt-2 text-xs bg-white p-3 rounded overflow-auto max-h-60 border">${JSON.stringify(
                        result.details,
                        null,
                        2
                      )}</pre>
                    </details>`
                  : ""
              }
            </div>
          </div>
        `;
        container.appendChild(div);
        div.scrollIntoView({ behavior: "smooth", block: "nearest" });
      }

      // æ¸¬è©¦ 1: åˆå§‹åŒ–å’Œè³¬å–®ç²å–
      async function testInitialization() {
        addResult("ğŸ” åˆå§‹åŒ–", "é–‹å§‹æ¸¬è©¦", "info", "æª¢æŸ¥èªè­‰å’Œè³¬å–®æ•¸æ“š...");

        const sessionId = localStorage.getItem("sessionId");
        const userStr = localStorage.getItem("user");

        if (!sessionId || !userStr) {
          addResult("ğŸ” åˆå§‹åŒ–", "èªè­‰ç‹€æ…‹", "fail", "æœªç™»å…¥ - è«‹å…ˆç™»å…¥testuserè³¬æˆ¶");
          return false;
        }

        currentUser = JSON.parse(userStr);
        addResult("ğŸ” åˆå§‹åŒ–", "èªè­‰ç‹€æ…‹", "pass", `å·²ç™»å…¥: ${currentUser.username} (${currentUser.email})`);

        try {
          const response = await authenticatedFetch("/api/bills");
          const data = await response.json();
          testBills = data.bills || data;

          if (testBills.length === 0) {
            addResult("ğŸ” åˆå§‹åŒ–", "è³¬å–®æ•¸æ“š", "warn", "æ²’æœ‰è³¬å–®æ•¸æ“š - è«‹å…ˆå‰µå»ºä¸€äº›æ¸¬è©¦è³¬å–®");
            return false;
          }

          addResult("ğŸ” åˆå§‹åŒ–", "è³¬å–®æ•¸æ“š", "pass", `æˆåŠŸç²å– ${testBills.length} å€‹è³¬å–®`);
          return true;
        } catch (error) {
          addResult("ğŸ” åˆå§‹åŒ–", "è³¬å–®æ•¸æ“š", "fail", `ç²å–å¤±æ•—: ${error.message}`);
          return false;
        }
      }

      // æ¸¬è©¦ 2: çµ±è¨ˆæ•¸æ“šè¨ˆç®—
      async function testStatisticsCalculation() {
        addResult("ğŸ“Š çµ±è¨ˆè¨ˆç®—", "é–‹å§‹è¨ˆç®—", "info", "é©—è­‰çµ±è¨ˆæ•¸æ“šè¨ˆç®—é‚è¼¯...");

        let myPending = 0, myPaid = 0;
        let receivablesPending = 0, receivablesPaid = 0;
        let receivablesPendingCount = 0, receivablesPaidCount = 0;
        let totalPayables = 0, payablesCount = 0;

        testBills.forEach((bill) => {
          const userParticipant = bill.participants.find((p) => p.name === currentUser.username);
          if (!userParticipant) return;

          const userResult = (bill.results || []).find((r) => r.participantId === userParticipant.id);
          const isPayer = bill.payerId === userParticipant.id;
          const userAmount = userResult ? userResult.amount : 0;

          if (isPayer) {
            const otherResults = bill.results?.filter((r) => r.participantId !== userParticipant.id) || [];
            otherResults.forEach((r) => {
              if (r.paymentStatus === "pending") {
                receivablesPending += r.amount || 0;
                receivablesPendingCount++;
              } else if (r.paymentStatus === "paid") {
                receivablesPaid += r.amount || 0;
                receivablesPaidCount++;
              }
            });
          } else {
            if (userResult) {
              if (userResult.paymentStatus === "pending") {
                myPending++;
              } else {
                myPaid++;
              }
              totalPayables += userAmount;
              payablesCount++;
            }
          }
        });

        const calculatedStats = {
          totalBills: testBills.length,
          myPending,
          myPaid,
          receivablesPendingCount,
          receivablesPaidCount,
          receivablesPending: receivablesPending.toFixed(2),
          receivablesPaid: receivablesPaid.toFixed(2),
          totalReceivables: (receivablesPending + receivablesPaid).toFixed(2),
          totalPayables: totalPayables.toFixed(2),
          payablesCount,
        };

        addResult("ğŸ“Š çµ±è¨ˆè¨ˆç®—", "è¨ˆç®—çµæœ", "pass", 
          `ç¸½è³¬å–®: ${calculatedStats.totalBills}\n` +
          `å¾…æ”¯ä»˜: ${calculatedStats.myPending} | å·²æ”¯ä»˜: ${calculatedStats.myPaid}\n` +
          `æ‡‰æ”¶æ¬¾: ${calculatedStats.receivablesPendingCount}ç­† ($${calculatedStats.receivablesPending})\n` +
          `å·²æ”¶æ¬¾: ${calculatedStats.receivablesPaidCount}ç­† ($${calculatedStats.receivablesPaid})\n` +
          `ç¸½æ‡‰æ”¶: $${calculatedStats.totalReceivables} | ç¸½æ‡‰ä»˜: $${calculatedStats.totalPayables}`,
          calculatedStats
        );

        // é‚è¼¯é©—è­‰
        const totalParticipantBills = myPending + myPaid;
        if (totalParticipantBills > testBills.length) {
          addResult("ğŸ“Š çµ±è¨ˆè¨ˆç®—", "é‚è¼¯é©—è­‰", "fail", "åƒèˆ‡è€…è³¬å–®æ•¸è¶…éç¸½è³¬å–®æ•¸!");
        } else {
          addResult("ğŸ“Š çµ±è¨ˆè¨ˆç®—", "é‚è¼¯é©—è­‰", "pass", `åƒèˆ‡è€…è³¬å–®: ${totalParticipantBills} â‰¤ ç¸½è³¬å–®: ${testBills.length}`);
        }

        return calculatedStats;
      }

      // æ¸¬è©¦ 3: è³¬å–®åˆ†é¡
      async function testBillClassification() {
        addResult("ğŸ·ï¸ è³¬å–®åˆ†é¡", "é–‹å§‹åˆ†æ", "info", "åˆ†æè³¬å–®è§’è‰²å’Œç‹€æ…‹...");

        let payerBills = [];
        let participantBills = [];
        let pendingPayables = [];
        let paidPayables = [];
        let billsWithoutUser = 0;

        testBills.forEach((bill) => {
          const userParticipant = bill.participants.find((p) => p.name === currentUser.username);
          
          if (!userParticipant) {
            billsWithoutUser++;
            return;
          }

          const isPayer = bill.payerId === userParticipant.id;
          const userResult = bill.results?.find((r) => r.participantId === userParticipant.id);

          if (isPayer) {
            payerBills.push(bill);
          } else {
            participantBills.push(bill);
            if (userResult) {
              if (userResult.paymentStatus === "pending") {
                pendingPayables.push(bill);
              } else {
                paidPayables.push(bill);
              }
            }
          }
        });

        addResult("ğŸ·ï¸ è³¬å–®åˆ†é¡", "è§’è‰²åˆ†é¡", "pass",
          `ä»˜æ¬¾äºº: ${payerBills.length}å€‹ | åƒèˆ‡è€…: ${participantBills.length}å€‹\n` +
          `ä¸åŒ…å«ç”¨æˆ¶: ${billsWithoutUser}å€‹`
        );

        addResult("ğŸ·ï¸ è³¬å–®åˆ†é¡", "æ”¯ä»˜ç‹€æ…‹", "pass",
          `å¾…æ”¯ä»˜: ${pendingPayables.length}å€‹ | å·²æ”¯ä»˜: ${paidPayables.length}å€‹`
        );

        return { payerBills, participantBills, pendingPayables, paidPayables };
      }

      // æ¸¬è©¦ 4: API ç«¯é»åŠŸèƒ½
      async function testAPIEndpoints() {
        addResult("ğŸ”Œ APIæ¸¬è©¦", "é–‹å§‹æ¸¬è©¦", "info", "æ¸¬è©¦æ‰€æœ‰ç›¸é—œAPIç«¯é»...");

        const endpoints = [
          { path: "/api/me", name: "ç”¨æˆ¶ä¿¡æ¯" },
          { path: "/api/bills", name: "è³¬å–®åˆ—è¡¨" },
        ];

        for (const endpoint of endpoints) {
          try {
            const response = await authenticatedFetch(endpoint.path);
            if (response.ok) {
              addResult("ğŸ”Œ APIæ¸¬è©¦", endpoint.name, "pass", `${endpoint.path} - æ­£å¸¸`);
            } else {
              addResult("ğŸ”Œ APIæ¸¬è©¦", endpoint.name, "fail", `${endpoint.path} - ç‹€æ…‹ç¢¼: ${response.status}`);
            }
          } catch (error) {
            addResult("ğŸ”Œ APIæ¸¬è©¦", endpoint.name, "fail", `${endpoint.path} - ${error.message}`);
          }
        }
      }

      // æ¸¬è©¦ 5: æ”¯ä»˜ç‹€æ…‹æ›´æ–°åŠŸèƒ½
      async function testPaymentStatusUpdate(classification) {
        addResult("ğŸ’³ æ”¯ä»˜ç‹€æ…‹", "é–‹å§‹æ¸¬è©¦", "info", "æ¸¬è©¦æ”¯ä»˜ç‹€æ…‹æ›´æ–°åŠŸèƒ½...");

        if (classification.pendingPayables.length === 0) {
          addResult("ğŸ’³ æ”¯ä»˜ç‹€æ…‹", "æ¸¬è©¦æ¡ˆä¾‹", "warn", "æ²’æœ‰å¾…æ”¯ä»˜çš„è³¬å–®å¯æ¸¬è©¦");
          return;
        }

        const testBill = classification.pendingPayables[0];
        const userParticipant = testBill.participants.find((p) => p.name === currentUser.username);

        addResult("ğŸ’³ æ”¯ä»˜ç‹€æ…‹", "é¸æ“‡æ¡ˆä¾‹", "info",
          `è³¬å–®: ${testBill.name || '(ç„¡åç¨±)'}\né‡‘é¡: $${userParticipant ? testBill.results?.find(r => r.participantId === userParticipant.id)?.amount : 0}`,
          { billId: testBill.id, participantId: userParticipant.id }
        );

        try {
          const formData = new FormData();
          formData.append("billId", testBill.id);
          formData.append("participantId", userParticipant.id);
          formData.append("paymentStatus", "pending");

          const response = await authenticatedFetch("/api/bill/payment-status", {
            method: "POST",
            body: formData,
          });

          if (response.ok) {
            addResult("ğŸ’³ æ”¯ä»˜ç‹€æ…‹", "APIç«¯é»", "pass", "æ”¯ä»˜ç‹€æ…‹æ›´æ–°APIæ­£å¸¸é‹ä½œ");
            addResult("ğŸ’³ æ”¯ä»˜ç‹€æ…‹", "åŠŸèƒ½æ¸…å–®", "info",
              "âœ… æ›´æ–°æ”¯ä»˜ç‹€æ…‹ (pending/paid)\n" +
              "âœ… ä¸Šå‚³æ”¶æ“šåœ–ç‰‡ (æœ€å¤š6å¼µ)\n" +
              "âœ… è‡ªå‹•è¨­ç½®æ”¯ä»˜æ™‚é–“\n" +
              "âœ… å¯¦æ™‚ä¿å­˜åˆ°æ•¸æ“šæ–‡ä»¶"
            );
          } else {
            const error = await response.json();
            addResult("ğŸ’³ æ”¯ä»˜ç‹€æ…‹", "APIç«¯é»", "fail", `APIéŒ¯èª¤: ${response.status}`, error);
          }
        } catch (error) {
          addResult("ğŸ’³ æ”¯ä»˜ç‹€æ…‹", "APIç«¯é»", "fail", error.message);
        }
      }

      // æ¸¬è©¦ 6: æ‡‰æ”¶æ¬¾åŠŸèƒ½ï¼ˆåŒ…æ‹¬ç¢ºèªå’Œæ‹’çµ•ï¼‰
      async function testReceivables(classification) {
        addResult("ğŸ’° æ‡‰æ”¶æ¬¾", "é–‹å§‹æ¸¬è©¦", "info", "æ¸¬è©¦æ‡‰æ”¶æ¬¾ç›¸é—œåŠŸèƒ½...");

        if (classification.payerBills.length === 0) {
          addResult("ğŸ’° æ‡‰æ”¶æ¬¾", "æ¸¬è©¦æ¡ˆä¾‹", "warn", "æ²’æœ‰ä»˜æ¬¾äººè³¬å–®å¯æ¸¬è©¦");
          return;
        }

        addResult("ğŸ’° æ‡‰æ”¶æ¬¾", "ä»˜æ¬¾äººè³¬å–®", "pass", `æ‰¾åˆ° ${classification.payerBills.length} å€‹ä»˜æ¬¾äººè³¬å–®`);

        // è¨ˆç®—æ‡‰æ”¶æ¬¾çµ±è¨ˆ
        let totalReceivablesPending = 0;
        let totalReceivablesPaid = 0;
        let pendingCount = 0;
        let paidCount = 0;
        let confirmedCount = 0;
        let unconfirmedCount = 0;

        classification.payerBills.forEach((bill) => {
          const userParticipant = bill.participants.find((p) => p.name === currentUser.username);
          const otherResults = bill.results?.filter((r) => r.participantId !== userParticipant.id) || [];

          otherResults.forEach((r) => {
            if (r.paymentStatus === "pending") {
              totalReceivablesPending += r.amount || 0;
              pendingCount++;
            } else if (r.paymentStatus === "paid") {
              totalReceivablesPaid += r.amount || 0;
              paidCount++;
              
              if (r.confirmedByPayer) {
                confirmedCount++;
              } else {
                unconfirmedCount++;
              }
            }
          });
        });

        addResult("ğŸ’° æ‡‰æ”¶æ¬¾", "æ‡‰æ”¶æ¬¾çµ±è¨ˆ", "pass",
          `å¾…æ”¶: $${totalReceivablesPending.toFixed(2)} (${pendingCount}ç­†)\n` +
          `å·²ä»˜æœªç¢ºèª: $${totalReceivablesPaid.toFixed(2)} (${unconfirmedCount}ç­†)\n` +
          `å·²ç¢ºèª: (${confirmedCount}ç­†)\n` +
          `ç¸½è¨ˆ: $${(totalReceivablesPending + totalReceivablesPaid).toFixed(2)}`
        );

        // æ¸¬è©¦ç¢ºèªæ”¶æ¬¾API
        try {
          const response = await authenticatedFetch("/api/bill/confirm-payment", {
            method: "POST",
            body: JSON.stringify({ billId: "test", participantId: "test", confirmed: true }),
          });

          if (response.status === 404 || response.status === 500 || response.status === 400) {
            addResult("ğŸ’° æ‡‰æ”¶æ¬¾", "ç¢ºèªæ”¶æ¬¾API", "pass", "ç¢ºèªæ”¶æ¬¾APIç«¯é»å­˜åœ¨");
          } else if (response.ok) {
            addResult("ğŸ’° æ‡‰æ”¶æ¬¾", "ç¢ºèªæ”¶æ¬¾API", "pass", "ç¢ºèªæ”¶æ¬¾APIæ­£å¸¸");
          }
        } catch (error) {
          addResult("ğŸ’° æ‡‰æ”¶æ¬¾", "ç¢ºèªæ”¶æ¬¾API", "warn", "APIæ¸¬è©¦å¤±æ•—: " + error.message);
        }

        // æ¸¬è©¦æ‹’çµ•æ”¶æ¬¾APIï¼ˆæ–°åŠŸèƒ½ï¼‰
        try {
          const response = await authenticatedFetch("/api/bill/reject-payment", {
            method: "POST",
            body: JSON.stringify({ 
              billId: "test", 
              participantId: "test", 
              reason: "not_received",
              rejectedAt: new Date().toISOString()
            }),
          });

          if (response.status === 404) {
            addResult("ğŸ’° æ‡‰æ”¶æ¬¾", "æ‹’çµ•æ”¶æ¬¾API", "fail", "âŒ APIç«¯é»ä¸å­˜åœ¨! (404éŒ¯èª¤)");
          } else if (response.status === 400 || response.status === 500) {
            addResult("ğŸ’° æ‡‰æ”¶æ¬¾", "æ‹’çµ•æ”¶æ¬¾API", "pass", "âœ… æ‹’çµ•æ”¶æ¬¾APIç«¯é»å­˜åœ¨");
            addResult("ğŸ’° æ‡‰æ”¶æ¬¾", "æ‹’çµ•åŠŸèƒ½èªªæ˜", "info",
              "æ–°å¢å…©ç¨®æ‹’çµ•åŸå› :\n" +
              "ğŸ”´ æœªæ”¶åˆ°æ¬¾ (not_received) - å¯¦éš›æœªæ”¶åˆ°æ¬¾é …\n" +
              "ğŸŸ  éŒ¯èª¤å–®æ“š (wrong_receipt) - æ”¶æ“šæœ‰å•é¡Œ"
            );
          } else if (response.ok) {
            addResult("ğŸ’° æ‡‰æ”¶æ¬¾", "æ‹’çµ•æ”¶æ¬¾API", "pass", "âœ… æ‹’çµ•æ”¶æ¬¾APIæ­£å¸¸");
          }
        } catch (error) {
          addResult("ğŸ’° æ‡‰æ”¶æ¬¾", "æ‹’çµ•æ”¶æ¬¾API", "fail", "APIæ¸¬è©¦å¤±æ•—: " + error.message);
        }

        // æª¢æŸ¥æ˜¯å¦æœ‰å¾…ç¢ºèªçš„æ”¶æ¬¾
        if (unconfirmedCount > 0) {
          addResult("ğŸ’° æ‡‰æ”¶æ¬¾", "å¾…ç¢ºèªæ”¶æ¬¾", "info", `ç™¼ç¾ ${unconfirmedCount} ç­†å·²æ”¯ä»˜ä½†æœªç¢ºèªçš„æ”¶æ¬¾ - å¯åœ¨é é¢ä¸Šæ¸¬è©¦ç¢ºèª/æ‹’çµ•åŠŸèƒ½`);
        } else {
          addResult("ğŸ’° æ‡‰æ”¶æ¬¾", "å¾…ç¢ºèªæ”¶æ¬¾", "warn", "æ²’æœ‰å¾…ç¢ºèªçš„æ”¶æ¬¾ - è«‹åƒè€ƒæ¸¬è©¦æ¡ˆä¾‹æ–‡æª”å‰µå»ºæ¸¬è©¦æ•¸æ“š");
        }
      }

      // æ¸¬è©¦ 7: æ‡‰ä»˜æ¬¾åŠŸèƒ½
      async function testPayables(classification) {
        addResult("ğŸ’¸ æ‡‰ä»˜æ¬¾", "é–‹å§‹æ¸¬è©¦", "info", "æ¸¬è©¦æ‡‰ä»˜æ¬¾ç›¸é—œåŠŸèƒ½...");

        if (classification.participantBills.length === 0) {
          addResult("ğŸ’¸ æ‡‰ä»˜æ¬¾", "æ¸¬è©¦æ¡ˆä¾‹", "warn", "æ²’æœ‰åƒèˆ‡è€…è³¬å–®å¯æ¸¬è©¦");
          return;
        }

        addResult("ğŸ’¸ æ‡‰ä»˜æ¬¾", "åƒèˆ‡è€…è³¬å–®", "pass", `æ‰¾åˆ° ${classification.participantBills.length} å€‹åƒèˆ‡è€…è³¬å–®`);

        let totalAmount = 0;
        let withReceipt = 0;
        classification.participantBills.forEach((bill) => {
          const userParticipant = bill.participants.find((p) => p.name === currentUser.username);
          const userResult = bill.results?.find((r) => r.participantId === userParticipant.id);
          if (userResult) {
            totalAmount += userResult.amount || 0;
            if (userResult.receiptImageUrl) withReceipt++;
          }
        });

        addResult("ğŸ’¸ æ‡‰ä»˜æ¬¾", "æ‡‰ä»˜æ¬¾çµ±è¨ˆ", "pass",
          `ç¸½é‡‘é¡: $${totalAmount.toFixed(2)}\n` +
          `è³¬å–®æ•¸: ${classification.participantBills.length}\n` +
          `å·²ä¸Šå‚³æ”¶æ“š: ${withReceipt}å€‹`
        );
      }

      // æ¸¬è©¦ 8: ç¯©é¸åŠŸèƒ½é‚è¼¯
      async function testFilterLogic(classification) {
        addResult("ğŸ” ç¯©é¸åŠŸèƒ½", "é–‹å§‹æ¸¬è©¦", "info", "æ¸¬è©¦æ‰€æœ‰ç¯©é¸é¸é …çš„é‚è¼¯...");

        const filters = [
          { value: "all", name: "æ‰€æœ‰è³¬å–®", expected: testBills.filter(b => b.participants.find(p => p.name === currentUser.username)).length },
          { value: "my-pending", name: "æˆ‘çš„å¾…æ”¯ä»˜", expected: classification.pendingPayables.length },
          { value: "my-paid", name: "æˆ‘çš„å·²æ”¯ä»˜", expected: classification.paidPayables.length },
        ];

        filters.forEach((filter) => {
          if (filter.expected > 0) {
            addResult("ğŸ” ç¯©é¸åŠŸèƒ½", filter.name, "pass", `âœ… ${filter.expected} å€‹è³¬å–®`);
          } else {
            addResult("ğŸ” ç¯©é¸åŠŸèƒ½", filter.name, "warn", "âš ï¸ æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³¬å–®");
          }
        });

        // æ‡‰æ”¶æ¬¾ç¯©é¸
        const receivablePendingBills = classification.payerBills.filter((bill) => {
          const userParticipant = bill.participants.find((p) => p.name === currentUser.username);
          const otherResults = bill.results?.filter((r) => r.participantId !== userParticipant.id) || [];
          return otherResults.some((r) => r.paymentStatus === "pending");
        });

        const receivablePaidBills = classification.payerBills.filter((bill) => {
          const userParticipant = bill.participants.find((p) => p.name === currentUser.username);
          const otherResults = bill.results?.filter((r) => r.participantId !== userParticipant.id) || [];
          return otherResults.some((r) => r.paymentStatus === "paid");
        });

        addResult("ğŸ” ç¯©é¸åŠŸèƒ½", "æ‡‰æ”¶æ¬¾ç¯©é¸", "pass",
          `å¾…æ”¶è³¬å–®: ${receivablePendingBills.length}å€‹\n` +
          `å·²æ”¶è³¬å–®: ${receivablePaidBills.length}å€‹`
        );
      }

      // æ¸¬è©¦ 9: æ•¸æ“šå®Œæ•´æ€§
      async function testDataIntegrity() {
        addResult("ğŸ›¡ï¸ æ•¸æ“šå®Œæ•´æ€§", "é–‹å§‹æª¢æŸ¥", "info", "æª¢æŸ¥æ‰€æœ‰è³¬å–®æ•¸æ“šå®Œæ•´æ€§...");

        let issues = [];

        testBills.forEach((bill) => {
          const participantIds = bill.participants.map((p) => p.id);
          const resultIds = bill.results?.map((r) => r.participantId) || [];

          // æª¢æŸ¥åƒèˆ‡è€…å’Œçµæœæ˜¯å¦åŒ¹é…
          const missing = participantIds.filter((id) => !resultIds.includes(id));
          const extra = resultIds.filter((id) => !participantIds.includes(id));

          if (missing.length > 0 || extra.length > 0) {
            issues.push({
              bill: bill.name || bill.id,
              type: "åƒèˆ‡è€…IDä¸åŒ¹é…",
              missing,
              extra,
            });
          }

          // æª¢æŸ¥ä»˜æ¬¾äººæ˜¯å¦åœ¨åƒèˆ‡è€…ä¸­
          if (bill.payerId && !participantIds.includes(bill.payerId)) {
            issues.push({
              bill: bill.name || bill.id,
              type: "ä»˜æ¬¾äººä¸åœ¨åƒèˆ‡è€…åˆ—è¡¨",
              payerId: bill.payerId,
            });
          }

          // æª¢æŸ¥å·²æ”¯ä»˜è¨˜éŒ„æ˜¯å¦æœ‰æ™‚é–“æˆ³
          bill.results?.forEach((r) => {
            if (r.paymentStatus === "paid" && !r.paidAt) {
              issues.push({
                bill: bill.name || bill.id,
                type: "å·²æ”¯ä»˜è¨˜éŒ„ç¼ºå°‘æ™‚é–“æˆ³",
                participantId: r.participantId,
              });
            }
          });

          // æª¢æŸ¥æ‹’çµ•è¨˜éŒ„çš„å®Œæ•´æ€§ï¼ˆæ–°å¢ï¼‰
          bill.results?.forEach((r) => {
            if (r.rejectedReason && !r.rejectedAt) {
              issues.push({
                bill: bill.name || bill.id,
                type: "æ‹’çµ•è¨˜éŒ„ç¼ºå°‘æ™‚é–“æˆ³",
                participantId: r.participantId,
              });
            }
          });
        });

        if (issues.length === 0) {
          addResult("ğŸ›¡ï¸ æ•¸æ“šå®Œæ•´æ€§", "å®Œæ•´æ€§æª¢æŸ¥", "pass", "âœ… æ‰€æœ‰è³¬å–®æ•¸æ“šå®Œæ•´ä¸”ä¸€è‡´");
        } else {
          addResult("ğŸ›¡ï¸ æ•¸æ“šå®Œæ•´æ€§", "å®Œæ•´æ€§æª¢æŸ¥", "fail",
            `âŒ ç™¼ç¾ ${issues.length} å€‹å•é¡Œ`,
            issues.slice(0, 10)
          );
        }
      }

      // æ¸¬è©¦ 10: æ‹’çµ•æ”¶æ¬¾æ•¸æ“šåˆ†æï¼ˆæ–°å¢ï¼‰
      async function testRejectedPayments() {
        addResult("ğŸš« æ‹’çµ•è¨˜éŒ„", "é–‹å§‹åˆ†æ", "info", "åˆ†æè¢«æ‹’çµ•çš„æ”¶æ¬¾è¨˜éŒ„...");

        let rejectedPayments = [];
        let notReceivedCount = 0;
        let wrongReceiptCount = 0;

        testBills.forEach((bill) => {
          bill.results?.forEach((r) => {
            if (r.rejectedReason) {
              const participant = bill.participants.find(p => p.id === r.participantId);
              rejectedPayments.push({
                bill: bill.name || bill.id,
                participant: participant?.name || "æœªçŸ¥",
                reason: r.rejectedReason,
                amount: r.amount,
                rejectedAt: r.rejectedAt,
              });

              if (r.rejectedReason === "not_received") notReceivedCount++;
              if (r.rejectedReason === "wrong_receipt") wrongReceiptCount++;
            }
          });
        });

        if (rejectedPayments.length === 0) {
          addResult("ğŸš« æ‹’çµ•è¨˜éŒ„", "æ‹’çµ•çµ±è¨ˆ", "info", "ç›®å‰æ²’æœ‰è¢«æ‹’çµ•çš„æ”¶æ¬¾è¨˜éŒ„");
        } else {
          addResult("ğŸš« æ‹’çµ•è¨˜éŒ„", "æ‹’çµ•çµ±è¨ˆ", "pass",
            `ç¸½å…± ${rejectedPayments.length} ç­†è¢«æ‹’çµ•\n` +
            `ğŸ”´ æœªæ”¶åˆ°æ¬¾: ${notReceivedCount}ç­†\n` +
            `ğŸŸ  éŒ¯èª¤å–®æ“š: ${wrongReceiptCount}ç­†`,
            rejectedPayments.slice(0, 5)
          );
        }
      }

      // æ¸¬è©¦ 11: UIåŠŸèƒ½æª¢æŸ¥
      async function testUIFeatures() {
        addResult("ğŸ¨ UIåŠŸèƒ½", "é–‹å§‹æª¢æŸ¥", "info", "é©—è­‰é é¢UIåŠŸèƒ½å¯¦ç¾...");

        const features = [
          { name: "æŸ¥çœ‹è©³æƒ…", icon: "ğŸ‘ï¸", desc: "é¡¯ç¤ºå®Œæ•´è³¬å–®ä¿¡æ¯æ¨¡æ…‹æ¡†" },
          { name: "æ›´æ–°æ”¯ä»˜", icon: "ğŸ’³", desc: "æ¨™è¨˜å·²æ”¯ä»˜ï¼Œä¸Šå‚³æ”¶æ“šï¼ˆæœ€å¤š6å¼µï¼‰" },
          { name: "æŸ¥çœ‹æ‡‰æ”¶æ¬¾", icon: "ğŸ“‹", desc: "æŸ¥çœ‹å…¶ä»–åƒèˆ‡è€…æ”¯ä»˜ç‹€æ…‹" },
          { name: "æŸ¥çœ‹æ”¶æ“š", icon: "ğŸ–¼ï¸", desc: "æŸ¥çœ‹ä»˜æ¬¾æ†‘è­‰åœ–ç‰‡" },
          { name: "ç¢ºèªæ”¶æ¬¾", icon: "âœ…", desc: "ä»˜æ¬¾äººç¢ºèªå·²æ”¶åˆ°æ¬¾é …" },
          { name: "æœªæ”¶åˆ°æ¬¾", icon: "ğŸ”´", desc: "ä»˜æ¬¾äººæ¨™è¨˜æœªæ”¶åˆ°ï¼Œé€€å›å¾…æ”¯ä»˜" },
          { name: "éŒ¯èª¤å–®æ“š", icon: "ğŸŸ ", desc: "ä»˜æ¬¾äººæ¨™è¨˜æ”¶æ“šéŒ¯èª¤ï¼Œé€€å›å¾…æ”¯ä»˜" },
          { name: "ç‹€æ…‹ç¯©é¸", icon: "ğŸ”", desc: "5ç¨®ç¯©é¸ï¼ˆæ‰€æœ‰ã€å¾…æ”¯ä»˜ã€å·²æ”¯ä»˜ã€æ‡‰æ”¶æ¬¾ã€å·²æ”¶æ¬¾ï¼‰" },
          { name: "æ—¥æœŸç¯©é¸", icon: "ğŸ“…", desc: "æŒ‰æ™‚é–“ç¯„åœç¯©é¸è³¬å–®" },
          { name: "æœç´¢åŠŸèƒ½", icon: "ğŸ”", desc: "æŒ‰åç¨±ã€åœ°é»ã€åƒèˆ‡è€…æœç´¢" },
        ];

        features.forEach((feature) => {
          addResult("ğŸ¨ UIåŠŸèƒ½", feature.name, "pass", `${feature.icon} ${feature.desc}`);
        });
      }

      // æ¸¬è©¦ 12: ç©ºç™½åˆ—è¡¨æª¢æŸ¥ï¼ˆæ–°å¢ï¼‰
      async function testEmptyBillElements() {
        addResult("ğŸ› Bugæª¢æŸ¥", "ç©ºç™½åˆ—è¡¨", "info", "æª¢æŸ¥æ˜¯å¦æœ‰ç©ºç™½è³¬å–®å…ƒç´ ...");

        const billsWithoutUser = testBills.filter((bill) => {
          const userParticipant = bill.participants.find((p) => p.name === currentUser.username);
          return !userParticipant;
        });

        if (billsWithoutUser.length > 0) {
          addResult("ğŸ› Bugæª¢æŸ¥", "ç©ºç™½åˆ—è¡¨", "pass",
            `æ‰¾åˆ° ${billsWithoutUser.length} å€‹ä¸åŒ…å«ç•¶å‰ç”¨æˆ¶çš„è³¬å–®\n` +
            `é€™äº›è³¬å–®æœƒè¢«æ­£ç¢ºè·³éï¼Œä¸æœƒé¡¯ç¤ºç©ºç™½å…ƒç´ `,
            billsWithoutUser.slice(0, 3).map(b => ({ id: b.id, name: b.name }))
          );
        } else {
          addResult("ğŸ› Bugæª¢æŸ¥", "ç©ºç™½åˆ—è¡¨", "info", "æ‰€æœ‰è³¬å–®éƒ½åŒ…å«ç•¶å‰ç”¨æˆ¶");
        }
      }

      // é‹è¡Œæ‰€æœ‰æ¸¬è©¦
      async function runAllTests() {
        clearResults();
        totalTests = 50; // é ä¼°æ¸¬è©¦æ•¸é‡
        completedTests = 0;
        
        updateProgress("é–‹å§‹æ¸¬è©¦...", 0);
        addResult("ğŸš€ ç³»çµ±", "æ¸¬è©¦é–‹å§‹", "info", 
          `æ¸¬è©¦æ™‚é–“: ${new Date().toLocaleString("zh-TW")}\n` +
          `æ¸¬è©¦ç”¨æˆ¶: ${currentUser?.username || "æœªçŸ¥"}`
        );

        const initOK = await testInitialization();
        if (!initOK) {
          addResult("ğŸš€ ç³»çµ±", "æ¸¬è©¦ä¸­æ­¢", "fail", "âŒ åˆå§‹åŒ–å¤±æ•—ï¼Œç„¡æ³•ç¹¼çºŒæ¸¬è©¦");
          updateProgress("æ¸¬è©¦ä¸­æ­¢", 0);
          return;
        }

        updateProgress("æ­£åœ¨æ¸¬è©¦çµ±è¨ˆè¨ˆç®—...", 15);
        const statsResult = await testStatisticsCalculation();
        
        updateProgress("æ­£åœ¨æ¸¬è©¦è³¬å–®åˆ†é¡...", 30);
        const classification = await testBillClassification();
        
        updateProgress("æ­£åœ¨æ¸¬è©¦APIç«¯é»...", 45);
        await testAPIEndpoints();
        
        updateProgress("æ­£åœ¨æ¸¬è©¦æ”¯ä»˜ç‹€æ…‹æ›´æ–°...", 55);
        await testPaymentStatusUpdate(classification);
        
        updateProgress("æ­£åœ¨æ¸¬è©¦æ‡‰æ”¶æ¬¾åŠŸèƒ½...", 65);
        await testReceivables(classification);
        
        updateProgress("æ­£åœ¨æ¸¬è©¦æ‡‰ä»˜æ¬¾åŠŸèƒ½...", 75);
        await testPayables(classification);
        
        updateProgress("æ­£åœ¨æ¸¬è©¦ç¯©é¸é‚è¼¯...", 82);
        await testFilterLogic(classification);
        
        updateProgress("æ­£åœ¨æ¸¬è©¦æ•¸æ“šå®Œæ•´æ€§...", 88);
        await testDataIntegrity();
        
        updateProgress("æ­£åœ¨æ¸¬è©¦æ‹’çµ•è¨˜éŒ„...", 92);
        await testRejectedPayments();
        
        updateProgress("æ­£åœ¨æ¸¬è©¦ç©ºç™½åˆ—è¡¨...", 95);
        await testEmptyBillElements();
        
        updateProgress("æ­£åœ¨æ¸¬è©¦UIåŠŸèƒ½...", 98);
        await testUIFeatures();

        const passRate = stats.total > 0 ? ((stats.pass / stats.total) * 100).toFixed(1) : 0;
        const summary = `
ğŸŠ æ¸¬è©¦å®Œæˆï¼

ğŸ“Š æ¸¬è©¦æ‘˜è¦:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… é€šé: ${stats.pass} é …
âŒ å¤±æ•—: ${stats.fail} é …
âš ï¸ è­¦å‘Š: ${stats.warn} é …
â„¹ï¸ ä¿¡æ¯: ${stats.info} é …
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ˆ é€šéç‡: ${passRate}%

${stats.fail === 0 ? 'ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼é é¢åŠŸèƒ½å®Œæ•´ï¼' : 'âš ï¸ æœ‰æ¸¬è©¦å¤±æ•—ï¼Œè«‹æŸ¥çœ‹è©³ç´°çµæœ'}
`;
        addResult("ğŸš€ ç³»çµ±", "æ¸¬è©¦å®Œæˆ", stats.fail === 0 ? "pass" : "warn", summary);
        updateProgress("æ¸¬è©¦å®Œæˆï¼", 100);
      }

      // å°å‡ºçµæœ
      function generateMarkdown() {
        const now = new Date();
        let md = `# æˆ‘çš„è³¬å–®é é¢å®Œæ•´æ¸¬è©¦çµæœï¼ˆæœ€çµ‚ç‰ˆV2ï¼‰\n\n`;
        md += `**æ¸¬è©¦æ™‚é–“**: ${now.toLocaleString("zh-TW")}\n`;
        md += `**æ¸¬è©¦ç”¨æˆ¶**: ${currentUser?.username || "N/A"} (${currentUser?.email || "N/A"})\n\n`;

        md += `## ğŸ“Š æ¸¬è©¦çµ±è¨ˆ\n\n`;
        md += `| é¡å‹ | æ•¸é‡ | ç™¾åˆ†æ¯” |\n`;
        md += `|------|------|--------|\n`;
        md += `| âœ… é€šé | ${stats.pass} | ${((stats.pass / stats.total) * 100 || 0).toFixed(1)}% |\n`;
        md += `| âŒ å¤±æ•— | ${stats.fail} | ${((stats.fail / stats.total) * 100 || 0).toFixed(1)}% |\n`;
        md += `| âš ï¸ è­¦å‘Š | ${stats.warn} | ${((stats.warn / stats.total) * 100 || 0).toFixed(1)}% |\n`;
        md += `| â„¹ï¸ ä¿¡æ¯ | ${stats.info} | ${((stats.info / stats.total) * 100 || 0).toFixed(1)}% |\n`;
        md += `| ğŸ“Š ç¸½è¨ˆ | ${stats.total} | 100% |\n\n`;

        const passRate = ((stats.pass / stats.total) * 100 || 0).toFixed(1);
        md += `**é€šéç‡**: ${passRate}% ${passRate >= 90 ? 'ğŸ‰' : passRate >= 70 ? 'ğŸ‘' : 'âš ï¸'}\n\n`;

        md += `## ğŸ“‹ è©³ç´°æ¸¬è©¦çµæœ\n\n`;

        const categories = [...new Set(testResults.map((r) => r.category))];
        categories.forEach((category) => {
          md += `### ${category}\n\n`;
          testResults
            .filter((r) => r.category === category)
            .forEach((result) => {
              const icon = { pass: "âœ…", fail: "âŒ", warn: "âš ï¸", info: "â„¹ï¸" }[result.status];
              md += `**${icon} ${result.name}**\n\n`;
              md += `${result.message}\n\n`;
              if (result.details) {
                md += `<details>\n<summary>æŸ¥çœ‹è©³ç´°æ•¸æ“š</summary>\n\n`;
                md += `\`\`\`json\n${JSON.stringify(result.details, null, 2)}\n\`\`\`\n\n`;
                md += `</details>\n\n`;
              }
            });
        });

        md += `---\n\n`;
        md += `## ğŸ¯ åŠŸèƒ½æ¸…å–®\n\n`;
        md += `### âœ… å·²å¯¦ç¾ä¸¦æ¸¬è©¦çš„åŠŸèƒ½ï¼ˆ11é …ï¼‰\n\n`;
        md += `1. **è³¬å–®åˆ—è¡¨é¡¯ç¤º** - å‰µå»ºçš„å’Œåƒèˆ‡çš„æ‰€æœ‰è³¬å–®\n`;
        md += `2. **çµ±è¨ˆæ•¸æ“šå¡ç‰‡** - 6å€‹å¡ç‰‡ï¼ˆç¸½æ•¸ã€å¾…æ”¯ä»˜ã€å·²æ”¯ä»˜ã€æ‡‰æ”¶æ¬¾ã€å·²æ”¶æ¬¾ã€ç¸½é¡ï¼‰\n`;
        md += `3. **æŸ¥çœ‹è©³æƒ…** - å®Œæ•´è³¬å–®ä¿¡æ¯æ¨¡æ…‹æ¡†\n`;
        md += `4. **æ›´æ–°æ”¯ä»˜ç‹€æ…‹** - æ¨™è¨˜å·²æ”¯ä»˜ã€ä¸Šå‚³æ”¶æ“šï¼ˆæœ€å¤š6å¼µï¼‰\n`;
        md += `5. **æ‡‰æ”¶æ¬¾ç®¡ç†** - æŸ¥çœ‹åƒèˆ‡è€…ç‹€æ…‹ã€æŸ¥çœ‹æ”¶æ“š\n`;
        md += `6. **ç¢ºèªæ”¶æ¬¾** - ä»˜æ¬¾äººç¢ºèªæ”¶åˆ°æ¬¾é …\n`;
        md += `7. **æ‹’çµ•æ”¶æ¬¾ï¼ˆæœªæ”¶åˆ°æ¬¾ï¼‰** - æ¨™è¨˜æœªæ”¶åˆ°ï¼Œé€€å›å¾…æ”¯ä»˜\n`;
        md += `8. **æ‹’çµ•æ”¶æ¬¾ï¼ˆéŒ¯èª¤å–®æ“šï¼‰** - æ¨™è¨˜æ”¶æ“šéŒ¯èª¤ï¼Œé€€å›å¾…æ”¯ä»˜\n`;
        md += `9. **ç‹€æ…‹ç¯©é¸** - 5ç¨®ç¯©é¸é¸é …\n`;
        md += `10. **æ—¥æœŸç¯©é¸** - æŒ‰æ™‚é–“ç¯„åœç¯©é¸\n`;
        md += `11. **æœç´¢åŠŸèƒ½** - æŒ‰åç¨±ã€åœ°é»ã€åƒèˆ‡è€…æœç´¢\n\n`;

        md += `## ğŸ”§ æ¸¬è©¦è¦†è“‹ç¯„åœ\n\n`;
        md += `- âœ… åˆå§‹åŒ–å’Œèªè­‰\n`;
        md += `- âœ… çµ±è¨ˆè¨ˆç®—é‚è¼¯\n`;
        md += `- âœ… è³¬å–®åˆ†é¡ï¼ˆä»˜æ¬¾äºº/åƒèˆ‡è€…ï¼‰\n`;
        md += `- âœ… APIç«¯é»å¯ç”¨æ€§\n`;
        md += `- âœ… æ”¯ä»˜ç‹€æ…‹æ›´æ–°\n`;
        md += `- âœ… æ‡‰æ”¶æ¬¾åŠŸèƒ½ï¼ˆç¢ºèª/æ‹’çµ•ï¼‰\n`;
        md += `- âœ… æ‡‰ä»˜æ¬¾åŠŸèƒ½\n`;
        md += `- âœ… ç¯©é¸é‚è¼¯\n`;
        md += `- âœ… æ•¸æ“šå®Œæ•´æ€§\n`;
        md += `- âœ… æ‹’çµ•è¨˜éŒ„åˆ†æ\n`;
        md += `- âœ… ç©ºç™½å…ƒç´ æª¢æŸ¥\n`;
        md += `- âœ… UIåŠŸèƒ½æ¸…å–®\n\n`;

        md += `## ğŸ“ æ¸¬è©¦çµè«–\n\n`;
        if (stats.fail === 0) {
          md += `### âœ… æ¸¬è©¦é€šé\n\n`;
          md += `æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å¯¦ç¾ä¸¦æ­£å¸¸å·¥ä½œï¼Œé é¢å¯ä»¥æŠ•å…¥ç”Ÿç”¢ä½¿ç”¨ã€‚\n\n`;
        } else {
          md += `### âš ï¸ éœ€è¦ä¿®å¾©\n\n`;
          md += `ç™¼ç¾ ${stats.fail} å€‹å¤±æ•—çš„æ¸¬è©¦ï¼Œè«‹æŸ¥çœ‹è©³ç´°çµæœä¸¦ä¿®å¾©å•é¡Œã€‚\n\n`;
        }

        md += `---\n`;
        md += `*æ­¤å ±å‘Šç”± PBCèšè³¬é€š æˆ‘çš„è³¬å–®é é¢å®Œæ•´æ¸¬è©¦ç³»çµ±ç”Ÿæˆ*\n`;
        md += `*ç”Ÿæˆæ™‚é–“: ${now.toLocaleString("zh-TW")}*\n`;
        return md;
      }

      function exportResults() {
        const md = generateMarkdown();
        const blob = new Blob([md], { type: "text/markdown" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const timestamp = new Date().toISOString().split("T")[0];
        a.download = `æˆ‘çš„è³¬å–®å®Œæ•´æ¸¬è©¦_${timestamp}.md`;
        a.click();
        URL.revokeObjectURL(url);
        
        navigator.clipboard.writeText(md).then(() => {
          alert("âœ… æ¸¬è©¦çµæœå·²ä¸‹è¼‰ä¸¦è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼");
        }).catch(() => {
          alert("âœ… æ¸¬è©¦çµæœå·²ä¸‹è¼‰ï¼");
        });
      }

      function clearResults() {
        document.getElementById("test-results").innerHTML = "";
        testResults = [];
        stats = { pass: 0, fail: 0, warn: 0, info: 0, total: 0 };
        completedTests = 0;
        updateStats();
        updateProgress("æº–å‚™æ¸¬è©¦...", 0);
      }

      // äº‹ä»¶ç›£è½
      document.getElementById("run-all-tests").addEventListener("click", runAllTests);
      document.getElementById("export-results").addEventListener("click", exportResults);
      document.getElementById("clear-results").addEventListener("click", clearResults);

      // é é¢åŠ è¼‰
      window.addEventListener("DOMContentLoaded", () => {
        const userStr = localStorage.getItem("user");
        if (!userStr) {
          alert("âŒ è«‹å…ˆç™»å…¥ï¼");
          window.location.href = "/login-page.html";
        } else {
          const user = JSON.parse(userStr);
          currentUser = user;
          
          const info = document.createElement("div");
          info.className = "bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-300 p-6 mb-6 rounded-lg shadow";
          info.innerHTML = `
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white text-2xl font-bold shadow-lg">
                ${user.username.charAt(0).toUpperCase()}
              </div>
              <div class="flex-1">
                <div class="font-bold text-xl text-gray-800 mb-1">
                  <i class="fas fa-user-check text-green-500 mr-2"></i>å·²ç™»å…¥
                </div>
                <div class="text-gray-700">
                  <i class="fas fa-user mr-2"></i><strong>${user.username}</strong>
                  <span class="mx-2">|</span>
                  <i class="fas fa-envelope mr-2"></i>${user.email}
                </div>
                <div class="text-sm text-gray-500 mt-2">
                  <i class="fas fa-info-circle mr-1"></i>é»æ“Šã€Œé‹è¡Œå®Œæ•´æ¸¬è©¦ã€é–‹å§‹å…¨é¢æª¢æŸ¥
                </div>
              </div>
              <div class="text-right">
                <div class="text-sm text-gray-600 mb-1">æ¸¬è©¦ç‰ˆæœ¬</div>
                <div class="text-2xl font-bold text-purple-600">V2</div>
                <div class="text-xs text-gray-500">åŒ…å«æ‹’çµ•æ”¶æ¬¾æ¸¬è©¦</div>
              </div>
            </div>
          `;
          document.querySelector(".max-w-7xl").insertBefore(
            info,
            document.querySelector(".max-w-7xl").firstChild
          );
        }
      });
    </script>
  </body>
</html>
