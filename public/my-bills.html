<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æˆ‘çš„è³¬å–® - PBCèšè³¬é€š</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      :root {
        --primary: #4f46e5;
        --primary-light: #e0e7ff;
        --dark: #1f2937;
        --light: #f8fafc;
      }

      .text-primary {
        color: var(--primary);
      }

      .bg-primary {
        background-color: var(--primary);
      }

      .bg-light {
        background-color: var(--light);
      }

      .text-dark {
        color: var(--dark);
      }

      .input-focus:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .btn-primary {
        background-color: var(--primary);
        color: white;
        padding: 0.75rem 1.5rem;
        min-height: 44px;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn-primary:hover {
        background-color: #3730a3;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
      }

      .btn-secondary {
        background-color: #f3f4f6;
        color: var(--dark);
        padding: 0.75rem 1.5rem;
        min-height: 44px;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.3s ease;
        border: 1px solid #d1d5db;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .btn-secondary:hover {
        background-color: #e5e7eb;
        transform: translateY(-1px);
      }

      .status-pending {
        background-color: #fef3c7;
        color: #92400e;
      }

      .status-paid {
        background-color: #d1fae5;
        color: #065f46;
      }

      .status-overdue {
        background-color: #fee2e2;
        color: #991b1b;
      }
    </style>
  </head>

  <body
    class="font-sans text-dark bg-gray-50 min-h-screen"
    style="background-color: #f9fafb"
  >
    <!-- Header å°‡ç”± JavaScript å‹•æ…‹æ’å…¥ -->

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="pt-24 pb-20" style="min-height: calc(100vh - 100px)">
      <section class="container mx-auto px-4 sm:px-6 lg:px-8">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="text-center mb-12">
          <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold mb-4 text-dark">
            æˆ‘çš„<span class="text-primary">è³¬å–®</span>
          </h1>
          <p class="text-gray-600 max-w-2xl mx-auto text-lg">
            æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„æ‰€æœ‰è³¬å–®è¨˜éŒ„
          </p>
        </div>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="mb-8">
          <!-- ç¬¬ä¸€è¡Œï¼šç¸½è³¬å–®æ•¸ã€å¾…æ”¯ä»˜ã€å·²æ”¯ä»˜ã€æ‡‰æ”¶æ¬¾ã€å·²æ”¶æ¬¾ -->
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4">
            <div class="bg-white rounded-lg p-4 shadow-sm text-center">
              <div
                class="w-10 h-10 mx-auto rounded-full bg-blue-100 text-blue-600 flex items-center justify-center mb-2"
              >
                <i class="fa fa-file-text"></i>
              </div>
              <p class="text-xs text-gray-600 mb-1">ç¸½è³¬å–®æ•¸</p>
              <p class="text-2xl font-bold text-gray-900" id="total-bills">0</p>
            </div>

            <div class="bg-white rounded-lg p-4 shadow-sm text-center">
              <div
                class="w-10 h-10 mx-auto rounded-full bg-orange-100 text-orange-600 flex items-center justify-center mb-2"
              >
                <i class="fa fa-clock"></i>
              </div>
              <p class="text-xs text-gray-600 mb-1">å¾…æ”¯ä»˜</p>
              <p class="text-2xl font-bold text-gray-900" id="pending-bills">
                0
              </p>
            </div>

            <div class="bg-white rounded-lg p-4 shadow-sm text-center">
              <div
                class="w-10 h-10 mx-auto rounded-full bg-green-100 text-green-600 flex items-center justify-center mb-2"
              >
                <i class="fa fa-check-circle"></i>
              </div>
              <p class="text-xs text-gray-600 mb-1">å·²æ”¯ä»˜</p>
              <p class="text-2xl font-bold text-gray-900" id="paid-bills">0</p>
            </div>

            <div class="bg-white rounded-lg p-4 shadow-sm text-center">
              <div
                class="w-10 h-10 mx-auto rounded-full bg-purple-100 text-purple-600 flex items-center justify-center mb-2"
              >
                <i class="fa fa-hourglass"></i>
              </div>
              <p class="text-xs text-gray-600 mb-1">æ‡‰æ”¶æ¬¾</p>
              <p
                class="text-2xl font-bold text-gray-900"
                id="receivables-pending-count"
              >
                0
              </p>
            </div>

            <div class="bg-white rounded-lg p-4 shadow-sm text-center">
              <div
                class="w-10 h-10 mx-auto rounded-full bg-teal-100 text-teal-600 flex items-center justify-center mb-2"
              >
                <i class="fa fa-check"></i>
              </div>
              <p class="text-xs text-gray-600 mb-1">å·²æ”¶æ¬¾</p>
              <p
                class="text-2xl font-bold text-gray-900"
                id="receivables-paid-count"
              >
                0
              </p>
            </div>
          </div>

          <!-- ç¬¬äºŒè¡Œï¼šå¾…æ”¯ä»˜ç¸½é¡ã€æ‡‰æ”¶æ¬¾ç¸½é¡ -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg p-6 shadow-sm">
              <div class="flex items-center">
                <div class="p-3 rounded-full bg-red-100 text-red-600">
                  <i class="fa fa-arrow-down text-xl"></i>
                </div>
                <div class="ml-4 flex-1">
                  <p class="text-sm font-medium text-gray-600">å¾…æ”¯ä»˜ç¸½é¡</p>
                  <p class="text-2xl font-bold text-gray-900" id="payables">
                    $0.00
                  </p>
                  <p class="text-xs text-gray-500" id="payables-count">0ç­†</p>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-lg p-6 shadow-sm">
              <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                  <i class="fa fa-arrow-up text-xl"></i>
                </div>
                <div class="ml-4 flex-1">
                  <p class="text-sm font-medium text-gray-600">æ‡‰æ”¶æ¬¾ç¸½é¡</p>
                  <p
                    class="text-2xl font-bold text-gray-900"
                    id="receivables-total"
                  >
                    $0.00
                  </p>
                  <p class="text-xs text-gray-500">
                    å¾…æ”¶ <span id="receivables-pending-amount">$0</span> Â· å·²æ”¶
                    <span id="receivables-paid-amount">$0</span>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ç¯©é¸å’Œæœç´¢ -->
        <div class="bg-white rounded-lg p-6 shadow-sm mb-6">
          <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
              <input
                type="text"
                id="search-input"
                placeholder="æœç´¢è³¬å–®åç¨±ã€åœ°é»æˆ–åƒèˆ‡è€…..."
                class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-all duration-300"
              />
            </div>
            <div class="flex gap-2">
              <select
                id="status-filter"
                class="px-4 py-2 border border-gray-300 rounded-lg input-focus"
              >
                <option value="">æ‰€æœ‰è³¬å–®</option>
                <option value="my-pending">å¾…æ”¯ä»˜</option>
                <option value="my-paid">å·²æ”¯ä»˜</option>
                <option value="receivable-pending">æ‡‰æ”¶æ¬¾</option>
                <option value="receivable-paid">å·²æ”¶æ¬¾</option>
              </select>
              <select
                id="date-filter"
                class="px-4 py-2 border border-gray-300 rounded-lg input-focus"
              >
                <option value="">æ‰€æœ‰æ™‚é–“</option>
                <option value="today">ä»Šå¤©</option>
                <option value="week">æœ¬é€±</option>
                <option value="month">æœ¬æœˆ</option>
                <option value="year">ä»Šå¹´</option>
              </select>
            </div>
          </div>
        </div>

        <!-- è³¬å–®åˆ—è¡¨ -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">è³¬å–®åˆ—è¡¨</h2>
          </div>
          <div id="bills-container" class="divide-y divide-gray-200">
            <!-- è³¬å–®é …ç›®å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
          </div>
          <div id="empty-state" class="text-center py-12 hidden">
            <i class="fa fa-file-text text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">æš«ç„¡è³¬å–®</h3>
            <p class="text-gray-500 mb-4">æ‚¨é‚„æ²’æœ‰å‰µå»ºä»»ä½•è³¬å–®</p>
            <a
              href="/calculator.html"
              class="btn-primary inline-flex items-center"
            >
              <i class="fa fa-plus mr-2"></i>å‰µå»ºæ–°è³¬å–®
            </a>
          </div>
        </div>
      </section>
    </main>

    <!-- æ”¯ä»˜ç‹€æ…‹æ›´æ–°æ¨¡æ…‹æ¡† -->
    <div
      id="payment-modal"
      class="fixed inset-0 bg-black/50 flex items-start justify-center z-50 transition-all duration-300 opacity-0 invisible overflow-y-auto p-4"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-md w-full my-4 transform transition-all duration-300 scale-95"
      >
        <div
          class="bg-gradient-to-r from-primary to-primary/80 p-6 text-white flex justify-between items-center"
        >
          <h3 class="text-xl font-bold">æ›´æ–°æ”¯ä»˜ç‹€æ…‹</h3>
          <button
            id="close-payment-modal-btn"
            class="text-white hover:text-white/80 transition-colors"
          >
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        <div class="p-6">
          <div class="mb-4">
            <label class="block text-gray-700 font-medium mb-2">æ”¯ä»˜ç‹€æ…‹</label>
            <select
              id="payment-status-select"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg input-focus"
            >
              <option value="pending">å¾…æ”¯ä»˜</option>
              <option value="paid">å·²æ”¯ä»˜</option>
            </select>
          </div>
          <div id="receipt-upload-section" class="mb-4 hidden">
            <label class="block text-gray-700 font-medium mb-2">æ”¯ä»˜æ†‘è­‰</label>
            <div
              class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center"
            >
              <input
                type="file"
                id="receipt-file"
                accept="image/*"
                class="hidden"
              />
              <button
                id="upload-receipt-btn"
                class="text-primary hover:text-primary/80 transition-colors"
              >
                <i class="fa fa-cloud-upload text-2xl mb-2"></i>
                <p>é»æ“Šä¸Šå‚³æ†‘è­‰åœ–ç‰‡</p>
                <p class="text-sm text-gray-500">æ”¯æŒ JPGã€PNG æ ¼å¼</p>
              </button>
            </div>
            <div id="receipt-preview" class="mt-4 hidden">
              <img
                id="receipt-image"
                class="w-full h-32 object-cover rounded-lg"
              />
              <button
                id="remove-receipt-btn"
                class="mt-2 text-red-500 hover:text-red-700 text-sm"
              >
                <i class="fa fa-trash mr-1"></i>ç§»é™¤åœ–ç‰‡
              </button>
            </div>
          </div>
          <div class="flex gap-3">
            <button id="cancel-payment-btn" class="btn-secondary flex-1">
              å–æ¶ˆ
            </button>
            <button id="save-payment-btn" class="btn-primary flex-1">
              ä¿å­˜
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer å°‡ç”± JavaScript å‹•æ…‹æ’å…¥ -->

    <!-- å¼•å…¥å¿…è¦çš„è…³æœ¬ -->
    <script src="/js/auth.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/page-setup.js"></script>

    <script type="module">
      // é é¢åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", async () => {
        // è¨­ç½®é é¢çµ„ä»¶
        const pageInitialized = await window.pageSetup.init({
          currentPage: "my-bills",
          requireAuth: true,
          showHeader: true,
          showFooter: true,
          headerOptions: {
            showCalculator: true,
            showMyBills: true,
            showContact: true,
          },
        });

        if (!pageInitialized) {
          return; // èªè­‰å¤±æ•—ï¼Œé é¢æœƒé‡å®šå‘
        }

        // è¨­ç½®é é¢ç‰¹å®šåŠŸèƒ½
        window.pageSetup.setupPageFeatures({
          updateUserDisplay: true,
          setupLogout: true,
          setupAuthCheck: true,
        });

        // ä½¿ç”¨èªè­‰ç®¡ç†å™¨çš„fetchæ–¹æ³•
        const authenticatedFetch = window.authManager.authenticatedFetch.bind(
          window.authManager
        );

        // DOMå…ƒç´ 
        const searchInput = document.getElementById("search-input");
        const statusFilter = document.getElementById("status-filter");
        const dateFilter = document.getElementById("date-filter");
        const billsContainer = document.getElementById("bills-container");
        const emptyState = document.getElementById("empty-state");
        const totalBillsEl = document.getElementById("total-bills");
        const pendingBillsEl = document.getElementById("pending-bills");
        const paidBillsEl = document.getElementById("paid-bills");
        const receivablesEl = document.getElementById("receivables");
        const receivablesCountEl = document.getElementById("receivables-count");
        const payablesEl = document.getElementById("payables");
        const payablesCountEl = document.getElementById("payables-count");

        // æ”¯ä»˜æ¨¡æ…‹æ¡†å…ƒç´ 
        const paymentModal = document.getElementById("payment-modal");
        const closePaymentModalBtn = document.getElementById(
          "close-payment-modal-btn"
        );
        const paymentStatusSelect = document.getElementById(
          "payment-status-select"
        );
        const receiptUploadSection = document.getElementById(
          "receipt-upload-section"
        );
        const receiptFile = document.getElementById("receipt-file");
        const uploadReceiptBtn = document.getElementById("upload-receipt-btn");
        const receiptPreview = document.getElementById("receipt-preview");
        const receiptImage = document.getElementById("receipt-image");
        const removeReceiptBtn = document.getElementById("remove-receipt-btn");
        const cancelPaymentBtn = document.getElementById("cancel-payment-btn");
        const savePaymentBtn = document.getElementById("save-payment-btn");

        let currentBillId = null;
        let currentParticipantId = null;
        let bills = [];

        // åˆå§‹åŒ–ï¼ˆç›´æ¥èª¿ç”¨ï¼Œä¸å†ç›£è½ DOMContentLoadedï¼‰
        (async () => {
          // æ›´æ–°ç”¨æˆ¶ä¿¡æ¯é¡¯ç¤º
          window.authManager.updateUserDisplay();

          await loadBills();
          setupEventListeners();
        })();

        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
          // æœç´¢å’Œç¯©é¸
          searchInput.addEventListener("input", filterBills);
          statusFilter.addEventListener("change", filterBills);
          dateFilter.addEventListener("change", filterBills);

          // æ”¯ä»˜æ¨¡æ…‹æ¡†
          closePaymentModalBtn.addEventListener("click", closePaymentModal);
          cancelPaymentBtn.addEventListener("click", closePaymentModal);
          paymentStatusSelect.addEventListener("change", toggleReceiptUpload);
          uploadReceiptBtn.addEventListener("click", () => receiptFile.click());
          receiptFile.addEventListener("change", handleReceiptUpload);
          removeReceiptBtn.addEventListener("click", removeReceipt);
          savePaymentBtn.addEventListener("click", savePaymentStatus);

          // é»æ“Šæ¨¡æ…‹æ¡†èƒŒæ™¯é—œé–‰
          paymentModal.addEventListener("click", (e) => {
            if (e.target === paymentModal) {
              closePaymentModal();
            }
          });

          // è¨­ç½®ç™»å‡ºåŠŸèƒ½
          window.authManager.setupLogoutButton();
        }

        // åŠ è¼‰è³¬å–®åˆ—è¡¨
        async function loadBills() {
          try {
            console.log("é–‹å§‹åŠ è¼‰è³¬å–®...");
            const response = await authenticatedFetch("/api/bills");
            if (!response) {
              console.log("èªè­‰å¤±æ•—ï¼Œå·²é‡å®šå‘");
              return;
            }

            if (response.ok) {
              const data = await response.json();
              console.log("APIè¿”å›çš„æ•¸æ“š:", data);
              bills = data.bills || data; // å…¼å®¹å…©ç¨®è¿”å›æ ¼å¼
              console.log("è§£æå¾Œçš„è³¬å–®æ•¸çµ„:", bills);
              console.log("åŠ è¼‰çš„è³¬å–®æ•¸é‡:", bills.length);

              if (!Array.isArray(bills)) {
                console.error("è³¬å–®æ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼Œä¸æ˜¯æ•¸çµ„:", bills);
                bills = [];
              }

              displayBills(bills);
              updateStatistics(bills);
            } else {
              console.error("åŠ è¼‰è³¬å–®å¤±æ•—ï¼Œç‹€æ…‹ç¢¼:", response.status);
              const errorData = await response.json();
              console.error("éŒ¯èª¤ä¿¡æ¯:", errorData);
            }
          } catch (error) {
            console.error("åŠ è¼‰è³¬å–®æ™‚å‡ºéŒ¯:", error);
          }
        }

        // é¡¯ç¤ºè³¬å–®åˆ—è¡¨
        function displayBills(billsToShow) {
          console.log("=== é¡¯ç¤ºè³¬å–®åˆ—è¡¨ ===");
          console.log("è³¬å–®æ•¸é‡:", billsToShow.length);
          console.log("è³¬å–®å®¹å™¨å…ƒç´ :", billsContainer);
          console.log("ç©ºç‹€æ…‹å…ƒç´ :", emptyState);
          console.log("è³¬å–®æ•¸æ“š:", billsToShow);

          billsContainer.innerHTML = "";

          if (billsToShow.length === 0) {
            console.log("æ²’æœ‰è³¬å–®ï¼Œé¡¯ç¤ºç©ºç‹€æ…‹");
            emptyState.classList.remove("hidden");
            return;
          }

          console.log("æœ‰è³¬å–®ï¼Œéš±è—ç©ºç‹€æ…‹");
          emptyState.classList.add("hidden");

          billsToShow.forEach((bill, index) => {
            console.log(`å‰µå»ºè³¬å–® ${index + 1}:`, bill.name);
            try {
              const billElement = createBillElement(bill);
              if (billElement) {
                billsContainer.appendChild(billElement);
                console.log(`è³¬å–® ${index + 1} å·²æ·»åŠ åˆ°DOM`);
              } else {
                console.log(`è³¬å–® ${index + 1} è¢«è·³éï¼ˆç”¨æˆ¶æœªåƒèˆ‡ï¼‰`);
              }
            } catch (error) {
              console.error(`å‰µå»ºè³¬å–® ${index + 1} å¤±æ•—:`, error);
            }
          });

          console.log("=== è³¬å–®åˆ—è¡¨é¡¯ç¤ºå®Œæˆ ===");
        }

        // å‰µå»ºè³¬å–®å…ƒç´ 
        function createBillElement(bill) {
          const billDiv = document.createElement("div");
          billDiv.className =
            "p-4 sm:p-6 hover:bg-gray-50 transition-all duration-200 border-b border-gray-100 last:border-b-0";

          const date = new Date(bill.date);
          const formattedDate = date.toLocaleDateString("zh-TW");

          // è¨ˆç®—åƒèˆ‡è€…çš„æ”¯ä»˜ç‹€æ…‹
          const participantStatuses = bill.results || [];
          const currentUser = window.authManager.getCurrentUser();

          // é€šéç”¨æˆ¶ååŒ¹é…åƒèˆ‡è€…
          const userParticipant = bill.participants.find(
            (p) => p.name === currentUser.username
          );

          // å¦‚æœæ‰¾ä¸åˆ°ç”¨æˆ¶åƒèˆ‡è€…ï¼Œè·³éæ­¤è³¬å–®
          if (!userParticipant) {
            console.warn(
              `è³¬å–® ${bill.id} (${bill.name}) ä¸­æ‰¾ä¸åˆ°ç”¨æˆ¶ ${currentUser.username}`
            );
            return null;
          }

          const userResult = userParticipant
            ? participantStatuses.find(
                (r) => r.participantId === userParticipant.id
              )
            : null;

          const userStatus = userResult?.paymentStatus || "pending";

          // æª¢æŸ¥æ˜¯å¦ç‚ºä»˜æ¬¾äººï¼ˆé€šéåƒèˆ‡è€…IDåŒ¹é…ï¼‰
          const isPayer = bill.payerId === userParticipant?.id;
          const totalAmount = bill.items.reduce(
            (sum, item) => sum + item.amount,
            0
          );
          const userAmount = userResult ? userResult.amount : 0;

          // æ ¹æ“šè§’è‰²é¡¯ç¤ºä¸åŒçš„ç‹€æ…‹
          let statusClass, statusText, statusIcon;

          if (isPayer) {
            // ä»˜æ¬¾äººï¼šé¡¯ç¤ºæ‡‰æ”¶æ¬¾ç‹€æ…‹
            const otherResults =
              bill.results?.filter(
                (r) => r.participantId !== userParticipant.id
              ) || [];
            const allPaid =
              otherResults.length > 0 &&
              otherResults.every((r) => r.paymentStatus === "paid");
            const somePending = otherResults.some(
              (r) => r.paymentStatus === "pending"
            );

            if (allPaid) {
              statusClass = "status-paid";
              statusText = "å…¨éƒ¨å·²æ”¶";
              statusIcon = "fa-check-circle";
            } else if (somePending) {
              statusClass = "status-pending";
              statusText = "å¾…æ”¶æ¬¾";
              statusIcon = "fa-clock";
            } else {
              statusClass = "status-paid";
              statusText = "éƒ¨åˆ†å·²æ”¶";
              statusIcon = "fa-check-circle";
            }
          } else {
            // åƒèˆ‡è€…ï¼šé¡¯ç¤ºè‡ªå·±çš„æ”¯ä»˜ç‹€æ…‹
            statusClass =
              userStatus === "paid" ? "status-paid" : "status-pending";
            statusText = userStatus === "paid" ? "å·²æ”¯ä»˜" : "å¾…æ”¯ä»˜";
            statusIcon = userStatus === "paid" ? "fa-check-circle" : "fa-clock";
          }

          // è¨ˆç®—æ‡‰æ”¶æ¬¾å’Œæ‡‰ä»˜æ¬¾
          let receivablesAmount = 0;
          let payablesAmount = 0;
          let receivablesCount = 0;
          let payablesCount = 0;

          if (isPayer) {
            // ä»˜æ¬¾äººï¼šæ‡‰æ”¶æ¬¾ = ç¸½é‡‘é¡ - è‡ªå·±çš„åˆ†æ”¤
            receivablesAmount = totalAmount - userAmount;
            receivablesCount = bill.participants.length - 1;
          } else {
            // éä»˜æ¬¾äººï¼šæ‡‰ä»˜æ¬¾ = è‡ªå·±çš„åˆ†æ”¤
            payablesAmount = userAmount;
            payablesCount = 1;
          }

          billDiv.innerHTML = `
             <div class="space-y-4">
               <!-- æ¨™é¡Œå’Œç‹€æ…‹è¡Œ -->
               <div class="flex items-start justify-between">
                 <div class="flex-1 min-w-0">
                   <h3 class="text-lg sm:text-xl font-bold text-gray-900 mb-2 truncate">${
                     bill.name || "æœªå‘½åèšæœƒ"
                   }</h3>
                   <div class="flex flex-wrap items-center gap-2">
                     <span class="px-3 py-1.5 rounded-full text-xs font-semibold ${statusClass} shadow-sm">
                       <i class="fa ${statusIcon} mr-1.5"></i>${statusText}
                     </span>
                     ${
                       isPayer
                         ? '<span class="px-3 py-1.5 rounded-full text-xs font-semibold bg-blue-100 text-blue-800 shadow-sm"><i class="fa fa-credit-card mr-1.5"></i>ä»˜æ¬¾äºº</span>'
                         : ""
                     }
                   </div>
                 </div>
               </div>

               <!-- åŸºæœ¬ä¿¡æ¯è¡Œ -->
               <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm text-gray-600">
                 <div class="flex items-center">
                   <i class="fa fa-calendar text-gray-400 mr-2 w-4"></i>
                   <span>${formattedDate}</span>
                 </div>
                 <div class="flex items-center">
                   <i class="fa fa-map-marker text-gray-400 mr-2 w-4"></i>
                   <span class="truncate">${
                     bill.location || "æœªæŒ‡å®šåœ°é»"
                   }</span>
                 </div>
                 <div class="flex items-center">
                   <i class="fa fa-users text-gray-400 mr-2 w-4"></i>
                   <span>${bill.participants.length}ä½åƒèˆ‡è€…</span>
                 </div>
               </div>

               <!-- é‡‘é¡ä¿¡æ¯å¡ç‰‡ -->
               <div class="bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl p-4 space-y-3 border border-gray-200">
                 <div class="flex justify-between items-center">
                   <span class="text-sm text-gray-600">ç¸½é‡‘é¡</span>
                   <span class="text-lg font-bold text-gray-900">$${totalAmount.toFixed(
                     2
                   )}</span>
                 </div>
                 ${
                   userResult
                     ? `
                 <div class="flex justify-between items-center">
                   <span class="text-sm text-gray-600">æ‚¨çš„åˆ†æ”¤</span>
                   <span class="text-base font-semibold text-gray-700">$${userResult.amount.toFixed(
                     2
                   )}</span>
                 </div>
                 `
                     : ""
                 }
                 ${
                   isPayer
                     ? `
                 <div class="border-t pt-3">
                   <div class="flex justify-between items-center mb-2">
                     <span class="text-sm text-gray-600">æ‡‰æ”¶æ¬¾</span>
                     <span class="text-lg font-bold text-purple-600">$${receivablesAmount.toFixed(
                       2
                     )}</span>
                   </div>
                   ${(() => {
                     const otherResults =
                       bill.results?.filter(
                         (r) => r.participantId !== userParticipant.id
                       ) || [];
                     const paidCount = otherResults.filter(
                       (r) => r.paymentStatus === "paid"
                     ).length;
                     const pendingCount = otherResults.filter(
                       (r) => r.paymentStatus === "pending"
                     ).length;
                     return `
                       <div class="flex justify-between text-xs">
                         <span class="text-gray-500">æ”¶æ¬¾é€²åº¦</span>
                         <div class="flex gap-2">
                           ${
                             paidCount > 0
                               ? `<span class="text-green-600 font-medium">å·²æ”¶${paidCount}ç­†</span>`
                               : ""
                           }
                           ${paidCount > 0 && pendingCount > 0 ? "Â·" : ""}
                           ${
                             pendingCount > 0
                               ? `<span class="text-orange-600 font-medium">å¾…æ”¶${pendingCount}ç­†</span>`
                               : ""
                           }
                         </div>
                       </div>
                     `;
                   })()}
                 </div>
                 `
                     : `
                 <div class="border-t pt-3">
                   <div class="flex justify-between items-center">
                     <span class="text-sm text-gray-600">æ‡‰ä»˜æ¬¾</span>
                     <span class="text-lg font-bold text-red-600">$${payablesAmount.toFixed(
                       2
                     )}</span>
                   </div>
                 </div>
                 `
                 }
               </div>

               <!-- æ“ä½œæŒ‰éˆ• -->
               <div class="flex flex-col sm:flex-row gap-3 pt-3 border-t border-gray-200">
                 <button class="btn-secondary text-sm flex-1 min-h-[44px]" onclick="viewBillDetails('${
                   bill.id
                 }')">
                   <i class="fa fa-eye mr-2"></i>æŸ¥çœ‹è©³æƒ…
                 </button>
                ${
                  userStatus === "pending" && userParticipant && !isPayer
                    ? `
                  <button class="btn-primary text-sm flex-1 min-h-[44px]" onclick="openPaymentModal('${bill.id}', '${userParticipant.id}')">
                    <i class="fa fa-credit-card mr-2"></i>æ¨™è¨˜å·²æ”¯ä»˜
                  </button>
                `
                    : ""
                }
                 ${
                   isPayer && receivablesAmount > 0
                     ? `
                  <button class="btn-secondary text-sm flex-1 min-h-[44px]" onclick="viewReceivables('${bill.id}')">
                    <i class="fa fa-list mr-2"></i>æŸ¥çœ‹æ‡‰æ”¶æ¬¾
                  </button>
                `
                     : ""
                 }
               </div>
             </div>
           `;

          return billDiv;
        }

        // æ›´æ–°çµ±è¨ˆä¿¡æ¯
        function updateStatistics(billsToShow) {
          const total = billsToShow.length;
          const currentUser = window.authManager.getCurrentUser();

          let myPending = 0; // æˆ‘çš„å¾…æ”¯ä»˜
          let myPaid = 0; // æˆ‘çš„å·²æ”¯ä»˜
          let receivablesPending = 0; // æ‡‰æ”¶æ¬¾-å¾…æ”¶ï¼ˆé‡‘é¡ï¼‰
          let receivablesPaid = 0; // æ‡‰æ”¶æ¬¾-å·²æ”¶ï¼ˆé‡‘é¡ï¼‰
          let receivablesPendingCount = 0; // å¾…æ”¶ç­†æ•¸
          let receivablesPaidCount = 0; // å·²æ”¶ç­†æ•¸
          let totalPayables = 0; // æ‡‰ä»˜æ¬¾ç¸½é¡
          let payablesCount = 0;

          billsToShow.forEach((bill) => {
            // é€šéç”¨æˆ¶ååŒ¹é…åƒèˆ‡è€…
            const userParticipant = bill.participants.find(
              (p) => p.name === currentUser.username
            );

            // å¦‚æœæ‰¾ä¸åˆ°ç”¨æˆ¶åƒèˆ‡è€…ï¼Œè·³éæ­¤è³¬å–®
            if (!userParticipant) return;

            const userResult = (bill.results || []).find(
              (r) => r.participantId === userParticipant.id
            );

            const isPayer = bill.payerId === userParticipant.id;
            const totalAmount = bill.items.reduce(
              (sum, item) => sum + item.amount,
              0
            );
            const userAmount = userResult ? userResult.amount : 0;

            if (isPayer) {
              // ä»˜æ¬¾äººè§’è‰²ï¼šè¨ˆç®—æ‡‰æ”¶æ¬¾
              const otherResults =
                bill.results?.filter(
                  (r) => r.participantId !== userParticipant.id
                ) || [];

              otherResults.forEach((r) => {
                if (r.paymentStatus === "pending") {
                  receivablesPending += r.amount || 0;
                  receivablesPendingCount++;
                } else if (r.paymentStatus === "paid") {
                  receivablesPaid += r.amount || 0;
                  receivablesPaidCount++;
                }
              });
            } else {
              // åƒèˆ‡è€…è§’è‰²ï¼šè¨ˆç®—æ‡‰ä»˜æ¬¾å’Œæˆ‘çš„æ”¯ä»˜ç‹€æ…‹
              if (userResult) {
                if (userResult.paymentStatus === "pending") {
                  myPending++;
                } else {
                  myPaid++;
                }
                totalPayables += userAmount;
                payablesCount++;
              }
            }
          });

          // æ›´æ–°çµ±è¨ˆå¡ç‰‡
          // ç¬¬ä¸€è¡Œï¼šç¸½æ•¸ã€å¾…æ”¯ä»˜ã€å·²æ”¯ä»˜ã€æ‡‰æ”¶æ¬¾ç­†æ•¸ã€å·²æ”¶æ¬¾ç­†æ•¸
          totalBillsEl.textContent = total;
          pendingBillsEl.textContent = myPending;
          paidBillsEl.textContent = myPaid;
          document.getElementById("receivables-pending-count").textContent =
            receivablesPendingCount;
          document.getElementById("receivables-paid-count").textContent =
            receivablesPaidCount;

          // ç¬¬äºŒè¡Œï¼šå¾…æ”¯ä»˜ç¸½é¡ã€æ‡‰æ”¶æ¬¾ç¸½é¡
          payablesEl.textContent = `$${totalPayables.toFixed(2)}`;
          payablesCountEl.textContent = `${payablesCount}ç­†`;

          const totalReceivables = receivablesPending + receivablesPaid;
          document.getElementById(
            "receivables-total"
          ).textContent = `$${totalReceivables.toFixed(2)}`;
          document.getElementById(
            "receivables-pending-amount"
          ).textContent = `$${receivablesPending.toFixed(2)}`;
          document.getElementById(
            "receivables-paid-amount"
          ).textContent = `$${receivablesPaid.toFixed(2)}`;
        }

        // ç¯©é¸è³¬å–®
        function filterBills() {
          const searchTerm = searchInput.value.toLowerCase();
          const statusFilterValue = statusFilter.value;
          const dateFilterValue = dateFilter.value;

          let filteredBills = bills.filter((bill) => {
            // æœç´¢ç¯©é¸
            const matchesSearch =
              !searchTerm ||
              bill.name.toLowerCase().includes(searchTerm) ||
              bill.location.toLowerCase().includes(searchTerm) ||
              bill.participants.some((p) =>
                p.name.toLowerCase().includes(searchTerm)
              );

            // ç‹€æ…‹ç¯©é¸
            const currentUser = window.authManager.getCurrentUser();
            const userParticipant = bill.participants.find(
              (p) => p.name === currentUser.username
            );
            const userResult = userParticipant
              ? (bill.results || []).find(
                  (r) => r.participantId === userParticipant.id
                )
              : null;
            const isPayer = bill.payerId === userParticipant?.id;
            const userStatus = userResult?.paymentStatus || "pending";

            let matchesStatus = true;
            if (statusFilterValue) {
              switch (statusFilterValue) {
                case "my-pending":
                  // æˆ‘çš„å¾…æ”¯ä»˜ï¼ˆä½œç‚ºåƒèˆ‡è€…ï¼Œå°šæœªæ”¯ä»˜ï¼‰
                  matchesStatus = !isPayer && userStatus === "pending";
                  break;
                case "my-paid":
                  // æˆ‘çš„å·²æ”¯ä»˜ï¼ˆä½œç‚ºåƒèˆ‡è€…ï¼Œå·²æ”¯ä»˜ï¼‰
                  matchesStatus = !isPayer && userStatus === "paid";
                  break;
                case "receivable-pending":
                  // æ‡‰æ”¶æ¬¾-å¾…æ”¶ï¼ˆä½œç‚ºä»˜æ¬¾äººï¼Œæœ‰äººé‚„æ²’ä»˜ï¼‰
                  if (!isPayer || !userParticipant) {
                    matchesStatus = false;
                  } else {
                    const otherResults =
                      bill.results?.filter(
                        (r) => r.participantId !== userParticipant.id
                      ) || [];
                    matchesStatus = otherResults.some(
                      (r) => r.paymentStatus === "pending"
                    );
                  }
                  break;
                case "receivable-paid":
                  // æ‡‰æ”¶æ¬¾-å·²æ”¶ï¼ˆä½œç‚ºä»˜æ¬¾äººï¼Œæœ‰äººå·²ä»˜ï¼‰
                  if (!isPayer || !userParticipant) {
                    matchesStatus = false;
                  } else {
                    const otherResults =
                      bill.results?.filter(
                        (r) => r.participantId !== userParticipant.id
                      ) || [];
                    matchesStatus = otherResults.some(
                      (r) => r.paymentStatus === "paid"
                    );
                  }
                  break;
                default:
                  matchesStatus = true;
              }
            }

            // æ—¥æœŸç¯©é¸
            const billDate = new Date(bill.date);
            const now = new Date();
            let matchesDate = true;

            if (dateFilterValue) {
              switch (dateFilterValue) {
                case "today":
                  matchesDate = billDate.toDateString() === now.toDateString();
                  break;
                case "week":
                  const weekAgo = new Date(
                    now.getTime() - 7 * 24 * 60 * 60 * 1000
                  );
                  matchesDate = billDate >= weekAgo;
                  break;
                case "month":
                  matchesDate =
                    billDate.getMonth() === now.getMonth() &&
                    billDate.getFullYear() === now.getFullYear();
                  break;
                case "year":
                  matchesDate = billDate.getFullYear() === now.getFullYear();
                  break;
              }
            }

            return matchesSearch && matchesStatus && matchesDate;
          });

          displayBills(filteredBills);
        }

        // æ‰“é–‹æ”¯ä»˜æ¨¡æ…‹æ¡†
        function openPaymentModal(billId, participantId) {
          currentBillId = billId;
          currentParticipantId = participantId;
          paymentModal.classList.remove("opacity-0", "invisible");
          paymentModal.querySelector(".bg-white").classList.remove("scale-95");
          paymentModal.querySelector(".bg-white").classList.add("scale-100");
        }

        // é—œé–‰æ”¯ä»˜æ¨¡æ…‹æ¡†
        function closePaymentModal() {
          paymentModal.classList.add("opacity-0", "invisible");
          paymentModal.querySelector(".bg-white").classList.add("scale-95");
          paymentModal.querySelector(".bg-white").classList.remove("scale-100");
          currentBillId = null;
          currentParticipantId = null;
          resetPaymentModal();
        }

        // é‡ç½®æ”¯ä»˜æ¨¡æ…‹æ¡†
        function resetPaymentModal() {
          paymentStatusSelect.value = "pending";
          receiptUploadSection.classList.add("hidden");
          receiptPreview.classList.add("hidden");
          receiptFile.value = "";
        }

        // åˆ‡æ›æ†‘è­‰ä¸Šå‚³å€åŸŸ
        function toggleReceiptUpload() {
          if (paymentStatusSelect.value === "paid") {
            receiptUploadSection.classList.remove("hidden");
          } else {
            receiptUploadSection.classList.add("hidden");
            receiptPreview.classList.add("hidden");
          }
        }

        // è™•ç†æ†‘è­‰ä¸Šå‚³
        function handleReceiptUpload(event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              receiptImage.src = e.target.result;
              receiptPreview.classList.remove("hidden");
            };
            reader.readAsDataURL(file);
          }
        }

        // ç§»é™¤æ†‘è­‰
        function removeReceipt() {
          receiptFile.value = "";
          receiptPreview.classList.add("hidden");
        }

        // ä¿å­˜æ”¯ä»˜ç‹€æ…‹
        async function savePaymentStatus() {
          if (!currentBillId || !currentParticipantId) {
            console.error("ç¼ºå°‘å¿…è¦åƒæ•¸:", {
              currentBillId,
              currentParticipantId,
            });
            return;
          }

          const paymentStatus = paymentStatusSelect.value;
          const receiptFile = document.getElementById("receipt-file").files[0];

          console.log("æº–å‚™æ›´æ–°æ”¯ä»˜ç‹€æ…‹:", {
            billId: currentBillId,
            participantId: currentParticipantId,
            paymentStatus,
            hasReceipt: !!receiptFile,
          });

          try {
            const formData = new FormData();
            formData.append("billId", currentBillId);
            formData.append("participantId", currentParticipantId);
            formData.append("paymentStatus", paymentStatus);

            if (receiptFile) {
              console.log("æ”¶æ“šæ–‡ä»¶:", receiptFile.name, receiptFile.size);
              formData.append("receipt", receiptFile);
            }

            console.log("ç™¼é€è«‹æ±‚åˆ° /api/bill/payment-status");
            const response = await authenticatedFetch(
              "/api/bill/payment-status",
              {
                method: "POST",
                body: formData,
              }
            );

            if (!response) {
              console.log("èªè­‰å¤±æ•—ï¼Œå·²é‡å®šå‘");
              return;
            }

            console.log("APIéŸ¿æ‡‰ç‹€æ…‹:", response.status);

            if (response.ok) {
              const result = await response.json();
              console.log("APIéŸ¿æ‡‰æ•¸æ“š:", result);
              alert("æ”¯ä»˜ç‹€æ…‹å·²æ›´æ–°");
              closePaymentModal();
              console.log("é–‹å§‹é‡æ–°åŠ è¼‰è³¬å–®åˆ—è¡¨");
              await loadBills(); // é‡æ–°åŠ è¼‰è³¬å–®åˆ—è¡¨
              console.log("è³¬å–®åˆ—è¡¨å·²é‡æ–°åŠ è¼‰");
            } else {
              const errorText = await response.text();
              console.error("APIéŒ¯èª¤éŸ¿æ‡‰:", errorText);
              try {
                const error = JSON.parse(errorText);
                alert(`æ›´æ–°å¤±æ•—: ${error.error}`);
              } catch {
                alert(`æ›´æ–°å¤±æ•—: ${response.status} ${response.statusText}`);
              }
            }
          } catch (error) {
            console.error("æ›´æ–°æ”¯ä»˜ç‹€æ…‹æ™‚å‡ºéŒ¯:", error);
            alert(`æ›´æ–°æ”¯ä»˜ç‹€æ…‹æ™‚å‡ºéŒ¯: ${error.message}`);
          }
        }

        // æŸ¥çœ‹è³¬å–®è©³æƒ…
        function viewBillDetails(billId) {
          const bill = bills.find((b) => b.id === billId);
          if (!bill) return;

          const currentUser = window.authManager.getCurrentUser();
          const userParticipant = bill.participants.find(
            (p) => p.name === currentUser.username
          );
          const userResult = bill.results?.find(
            (r) => r.participantId === userParticipant?.id
          );
          const isPayer = bill.payerId === userParticipant?.id;
          const totalAmount = bill.items.reduce(
            (sum, item) => sum + item.amount,
            0
          );

          // æ§‹å»ºé …ç›®åˆ—è¡¨
          let itemsHTML = bill.items
            .map((item) => {
              const participants = item.participantsIds
                ?.map((pid) => {
                  const p = bill.participants.find((x) => x.id === pid);
                  return p?.name || "æœªçŸ¥";
                })
                .join(", ");

              return `
              <div class="flex justify-between items-start py-2 border-b">
                <div class="flex-1">
                  <div class="font-medium">${item.name}</div>
                  <div class="text-sm text-gray-500">
                    ${
                      item.isShared
                        ? `å…±äº«: ${participants}`
                        : `å€‹äºº: ${participants}`
                    }
                  </div>
                </div>
                <div class="font-semibold">$${item.amount.toFixed(2)}</div>
              </div>
            `;
            })
            .join("");

          // æ§‹å»ºåƒèˆ‡è€…åˆ—è¡¨ï¼ˆåŒ…å«æ”¶æ“šï¼‰
          let participantsHTML = bill.results
            .map((result) => {
              const participant = bill.participants.find(
                (p) => p.id === result.participantId
              );
              const isPaid = result.paymentStatus === "paid";
              const status = isPaid ? "å·²æ”¯ä»˜" : "å¾…æ”¯ä»˜";
              const statusClass = isPaid ? "text-green-600" : "text-orange-600";
              const isThisPayer = result.participantId === bill.payerId;
              const hasReceipt = result.receiptImageUrl;
              const shouldShowReceipt = hasReceipt && !isThisPayer && isPaid;

              return `
              <div class="py-3 border-b">
                <div class="flex justify-between items-start">
                  <div class="flex items-center gap-2 flex-1">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                      <i class="fa fa-user text-blue-600"></i>
                    </div>
                    <div>
                      <div class="flex items-center gap-2">
                        <span class="font-medium">${
                          participant?.name || "æœªçŸ¥"
                        }</span>
                        ${
                          isThisPayer
                            ? '<span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded">ä»˜æ¬¾äºº</span>'
                            : ""
                        }
                      </div>
                      <div class="text-xs text-gray-500 mt-1">
                        é‡‘é¡: $${result.amount?.toFixed(2) || "0.00"}
                        <span class="ml-2 ${statusClass}">${status}</span>
                      </div>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    ${
                      shouldShowReceipt
                        ? `
                      <button 
                        onclick="viewReceipt('${result.receiptImageUrl}')" 
                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-xs flex items-center gap-1">
                        <i class="fa fa-image"></i>
                        <span>ä»˜æ¬¾æ†‘è­‰</span>
                      </button>
                    `
                        : ""
                    }
                  </div>
                </div>
              </div>
            `;
            })
            .join("");

          const content = `
            <div class="space-y-4">
              <!-- åŸºæœ¬ä¿¡æ¯ -->
              <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded">
                <div>
                  <div class="text-sm text-gray-600">è³¬å–®åç¨±</div>
                  <div class="font-semibold">${bill.name || "(ç„¡åç¨±)"}</div>
                </div>
                <div>
                  <div class="text-sm text-gray-600">æ—¥æœŸ</div>
                  <div class="font-semibold">${bill.date}</div>
                </div>
                <div>
                  <div class="text-sm text-gray-600">åœ°é»</div>
                  <div class="font-semibold">${bill.location || "æœªæŒ‡å®š"}</div>
                </div>
                <div>
                  <div class="text-sm text-gray-600">å°è²»æ¯”ä¾‹</div>
                  <div class="font-semibold">${bill.tipPercentage}%</div>
                </div>
              </div>

              <!-- æ‚¨çš„ç‹€æ…‹ -->
              <div class="p-4 ${
                isPayer ? "bg-purple-50" : "bg-blue-50"
              } rounded">
                <h4 class="font-bold mb-2">æ‚¨çš„ç‹€æ…‹</h4>
                <div class="space-y-1">
                  <div>è§’è‰²: ${isPayer ? "ğŸ’° ä»˜æ¬¾äºº" : "ğŸ‘¤ åƒèˆ‡è€…"}</div>
                  <div>æ‚¨çš„é‡‘é¡: <span class="font-bold">$${
                    userResult?.amount?.toFixed(2) || "0.00"
                  }</span></div>
                  <div>æ”¯ä»˜ç‹€æ…‹: ${
                    userResult?.paymentStatus === "paid"
                      ? "âœ… å·²æ”¯ä»˜"
                      : "â° å¾…æ”¯ä»˜"
                  }</div>
                  ${
                    isPayer
                      ? `<div class="mt-2 text-sm text-purple-700">æ‚¨å·²æ”¯ä»˜å…¨éƒ¨è³¬å–®ï¼Œç­‰å¾…å…¶ä»–äººä»˜æ¬¾</div>`
                      : ""
                  }
                </div>
              </div>

              <!-- ç¸½è³¬å–®æ”¶æ“š -->
              ${
                bill.payerReceiptUrl
                  ? `
              <div class="p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                <h4 class="font-bold mb-2 flex items-center">
                  <i class="fa fa-file-text text-yellow-600 mr-2"></i>ç¸½è³¬å–®æ”¶æ“š
                </h4>
                <p class="text-sm text-gray-600 mb-3">ä»˜æ¬¾äººæ”¯ä»˜çµ¦å•†å®¶çš„ç¸½è³¬å–®æ†‘è­‰</p>
                <button 
                  onclick="viewReceipt('${bill.payerReceiptUrl}')" 
                  class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 text-sm">
                  <i class="fa fa-image mr-1"></i>æŸ¥çœ‹ç¸½è³¬å–®æ”¶æ“š
                </button>
              </div>
              `
                  : ""
              }

              <!-- æ¶ˆè²»é …ç›® -->
              <div>
                <h4 class="font-bold mb-2 flex items-center">
                  <i class="fa fa-shopping-basket mr-2"></i>æ¶ˆè²»é …ç›®
                </h4>
                <div class="space-y-1">
                  ${itemsHTML}
                  <div class="flex justify-between items-center py-2 font-bold text-lg">
                    <span>ç¸½è¨ˆ</span>
                    <span>$${totalAmount.toFixed(2)}</span>
                  </div>
                </div>
              </div>

              <!-- åƒèˆ‡è€…åˆ†æ”¤ -->
              <div>
                <h4 class="font-bold mb-2 flex items-center">
                  <i class="fa fa-users mr-2"></i>åƒèˆ‡è€…åˆ†æ”¤
                </h4>
                <div class="space-y-1">
                  ${participantsHTML}
                </div>
              </div>
            </div>
          `;

          showDetailsModal("è³¬å–®è©³æƒ…", content);
        }

        // æŸ¥çœ‹æ‡‰æ”¶æ¬¾è©³æƒ…ï¼ˆäº’å‹•æ¨¡æ…‹æ¡†ï¼‰
        function viewReceivables(billId) {
          const bill = bills.find((b) => b.id === billId);
          if (!bill) return;

          const currentUser = window.authManager.getCurrentUser();
          const userParticipant = bill.participants.find(
            (p) => p.name === currentUser.username
          );
          const userResult = bill.results?.find(
            (r) => r.participantId === userParticipant?.id
          );

          const totalAmount = bill.items.reduce(
            (sum, item) => sum + item.amount,
            0
          );
          const otherParticipants =
            bill.results?.filter(
              (r) => r.participantId !== userParticipant?.id
            ) || [];

          // æ§‹å»ºåƒèˆ‡è€…åˆ—è¡¨ HTML
          let participantsHTML = "";
          otherParticipants.forEach((result) => {
            const participant = bill.participants.find(
              (p) => p.id === result.participantId
            );
            const isPaid = result.paymentStatus === "paid";
            const isConfirmed = result.confirmedByPayer || false;
            const receiptUrl = result.receiptImageUrl;

            participantsHTML += `
              <div class="border-b pb-4 mb-4">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <div class="font-semibold text-lg">${
                      participant?.name || "æœªçŸ¥"
                    }</div>
                    <div class="text-gray-600">æ‡‰ä»˜é‡‘é¡: $${
                      result.amount?.toFixed(2) || "0.00"
                    }</div>
                  </div>
                  <div class="text-right">
                    ${
                      isPaid
                        ? `<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">
                          <i class="fa fa-check-circle mr-1"></i>å·²æ”¯ä»˜
                          ${
                            isConfirmed
                              ? '<i class="fa fa-check text-green-600 ml-1" title="å·²ç¢ºèª"></i>'
                              : ""
                          }
                         </span>`
                        : `<span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm">
                          <i class="fa fa-clock mr-1"></i>å¾…æ”¯ä»˜
                         </span>`
                    }
                  </div>
                </div>
                ${
                  isPaid
                    ? `
                  <div class="mt-3 flex gap-2">
                    ${
                      receiptUrl
                        ? `
                      <button 
                        onclick="viewReceipt('${receiptUrl}')" 
                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-sm">
                        <i class="fa fa-image mr-1"></i>æŸ¥çœ‹æ”¶æ“š
                      </button>
                    `
                        : '<span class="text-gray-400 text-sm">ç„¡æ”¶æ“š</span>'
                    }
                    ${
                      !isConfirmed
                        ? `
                      <button 
                        onclick="confirmPayment('${billId}', '${result.participantId}')" 
                        class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                        <i class="fa fa-check mr-1"></i>ç¢ºèªæ”¶æ¬¾
                      </button>
                      <button 
                        onclick="rejectPayment('${billId}', '${result.participantId}', 'not_received')" 
                        class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm">
                        <i class="fa fa-times mr-1"></i>æœªæ”¶åˆ°æ¬¾
                      </button>
                      <button 
                        onclick="rejectPayment('${billId}', '${result.participantId}', 'wrong_receipt')" 
                        class="px-3 py-1 bg-orange-100 text-orange-700 rounded hover:bg-orange-200 text-sm">
                        <i class="fa fa-exclamation mr-1"></i>éŒ¯èª¤å–®æ“š
                      </button>
                    `
                        : '<span class="text-green-600 text-sm"><i class="fa fa-check-circle mr-1"></i>å·²ç¢ºèªæ”¶æ¬¾</span>'
                    }
                  </div>
                `
                    : ""
                }
              </div>
            `;
          });

          const content = `
            <div class="mb-4">
              <div class="grid grid-cols-2 gap-4 mb-4 p-4 bg-gray-50 rounded">
                <div>
                  <div class="text-sm text-gray-600">è³¬å–®åç¨±</div>
                  <div class="font-semibold">${bill.name || "(ç„¡åç¨±)"}</div>
                </div>
                <div>
                  <div class="text-sm text-gray-600">æ—¥æœŸ</div>
                  <div class="font-semibold">${bill.date}</div>
                </div>
                <div>
                  <div class="text-sm text-gray-600">ç¸½é‡‘é¡</div>
                  <div class="font-semibold text-blue-600">$${totalAmount.toFixed(
                    2
                  )}</div>
                </div>
                <div>
                  <div class="text-sm text-gray-600">æ‚¨çš„åˆ†æ”¤</div>
                  <div class="font-semibold">$${
                    userResult?.amount?.toFixed(2) || "0.00"
                  }</div>
                </div>
              </div>
              
              <h4 class="font-bold text-lg mb-3 flex items-center">
                <i class="fa fa-users mr-2"></i>å…¶ä»–åƒèˆ‡è€… (${
                  otherParticipants.length
                }äºº)
              </h4>
              ${participantsHTML || '<p class="text-gray-500">ç„¡å…¶ä»–åƒèˆ‡è€…</p>'}
            </div>
          `;

          showDetailsModal("æ‡‰æ”¶æ¬¾è©³æƒ…", content);
        }

        // é¡¯ç¤ºè©³æƒ…æ¨¡æ…‹æ¡†
        function showDetailsModal(title, content) {
          const modal = document.createElement("div");
          modal.className =
            "fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto p-4";
          modal.innerHTML = `
            <div class="bg-white rounded-lg max-w-2xl w-full my-4">
              <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-bold">${title}</h3>
                  <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                  </button>
                </div>
                <div>${content}</div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);

          // é»æ“ŠèƒŒæ™¯é—œé–‰
          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              modal.remove();
            }
          });
        }

        // æŸ¥çœ‹æ”¶æ“šåœ–ç‰‡
        async function viewReceipt(receiptUrl) {
          const modal = document.createElement("div");
          modal.className =
            "fixed inset-0 bg-black bg-opacity-75 flex items-start justify-center z-50 overflow-y-auto p-4";
          modal.innerHTML = `
            <div class="max-w-4xl w-full my-4">
              <div class="bg-white rounded-lg p-4">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-bold">ä»˜æ¬¾æ†‘è­‰</h3>
                  <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times text-xl"></i>
                  </button>
                </div>
                <div class="flex justify-center items-center min-h-[200px]">
                  <i class="fa fa-spinner fa-spin text-4xl text-primary"></i>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);

          // é»æ“ŠèƒŒæ™¯é—œé–‰
          modal.addEventListener("click", (e) => {
            if (e.target === modal) {
              modal.remove();
            }
          });

          // ä½¿ç”¨èªè­‰çš„ fetch è«‹æ±‚ç²å–åœ–ç‰‡
          try {
            const sessionId = localStorage.getItem("sessionId");
            const response = await fetch(receiptUrl, {
              headers: {
                "X-Session-ID": sessionId,
              },
            });

            if (!response.ok) {
              throw new Error("ç„¡æ³•åŠ è¼‰æ”¶æ“šåœ–ç‰‡");
            }

            // ç²å–åœ–ç‰‡ blob
            const blob = await response.blob();
            const imageUrl = URL.createObjectURL(blob);

            // æ›´æ–° modal å…§å®¹
            const contentDiv = modal.querySelector(".min-h-\\[200px\\]");
            if (contentDiv) {
              contentDiv.innerHTML = `<img src="${imageUrl}" class="max-w-full h-auto rounded-lg" />`;
            }
          } catch (error) {
            console.error("åŠ è¼‰æ”¶æ“šå¤±æ•—:", error);
            const contentDiv = modal.querySelector(".min-h-\\[200px\\]");
            if (contentDiv) {
              contentDiv.innerHTML = `
                <div class="text-center text-red-600">
                  <i class="fa fa-exclamation-circle text-4xl mb-2"></i>
                  <p>ç„¡æ³•åŠ è¼‰æ”¶æ“šåœ–ç‰‡</p>
                </div>
              `;
            }
          }
        }

        // ç¢ºèªæ”¶æ¬¾ï¼ˆä»˜æ¬¾äººç¢ºèªæ”¶åˆ°å…¶ä»–äººçš„ä»˜æ¬¾ï¼‰
        async function confirmPayment(billId, participantId) {
          if (!confirm("ç¢ºèªå·²æ”¶åˆ°æ­¤ç­†æ¬¾é …ï¼Ÿ")) return;

          try {
            const response = await authenticatedFetch(
              "/api/bill/confirm-payment",
              {
                method: "POST",
                body: JSON.stringify({
                  billId,
                  participantId,
                  confirmed: true,
                }),
              }
            );

            if (response.ok) {
              alert("å·²ç¢ºèªæ”¶æ¬¾");
              // é—œé–‰ç•¶å‰æ¨¡æ…‹æ¡†
              document.querySelector(".fixed.inset-0")?.remove();
              // é‡æ–°åŠ è¼‰è³¬å–®åˆ—è¡¨
              loadBills();
            } else {
              alert("ç¢ºèªæ”¶æ¬¾å¤±æ•—");
            }
          } catch (error) {
            console.error("Error confirming payment:", error);
            alert("ç¢ºèªæ”¶æ¬¾æ™‚å‡ºéŒ¯");
          }
        }

        // æ‹’çµ•æ”¶æ¬¾(ä»˜æ¬¾äººæ¨™è¨˜å•é¡Œ)
        async function rejectPayment(billId, participantId, reason) {
          const reasonText =
            reason === "not_received" ? "æœªæ”¶åˆ°æ¬¾é …" : "æ”¶æ“šæœ‰èª¤";
          const confirmText = `ç¢ºèªæ¨™è¨˜ç‚ºã€Œ${reasonText}ã€ï¼Ÿ\n\næ­¤æ“ä½œå°‡:\n1. å°‡æ”¯ä»˜ç‹€æ…‹æ”¹å›ã€Œå¾…æ”¯ä»˜ã€\n2. é€šçŸ¥åƒèˆ‡è€…é‡æ–°è™•ç†`;

          if (!confirm(confirmText)) return;

          try {
            const response = await authenticatedFetch(
              "/api/bill/reject-payment",
              {
                method: "POST",
                body: JSON.stringify({
                  billId,
                  participantId,
                  reason,
                  rejectedAt: new Date().toISOString(),
                }),
              }
            );

            if (response.ok) {
              alert(`å·²æ¨™è¨˜ç‚ºã€Œ${reasonText}ã€ï¼Œè©²ç­†æ¬¾é …å·²é€€å›å¾…æ”¯ä»˜ç‹€æ…‹`);
              // é—œé–‰ç•¶å‰æ¨¡æ…‹æ¡†
              document.querySelector(".fixed.inset-0")?.remove();
              // é‡æ–°åŠ è¼‰è³¬å–®åˆ—è¡¨
              loadBills();
            } else {
              const error = await response.json();
              alert(error.message || "æ‹’çµ•æ”¶æ¬¾å¤±æ•—");
            }
          } catch (error) {
            console.error("Error rejecting payment:", error);
            alert("æ‹’çµ•æ”¶æ¬¾æ™‚å‡ºéŒ¯");
          }
        }

        // å…¨å±€å‡½æ•¸ï¼Œä¾›HTMLèª¿ç”¨
        window.openPaymentModal = openPaymentModal;
        window.viewBillDetails = viewBillDetails;
        window.viewReceivables = viewReceivables;
        window.viewReceipt = viewReceipt;
        window.confirmPayment = confirmPayment;
        window.rejectPayment = rejectPayment;
        window.showDetailsModal = showDetailsModal;
      });

      // å›åˆ°é ‚éƒ¨åŠŸèƒ½
      document.addEventListener("DOMContentLoaded", function () {
        const backToTopBtn = document.getElementById("back-to-top");

        // ç›£è½æ»¾å‹•äº‹ä»¶
        window.addEventListener("scroll", function () {
          if (window.pageYOffset > 300) {
            backToTopBtn.classList.remove("opacity-0", "invisible");
            backToTopBtn.classList.add("opacity-100", "visible");
          } else {
            backToTopBtn.classList.add("opacity-0", "invisible");
            backToTopBtn.classList.remove("opacity-100", "visible");
          }
        });

        // é»æ“Šå›åˆ°é ‚éƒ¨
        backToTopBtn.addEventListener("click", function () {
          window.scrollTo({
            top: 0,
            behavior: "smooth",
          });
        });
      });
    </script>

    <!-- å›åˆ°é ‚éƒ¨æŒ‰éˆ• -->
    <button
      id="back-to-top"
      class="fixed bottom-6 right-6 bg-primary text-white p-3 rounded-full shadow-lg hover:bg-primary/90 transition-all duration-300 opacity-0 invisible z-50 min-w-[48px] min-h-[48px] flex items-center justify-center"
      aria-label="å›åˆ°é ‚éƒ¨"
    >
      <i class="fa fa-arrow-up text-lg"></i>
    </button>
  </body>
</html>
