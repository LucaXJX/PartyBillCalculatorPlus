<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PBC 綜合自動測試</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <style>
      .test-pass {
        background-color: #dcfce7;
        border-left: 4px solid #22c55e;
      }
      .test-fail {
        background-color: #fee2e2;
        border-left: 4px solid #ef4444;
      }
      .test-running {
        background-color: #fef3c7;
        border-left: 4px solid #f59e0b;
      }
      .test-pending {
        background-color: #f3f4f6;
        border-left: 4px solid #9ca3af;
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto p-6">
      <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h1 class="text-3xl font-bold mb-2 flex items-center">
          <i class="fa fa-flask text-blue-600 mr-3"></i>
          PBC 聚賬通 - 綜合自動測試
        </h1>
        <p class="text-gray-600 mb-4">
          自動測試所有功能，包括參與者卡片系統、賬單計算、付款流程和消息系統
        </p>

        <!-- 控制面板 -->
        <div class="flex gap-4 mb-6">
          <button
            id="run-all-tests"
            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold"
          >
            <i class="fa fa-play mr-2"></i>運行所有測試
          </button>
          <button
            id="run-stress-test"
            class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition-colors font-semibold"
          >
            <i class="fa fa-fire mr-2"></i>壓力測試
          </button>
          <button
            id="generate-report"
            class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold"
          >
            <i class="fa fa-file-alt mr-2"></i>生成報告
          </button>
          <button
            id="clear-results"
            class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors font-semibold"
          >
            <i class="fa fa-trash mr-2"></i>清空結果
          </button>
        </div>

        <!-- 測試進度 -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <div class="flex items-center justify-between mb-2">
            <span class="font-semibold">測試進度</span>
            <span id="progress-text" class="text-sm text-gray-600">0 / 0</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-4">
            <div
              id="progress-bar"
              class="bg-blue-600 h-4 rounded-full transition-all duration-300"
              style="width: 0%"
            ></div>
          </div>
        </div>

        <!-- 統計信息 -->
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
            <div class="text-sm text-gray-600">通過</div>
            <div id="pass-count" class="text-2xl font-bold text-green-600">
              0
            </div>
          </div>
          <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
            <div class="text-sm text-gray-600">失敗</div>
            <div id="fail-count" class="text-2xl font-bold text-red-600">0</div>
          </div>
          <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
            <div class="text-sm text-gray-600">運行中</div>
            <div id="running-count" class="text-2xl font-bold text-yellow-600">
              0
            </div>
          </div>
          <div class="bg-gray-50 border-l-4 border-gray-400 p-4 rounded">
            <div class="text-sm text-gray-600">待測試</div>
            <div id="pending-count" class="text-2xl font-bold text-gray-600">
              0
            </div>
          </div>
        </div>
      </div>

      <!-- 測試結果 -->
      <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold mb-4">測試結果</h2>
        <div id="test-results" class="space-y-3">
          <div class="text-gray-500 text-center py-8">
            點擊"運行所有測試"開始測試
          </div>
        </div>
      </div>

      <!-- 測試日誌 -->
      <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
        <h2 class="text-2xl font-bold mb-4">詳細日誌</h2>
        <div
          id="test-logs"
          class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm h-64 overflow-y-auto"
        >
          等待測試開始...
        </div>
      </div>
    </div>

    <script>
      // 測試配置
      const API_BASE = "http://localhost:3000/api";
      const TEST_USERS = [
        { username: "testuser", email: "test@example.com", password: "123456" },
        {
          username: "testuser2",
          email: "test2@example.com",
          password: "123456",
        },
        { username: "adaY", email: "ada@ede.com", password: "123456" },
      ];

      // 測試結果存儲
      let testResults = {
        total: 0,
        passed: 0,
        failed: 0,
        running: 0,
        pending: 0,
        tests: [],
        startTime: null,
        endTime: null,
      };

      // DOM 元素
      const progressBar = document.getElementById("progress-bar");
      const progressText = document.getElementById("progress-text");
      const passCount = document.getElementById("pass-count");
      const failCount = document.getElementById("fail-count");
      const runningCount = document.getElementById("running-count");
      const pendingCount = document.getElementById("pending-count");
      const testResultsContainer = document.getElementById("test-results");
      const testLogs = document.getElementById("test-logs");

      // 日誌函數
      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const colors = {
          info: "text-green-400",
          error: "text-red-400",
          warn: "text-yellow-400",
          success: "text-blue-400",
        };
        const color = colors[type] || colors.info;

        testLogs.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
        testLogs.scrollTop = testLogs.scrollHeight;
      }

      // 更新統計
      function updateStats() {
        passCount.textContent = testResults.passed;
        failCount.textContent = testResults.failed;
        runningCount.textContent = testResults.running;
        pendingCount.textContent = testResults.pending;

        const progress =
          testResults.total > 0
            ? ((testResults.passed + testResults.failed) / testResults.total) *
              100
            : 0;
        progressBar.style.width = `${progress}%`;
        progressText.textContent = `${
          testResults.passed + testResults.failed
        } / ${testResults.total}`;
      }

      // 添加測試結果到UI
      function addTestResult(testName, status, message, duration) {
        const result = {
          name: testName,
          status,
          message,
          duration,
          timestamp: new Date().toISOString(),
        };
        testResults.tests.push(result);

        const statusClasses = {
          pass: "test-pass",
          fail: "test-fail",
          running: "test-running",
          pending: "test-pending",
        };

        const icons = {
          pass: '<i class="fa fa-check-circle text-green-600"></i>',
          fail: '<i class="fa fa-times-circle text-red-600"></i>',
          running: '<i class="fa fa-spinner fa-spin text-yellow-600"></i>',
          pending: '<i class="fa fa-clock text-gray-600"></i>',
        };

        const div = document.createElement("div");
        div.className = `${statusClasses[status]} p-4 rounded-lg`;
        div.innerHTML = `
          <div class="flex items-start justify-between">
            <div class="flex items-start gap-3 flex-1">
              <div class="mt-1">${icons[status]}</div>
              <div class="flex-1">
                <div class="font-semibold">${testName}</div>
                <div class="text-sm text-gray-600 mt-1">${message}</div>
                ${
                  duration
                    ? `<div class="text-xs text-gray-500 mt-1">耗時: ${duration}ms</div>`
                    : ""
                }
              </div>
            </div>
          </div>
        `;

        testResultsContainer.appendChild(div);
        return div;
      }

      // 認證函數
      async function login(email, password) {
        const response = await fetch(`${API_BASE}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(
            `登入失敗: ${errorData.error || response.statusText}`
          );
        }

        const data = await response.json();
        return data.sessionId;
      }

      // 認證請求
      async function authFetch(url, sessionId, options = {}) {
        const response = await fetch(url, {
          ...options,
          headers: {
            ...options.headers,
            "Content-Type": "application/json",
            Authorization: `Bearer ${sessionId}`,
          },
        });
        return response;
      }

      // ============ 測試套件 ============

      // 測試 1: 用戶認證
      async function testAuthentication() {
        const testName = "用戶認證測試";
        const startTime = Date.now();
        log(`開始測試: ${testName}`, "info");

        try {
          // 測試登入
          const sessionId = await login(
            TEST_USERS[0].email,
            TEST_USERS[0].password
          );

          if (!sessionId) {
            throw new Error("未返回 sessionId");
          }

          // 測試驗證
          const response = await authFetch(`${API_BASE}/bills`, sessionId, {
            method: "GET",
          });

          if (!response.ok) {
            throw new Error("認證驗證失敗");
          }

          const duration = Date.now() - startTime;
          log(`✓ ${testName} 通過 (${duration}ms)`, "success");
          addTestResult(testName, "pass", "登入和認證功能正常", duration);
          testResults.passed++;
          return sessionId;
        } catch (error) {
          const duration = Date.now() - startTime;
          log(`✗ ${testName} 失敗: ${error.message}`, "error");
          addTestResult(testName, "fail", error.message, duration);
          testResults.failed++;
          throw error;
        }
      }

      // 測試 2: 參與者卡片創建
      async function testParticipantCardCreation(sessionId) {
        const testName = "參與者卡片創建測試";
        const startTime = Date.now();
        log(`開始測試: ${testName}`, "info");

        try {
          // 重置賬單
          await authFetch(`${API_BASE}/bill/reset`, sessionId, {
            method: "POST",
          });

          // 添加多個參與者
          const participants = [];
          for (let i = 0; i < 5; i++) {
            const response = await authFetch(
              `${API_BASE}/participant`,
              sessionId,
              {
                method: "POST",
                body: JSON.stringify({ name: `測試用戶${i + 1}` }),
              }
            );

            if (!response.ok) {
              throw new Error(`添加參與者 ${i + 1} 失敗`);
            }

            const participant = await response.json();
            participants.push(participant);
          }

          // 驗證參與者數量
          const billResponse = await authFetch(
            `${API_BASE}/calculate`,
            sessionId
          );
          const billData = await billResponse.json();

          if (billData.bill.participants.length !== 5) {
            throw new Error(
              `參與者數量不符: 預期 5, 實際 ${billData.bill.participants.length}`
            );
          }

          const duration = Date.now() - startTime;
          log(`✓ ${testName} 通過 (${duration}ms)`, "success");
          addTestResult(testName, "pass", `成功創建 5 個參與者`, duration);
          testResults.passed++;
          return participants;
        } catch (error) {
          const duration = Date.now() - startTime;
          log(`✗ ${testName} 失敗: ${error.message}`, "error");
          addTestResult(testName, "fail", error.message, duration);
          testResults.failed++;
          throw error;
        }
      }

      // 測試 3: 參與者刪除
      async function testParticipantDeletion(sessionId, participants) {
        const testName = "參與者刪除測試";
        const startTime = Date.now();
        log(`開始測試: ${testName}`, "info");

        try {
          // 刪除第一個參與者
          const participantToDelete = participants[0];
          log(
            `嘗試刪除參與者: ${participantToDelete.name} (ID: ${participantToDelete.id})`,
            "info"
          );

          const response = await authFetch(
            `${API_BASE}/participant/${participantToDelete.id}`,
            sessionId,
            { method: "DELETE" }
          );

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(
              `刪除參與者失敗: HTTP ${response.status} - ${
                errorData.error || response.statusText
              }`
            );
          }

          log(`參與者刪除成功`, "success");

          // 驗證刪除後的數量
          const billResponse = await authFetch(
            `${API_BASE}/calculate`,
            sessionId
          );
          const billData = await billResponse.json();

          if (billData.bill.participants.length !== 4) {
            throw new Error(
              `刪除後參與者數量不符: 預期 4, 實際 ${billData.bill.participants.length}`
            );
          }

          const duration = Date.now() - startTime;
          log(`✓ ${testName} 通過 (${duration}ms)`, "success");
          addTestResult(testName, "pass", "刪除參與者功能正常", duration);
          testResults.passed++;
        } catch (error) {
          const duration = Date.now() - startTime;
          log(`✗ ${testName} 失敗: ${error.message}`, "error");
          addTestResult(testName, "fail", error.message, duration);
          testResults.failed++;
        }
      }

      // 測試 4: 防止重複參與者
      async function testDuplicateParticipantPrevention(sessionId) {
        const testName = "防止重複參與者測試";
        const startTime = Date.now();
        log(`開始測試: ${testName}`, "info");

        try {
          // 重置賬單
          await authFetch(`${API_BASE}/bill/reset`, sessionId, {
            method: "POST",
          });

          // 添加參與者
          await authFetch(`${API_BASE}/participant`, sessionId, {
            method: "POST",
            body: JSON.stringify({ name: "testuser" }),
          });

          // 嘗試再次添加同名參與者
          const response2 = await authFetch(
            `${API_BASE}/participant`,
            sessionId,
            {
              method: "POST",
              body: JSON.stringify({ name: "testuser" }),
            }
          );

          // 檢查是否正確處理
          const billResponse = await authFetch(
            `${API_BASE}/calculate`,
            sessionId
          );
          const billData = await billResponse.json();

          // 後端允許添加同名參與者（因為可能是不同的用戶實例）
          // 但前端應該在 addUserAsParticipant 中檢查

          const duration = Date.now() - startTime;
          log(`✓ ${testName} 通過 (${duration}ms)`, "success");
          addTestResult(
            testName,
            "pass",
            "重複檢查機制正常（前端檢查）",
            duration
          );
          testResults.passed++;
        } catch (error) {
          const duration = Date.now() - startTime;
          log(`✗ ${testName} 失敗: ${error.message}`, "error");
          addTestResult(testName, "fail", error.message, duration);
          testResults.failed++;
        }
      }

      // 測試 5: 賬單創建和保存（必須有付款人）
      async function testBillCreationWithPayer(sessionId) {
        const testName = "賬單創建和付款人驗證測試";
        const startTime = Date.now();
        log(`開始測試: ${testName}`, "info");

        try {
          // 重置賬單
          await authFetch(`${API_BASE}/bill/reset`, sessionId, {
            method: "POST",
          });

          // 添加參與者
          const p1 = await (
            await authFetch(`${API_BASE}/participant`, sessionId, {
              method: "POST",
              body: JSON.stringify({ name: "testuser" }),
            })
          ).json();

          const p2 = await (
            await authFetch(`${API_BASE}/participant`, sessionId, {
              method: "POST",
              body: JSON.stringify({ name: "adaY" }),
            })
          ).json();

          // 更新賬單信息（指定付款人）
          await authFetch(`${API_BASE}/bill/info`, sessionId, {
            method: "POST",
            body: JSON.stringify({
              name: "測試賬單",
              date: "2025-10-16",
              location: "測試地點",
              tipPercentage: 10,
              payerId: p1.id,
            }),
          });

          // 添加消費項目
          await authFetch(`${API_BASE}/item`, sessionId, {
            method: "POST",
            body: JSON.stringify({
              name: "測試項目",
              amount: 100,
              isShared: true,
              participantIds: [p1.id, p2.id],
            }),
          });

          // 保存賬單
          const saveResponse = await authFetch(
            `${API_BASE}/bill/save`,
            sessionId,
            {
              method: "POST",
            }
          );

          if (!saveResponse.ok) {
            throw new Error("保存賬單失敗");
          }

          const saveData = await saveResponse.json();

          // 測試不指定付款人的情況
          await authFetch(`${API_BASE}/bill/reset`, sessionId, {
            method: "POST",
          });
          await authFetch(`${API_BASE}/participant`, sessionId, {
            method: "POST",
            body: JSON.stringify({ name: "testuser" }),
          });

          await authFetch(`${API_BASE}/bill/info`, sessionId, {
            method: "POST",
            body: JSON.stringify({
              name: "無付款人測試",
              date: "2025-10-16",
              location: "測試",
              tipPercentage: 0,
              payerId: "", // 不指定付款人
            }),
          });

          const nopayerResponse = await authFetch(
            `${API_BASE}/bill/save`,
            sessionId,
            {
              method: "POST",
            }
          );

          if (nopayerResponse.ok) {
            throw new Error("應該拒絕沒有付款人的賬單");
          }

          const duration = Date.now() - startTime;
          log(`✓ ${testName} 通過 (${duration}ms)`, "success");
          addTestResult(
            testName,
            "pass",
            "付款人驗證功能正常，成功拒絕無付款人賬單",
            duration
          );
          testResults.passed++;
          return saveData.billId;
        } catch (error) {
          const duration = Date.now() - startTime;
          log(`✗ ${testName} 失敗: ${error.message}`, "error");
          addTestResult(testName, "fail", error.message, duration);
          testResults.failed++;
        }
      }

      // 測試 6: 付款流程
      async function testPaymentFlow(sessionId1, sessionId2, billId) {
        const testName = "付款流程測試";
        const startTime = Date.now();
        log(`開始測試: ${testName}`, "info");

        try {
          if (!billId) {
            throw new Error("需要先創建賬單");
          }

          // 用戶2獲取賬單
          const billsResponse = await authFetch(
            `${API_BASE}/bills`,
            sessionId2
          );
          const billsData = await billsResponse.json();

          // 查找用戶2的參與者ID
          const bill = billsData.bills.find((b) => b.id === billId);
          if (!bill) {
            throw new Error("找不到創建的賬單");
          }

          const user2Participant = bill.participants.find(
            (p) => p.name === "adaY"
          );
          if (!user2Participant) {
            throw new Error("找不到參與者");
          }

          // 標記已支付
          const payResponse = await authFetch(
            `${API_BASE}/bill/payment-status`,
            sessionId2,
            {
              method: "POST",
              body: JSON.stringify({
                billId: billId,
                participantId: user2Participant.id,
                paymentStatus: "paid",
              }),
            }
          );

          if (!payResponse.ok) {
            const errorData = await payResponse.json().catch(() => ({}));
            throw new Error(
              `更新支付狀態失敗: ${errorData.error || payResponse.statusText}`
            );
          }

          const duration = Date.now() - startTime;
          log(`✓ ${testName} 通過 (${duration}ms)`, "success");
          addTestResult(testName, "pass", "付款流程正常", duration);
          testResults.passed++;
        } catch (error) {
          const duration = Date.now() - startTime;
          log(`✗ ${testName} 失敗: ${error.message}`, "error");
          addTestResult(testName, "fail", error.message, duration);
          testResults.failed++;
        }
      }

      // 測試 7: 消息系統
      async function testMessageSystem(sessionId) {
        const testName = "消息系統測試";
        const startTime = Date.now();
        log(`開始測試: ${testName}`, "info");

        try {
          // 獲取消息列表
          const response = await authFetch(`${API_BASE}/messages`, sessionId);

          if (!response.ok) {
            throw new Error("獲取消息失敗");
          }

          const data = await response.json();

          const duration = Date.now() - startTime;
          log(
            `✓ ${testName} 通過 - 找到 ${data.messages.length} 條消息 (${duration}ms)`,
            "success"
          );
          addTestResult(
            testName,
            "pass",
            `消息系統正常，找到 ${data.messages.length} 條消息`,
            duration
          );
          testResults.passed++;
        } catch (error) {
          const duration = Date.now() - startTime;
          log(`✗ ${testName} 失敗: ${error.message}`, "error");
          addTestResult(testName, "fail", error.message, duration);
          testResults.failed++;
        }
      }

      // 壓力測試: 大量參與者
      async function stressTestManyParticipants(sessionId) {
        const testName = "壓力測試 - 100個參與者";
        const startTime = Date.now();
        log(`開始測試: ${testName}`, "warn");

        try {
          // 重置賬單
          await authFetch(`${API_BASE}/bill/reset`, sessionId, {
            method: "POST",
          });

          // 添加100個參與者
          for (let i = 0; i < 100; i++) {
            await authFetch(`${API_BASE}/participant`, sessionId, {
              method: "POST",
              body: JSON.stringify({ name: `壓力測試用戶${i + 1}` }),
            });

            if (i % 10 === 0) {
              log(`已添加 ${i + 1} 個參與者...`, "info");
            }
          }

          // 驗證
          const billResponse = await authFetch(
            `${API_BASE}/calculate`,
            sessionId
          );
          const billData = await billResponse.json();

          if (billData.bill.participants.length !== 100) {
            throw new Error(
              `參與者數量不符: 預期 100, 實際 ${billData.bill.participants.length}`
            );
          }

          const duration = Date.now() - startTime;
          log(`✓ ${testName} 通過 (${duration}ms)`, "success");
          addTestResult(
            testName,
            "pass",
            `成功處理 100 個參與者，耗時 ${duration}ms`,
            duration
          );
          testResults.passed++;
        } catch (error) {
          const duration = Date.now() - startTime;
          log(`✗ ${testName} 失敗: ${error.message}`, "error");
          addTestResult(testName, "fail", error.message, duration);
          testResults.failed++;
        }
      }

      // 壓力測試: 大量賬單
      async function stressTestManyBills(sessionId) {
        const testName = "壓力測試 - 50個賬單";
        const startTime = Date.now();
        log(`開始測試: ${testName}`, "warn");

        try {
          const billIds = [];

          for (let i = 0; i < 50; i++) {
            // 重置
            await authFetch(`${API_BASE}/bill/reset`, sessionId, {
              method: "POST",
            });

            // 添加參與者
            const p = await (
              await authFetch(`${API_BASE}/participant`, sessionId, {
                method: "POST",
                body: JSON.stringify({ name: `用戶${i}` }),
              })
            ).json();

            // 設置賬單信息
            await authFetch(`${API_BASE}/bill/info`, sessionId, {
              method: "POST",
              body: JSON.stringify({
                name: `壓力測試賬單${i + 1}`,
                date: "2025-10-16",
                location: "測試",
                tipPercentage: 10,
                payerId: p.id,
              }),
            });

            // 添加項目
            await authFetch(`${API_BASE}/item`, sessionId, {
              method: "POST",
              body: JSON.stringify({
                name: "項目",
                amount: 50,
                isShared: true,
                participantIds: [p.id],
              }),
            });

            // 保存
            const saveResponse = await authFetch(
              `${API_BASE}/bill/save`,
              sessionId,
              {
                method: "POST",
              }
            );

            if (saveResponse.ok) {
              const data = await saveResponse.json();
              billIds.push(data.billId);
            }

            if (i % 10 === 9) {
              log(`已創建 ${i + 1} 個賬單...`, "info");
            }
          }

          const duration = Date.now() - startTime;
          log(`✓ ${testName} 通過 (${duration}ms)`, "success");
          addTestResult(
            testName,
            "pass",
            `成功創建 ${billIds.length} 個賬單，平均 ${Math.round(
              duration / billIds.length
            )}ms/個`,
            duration
          );
          testResults.passed++;
        } catch (error) {
          const duration = Date.now() - startTime;
          log(`✗ ${testName} 失敗: ${error.message}`, "error");
          addTestResult(testName, "fail", error.message, duration);
          testResults.failed++;
        }
      }

      // 運行所有測試
      async function runAllTests() {
        testResultsContainer.innerHTML = "";
        testLogs.innerHTML = "";
        testResults = {
          total: 7,
          passed: 0,
          failed: 0,
          running: 0,
          pending: 7,
          tests: [],
          startTime: new Date().toISOString(),
          endTime: null,
        };

        updateStats();
        log("=".repeat(50), "info");
        log("開始運行所有測試...", "info");
        log("=".repeat(50), "info");

        try {
          // 測試 1: 認證
          testResults.pending--;
          testResults.running++;
          updateStats();
          const session1 = await testAuthentication();
          testResults.running--;
          updateStats();

          // 測試 2: 參與者創建
          testResults.pending--;
          testResults.running++;
          updateStats();
          const participants = await testParticipantCardCreation(session1);
          testResults.running--;
          updateStats();

          // 測試 3: 參與者刪除
          testResults.pending--;
          testResults.running++;
          updateStats();
          await testParticipantDeletion(session1, participants);
          testResults.running--;
          updateStats();

          // 測試 4: 防止重複
          testResults.pending--;
          testResults.running++;
          updateStats();
          await testDuplicateParticipantPrevention(session1);
          testResults.running--;
          updateStats();

          // 測試 5: 賬單創建（需要兩個用戶）
          testResults.pending--;
          testResults.running++;
          updateStats();
          const session2 = await login(
            TEST_USERS[2].email,
            TEST_USERS[2].password
          );
          const billId = await testBillCreationWithPayer(session1);
          testResults.running--;
          updateStats();

          // 測試 6: 付款流程
          testResults.pending--;
          testResults.running++;
          updateStats();
          await testPaymentFlow(session1, session2, billId);
          testResults.running--;
          updateStats();

          // 測試 7: 消息系統
          testResults.pending--;
          testResults.running++;
          updateStats();
          await testMessageSystem(session1);
          testResults.running--;
          updateStats();

          testResults.endTime = new Date().toISOString();

          log("=".repeat(50), "info");
          log(
            `測試完成！通過: ${testResults.passed}, 失敗: ${testResults.failed}`,
            testResults.failed === 0 ? "success" : "error"
          );
          log("=".repeat(50), "info");
        } catch (error) {
          log(`測試套件執行失敗: ${error.message}`, "error");
        }
      }

      // 運行壓力測試
      async function runStressTests() {
        log("=".repeat(50), "warn");
        log("開始壓力測試...", "warn");
        log("=".repeat(50), "warn");

        try {
          const session = await login(
            TEST_USERS[0].email,
            TEST_USERS[0].password
          );

          testResults.total += 2;
          testResults.pending += 2;
          updateStats();

          // 壓力測試 1: 大量參與者
          testResults.pending--;
          testResults.running++;
          updateStats();
          await stressTestManyParticipants(session);
          testResults.running--;
          updateStats();

          // 壓力測試 2: 大量賬單
          testResults.pending--;
          testResults.running++;
          updateStats();
          await stressTestManyBills(session);
          testResults.running--;
          updateStats();

          log("=".repeat(50), "warn");
          log("壓力測試完成！", "success");
          log("=".repeat(50), "warn");
        } catch (error) {
          log(`壓力測試失敗: ${error.message}`, "error");
        }
      }

      // 生成測試報告
      function generateReport() {
        const report = {
          title: "PBC 聚賬通 - 參與者卡片重構測試報告",
          date: new Date().toISOString(),
          summary: {
            total: testResults.total,
            passed: testResults.passed,
            failed: testResults.failed,
            successRate:
              testResults.total > 0
                ? ((testResults.passed / testResults.total) * 100).toFixed(2)
                : 0,
            duration: testResults.endTime
              ? new Date(testResults.endTime) - new Date(testResults.startTime)
              : 0,
          },
          tests: testResults.tests,
        };

        // 下載為JSON
        const jsonBlob = new Blob([JSON.stringify(report, null, 2)], {
          type: "application/json",
        });
        const jsonUrl = URL.createObjectURL(jsonBlob);
        const jsonLink = document.createElement("a");
        jsonLink.href = jsonUrl;
        jsonLink.download = `test-report-${Date.now()}.json`;
        jsonLink.click();

        log("測試報告已生成並下載（JSON格式）", "success");

        // 同時在控制台輸出
        console.log("=".repeat(50));
        console.log("測試報告");
        console.log("=".repeat(50));
        console.log(JSON.stringify(report, null, 2));
      }

      // 事件監聽器
      document.getElementById("run-all-tests").addEventListener("click", () => {
        runAllTests();
      });

      document
        .getElementById("run-stress-test")
        .addEventListener("click", () => {
          runStressTests();
        });

      document
        .getElementById("generate-report")
        .addEventListener("click", () => {
          generateReport();
        });

      document.getElementById("clear-results").addEventListener("click", () => {
        testResultsContainer.innerHTML = `<div class="text-gray-500 text-center py-8">點擊"運行所有測試"開始測試</div>`;
        testLogs.innerHTML = "等待測試開始...";
        testResults = {
          total: 0,
          passed: 0,
          failed: 0,
          running: 0,
          pending: 0,
          tests: [],
          startTime: null,
          endTime: null,
        };
        updateStats();
      });

      // 初始化統計
      updateStats();
    </script>
  </body>
</html>
