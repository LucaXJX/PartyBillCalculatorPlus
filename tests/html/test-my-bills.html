<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æˆ‘çš„è³¬å–®é é¢æ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <style>
      .test-pass {
        color: #10b981;
      }
      .test-fail {
        color: #ef4444;
      }
      .test-warn {
        color: #f59e0b;
      }
      .test-info {
        color: #3b82f6;
      }
    </style>
  </head>
  <body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
      <h1 class="text-3xl font-bold mb-6">æˆ‘çš„è³¬å–®é é¢è‡ªæª¢ç³»çµ±</h1>

      <!-- æ§åˆ¶é¢æ¿ -->
      <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex items-center gap-4 mb-4">
          <button
            id="run-all-tests"
            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700"
          >
            <i class="fas fa-play mr-2"></i>é‹è¡Œæ‰€æœ‰æ¸¬è©¦
          </button>
          <button
            id="export-results"
            class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700"
          >
            <i class="fas fa-download mr-2"></i>å°å‡ºçµæœ
          </button>
          <button
            id="clear-results"
            class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700"
          >
            <i class="fas fa-trash mr-2"></i>æ¸…é™¤çµæœ
          </button>
        </div>

        <!-- çµ±è¨ˆä¿¡æ¯ -->
        <div class="grid grid-cols-4 gap-4 mt-4">
          <div class="bg-green-50 p-4 rounded-lg">
            <div class="text-sm text-gray-600">é€šé</div>
            <div class="text-2xl font-bold text-green-600" id="pass-count">
              0
            </div>
          </div>
          <div class="bg-red-50 p-4 rounded-lg">
            <div class="text-sm text-gray-600">å¤±æ•—</div>
            <div class="text-2xl font-bold text-red-600" id="fail-count">0</div>
          </div>
          <div class="bg-yellow-50 p-4 rounded-lg">
            <div class="text-sm text-gray-600">è­¦å‘Š</div>
            <div class="text-2xl font-bold text-yellow-600" id="warn-count">
              0
            </div>
          </div>
          <div class="bg-blue-50 p-4 rounded-lg">
            <div class="text-sm text-gray-600">ç¸½è¨ˆ</div>
            <div class="text-2xl font-bold text-blue-600" id="total-count">
              0
            </div>
          </div>
        </div>
      </div>

      <!-- æ¸¬è©¦çµæœ -->
      <div id="test-results" class="space-y-4"></div>
    </div>

    <script type="module">
      let testResults = [];
      let stats = { pass: 0, fail: 0, warn: 0, total: 0 };

      // èªè­‰ fetch
      async function authenticatedFetch(url, options = {}) {
        const sessionId = localStorage.getItem("sessionId");
        if (!sessionId) {
          throw new Error("æœªç™»å…¥");
        }

        const headers = {
          ...options.headers,
          Authorization: `Bearer ${sessionId}`,
          "Content-Type": "application/json",
        };

        const response = await fetch(url, { ...options, headers });

        if (response.status === 401) {
          throw new Error("èªè­‰å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥");
        }

        return response;
      }

      // æ·»åŠ æ¸¬è©¦çµæœ
      function addResult(category, name, status, message, details = null) {
        const result = {
          timestamp: new Date().toISOString(),
          category,
          name,
          status,
          message,
          details,
        };
        testResults.push(result);
        stats.total++;
        stats[status]++;
        updateStats();
        renderResult(result);
      }

      // æ›´æ–°çµ±è¨ˆ
      function updateStats() {
        document.getElementById("pass-count").textContent = stats.pass;
        document.getElementById("fail-count").textContent = stats.fail;
        document.getElementById("warn-count").textContent = stats.warn;
        document.getElementById("total-count").textContent = stats.total;
      }

      // æ¸²æŸ“çµæœ
      function renderResult(result) {
        const container = document.getElementById("test-results");
        const statusIcons = {
          pass: '<i class="fas fa-check-circle test-pass"></i>',
          fail: '<i class="fas fa-times-circle test-fail"></i>',
          warn: '<i class="fas fa-exclamation-triangle test-warn"></i>',
          info: '<i class="fas fa-info-circle test-info"></i>',
        };

        const statusClasses = {
          pass: "bg-green-50 border-green-200",
          fail: "bg-red-50 border-red-200",
          warn: "bg-yellow-50 border-yellow-200",
          info: "bg-blue-50 border-blue-200",
        };

        const div = document.createElement("div");
        div.className = `border-l-4 p-4 rounded ${
          statusClasses[result.status]
        }`;
        div.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="text-xl">${statusIcons[result.status]}</div>
            <div class="flex-1">
              <div class="font-semibold">[${result.category}] ${
          result.name
        }</div>
              <div class="text-sm text-gray-600 mt-1">${result.message}</div>
              ${
                result.details
                  ? `<pre class="mt-2 text-xs bg-white p-2 rounded overflow-auto max-h-40">${JSON.stringify(
                      result.details,
                      null,
                      2
                    )}</pre>`
                  : ""
              }
            </div>
          </div>
        `;
        container.appendChild(div);
      }

      // æ¸¬è©¦ 1: èªè­‰ç‹€æ…‹
      async function testAuth() {
        addResult("èªè­‰", "æª¢æŸ¥ç™»å…¥ç‹€æ…‹", "info", "é–‹å§‹æª¢æŸ¥èªè­‰ç‹€æ…‹...");

        const sessionId = localStorage.getItem("sessionId");
        const userStr = localStorage.getItem("user");

        if (!sessionId) {
          addResult(
            "èªè­‰",
            "Session ID",
            "fail",
            "Session ID ä¸å­˜åœ¨ï¼Œè«‹å…ˆç™»å…¥"
          );
          return false;
        }

        addResult(
          "èªè­‰",
          "Session ID",
          "pass",
          `Session ID: ${sessionId.substring(0, 10)}...`
        );

        try {
          const user = JSON.parse(userStr);
          addResult(
            "èªè­‰",
            "ç”¨æˆ¶æ•¸æ“š",
            "pass",
            `å·²ç™»å…¥ç”¨æˆ¶: ${user.username}`,
            user
          );
          return true;
        } catch (e) {
          addResult("èªè­‰", "ç”¨æˆ¶æ•¸æ“š", "fail", "ç”¨æˆ¶æ•¸æ“šè§£æå¤±æ•—", e.message);
          return false;
        }
      }

      // æ¸¬è©¦ 2: API é€£é€šæ€§
      async function testAPIConnection() {
        addResult("API", "é€£é€šæ€§æ¸¬è©¦", "info", "æ¸¬è©¦ API é€£æ¥...");

        try {
          const response = await authenticatedFetch("/api/me");
          if (response.ok) {
            const data = await response.json();
            addResult("API", "/api/me", "pass", `API é€£æ¥æ­£å¸¸`, data);
            return true;
          } else {
            addResult(
              "API",
              "/api/me",
              "fail",
              `API è¿”å›éŒ¯èª¤: ${response.status}`
            );
            return false;
          }
        } catch (error) {
          addResult("API", "/api/me", "fail", `API è«‹æ±‚å¤±æ•—: ${error.message}`);
          return false;
        }
      }

      // æ¸¬è©¦ 3: ç²å–è³¬å–®
      async function testGetBills() {
        addResult("è³¬å–®", "ç²å–è³¬å–®åˆ—è¡¨", "info", "é–‹å§‹ç²å–è³¬å–®...");

        try {
          const response = await authenticatedFetch("/api/bills");

          if (!response.ok) {
            addResult("è³¬å–®", "API éŸ¿æ‡‰", "fail", `ç‹€æ…‹ç¢¼: ${response.status}`);
            return null;
          }

          const data = await response.json();
          const bills = data.bills || data;

          addResult("è³¬å–®", "API éŸ¿æ‡‰", "pass", `æˆåŠŸç²å–è³¬å–®ï¼Œç‹€æ…‹ç¢¼: 200`);
          addResult(
            "è³¬å–®",
            "è³¬å–®æ•¸é‡",
            bills.length > 0 ? "pass" : "warn",
            `ç²å–åˆ° ${bills.length} å€‹è³¬å–®`,
            { count: bills.length }
          );

          if (Array.isArray(bills)) {
            addResult("è³¬å–®", "æ•¸æ“šæ ¼å¼", "pass", "è³¬å–®æ•¸æ“šæ ¼å¼æ­£ç¢ºï¼ˆæ•¸çµ„ï¼‰");
          } else {
            addResult(
              "è³¬å–®",
              "æ•¸æ“šæ ¼å¼",
              "fail",
              "è³¬å–®æ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼ˆéæ•¸çµ„ï¼‰",
              bills
            );
          }

          return bills;
        } catch (error) {
          addResult("è³¬å–®", "ç²å–å¤±æ•—", "fail", error.message);
          return null;
        }
      }

      // æ¸¬è©¦ 4: ID åŒ¹é…é‚è¼¯
      async function testIDMatching(bills) {
        if (!bills || bills.length === 0) {
          addResult("IDåŒ¹é…", "æ¸¬è©¦è·³é", "warn", "æ²’æœ‰è³¬å–®æ•¸æ“šï¼Œè·³éæ¸¬è©¦");
          return;
        }

        addResult(
          "IDåŒ¹é…",
          "æ¸¬è©¦é–‹å§‹",
          "info",
          "æ¸¬è©¦ç”¨æˆ¶ID vs åƒèˆ‡è€…IDåŒ¹é…..."
        );

        const userStr = localStorage.getItem("user");
        const user = JSON.parse(userStr);

        let matchCount = 0;
        let mismatchCount = 0;

        bills.forEach((bill, index) => {
          const userParticipant = bill.participants.find(
            (p) => p.name === user.username
          );

          if (userParticipant) {
            matchCount++;
            const userResult = bill.results?.find(
              (r) => r.participantId === userParticipant.id
            );

            if (userResult) {
              addResult(
                "IDåŒ¹é…",
                `è³¬å–® ${index + 1}: ${bill.name || "(ç„¡åç¨±)"}`,
                "pass",
                `æˆåŠŸåŒ¹é…: ç”¨æˆ¶å=${user.username} â†’ åƒèˆ‡è€…ID=${userParticipant.id} â†’ çµæœé‡‘é¡=${userResult.amount}`
              );
            } else {
              addResult(
                "IDåŒ¹é…",
                `è³¬å–® ${index + 1}: ${bill.name || "(ç„¡åç¨±)"}`,
                "warn",
                `æ‰¾åˆ°åƒèˆ‡è€…ä½†ç„¡è¨ˆç®—çµæœ`,
                { userParticipant, results: bill.results }
              );
            }
          } else {
            mismatchCount++;
          }
        });

        addResult(
          "IDåŒ¹é…",
          "åŒ¹é…çµ±è¨ˆ",
          matchCount > 0 ? "pass" : "fail",
          `æˆåŠŸåŒ¹é… ${matchCount} å€‹è³¬å–®ï¼ŒæœªåŒ¹é… ${mismatchCount} å€‹`
        );
      }

      // æ¸¬è©¦ 5: çµ±è¨ˆæ•¸æ“šè¨ˆç®—
      async function testStatistics(bills) {
        if (!bills || bills.length === 0) {
          addResult("çµ±è¨ˆ", "æ¸¬è©¦è·³é", "warn", "æ²’æœ‰è³¬å–®æ•¸æ“šï¼Œè·³éæ¸¬è©¦");
          return;
        }

        addResult("çµ±è¨ˆ", "è¨ˆç®—çµ±è¨ˆæ•¸æ“š", "info", "é–‹å§‹è¨ˆç®—çµ±è¨ˆ...");

        const userStr = localStorage.getItem("user");
        const user = JSON.parse(userStr);

        let totalBills = bills.length;
        let pendingCount = 0;
        let paidCount = 0;
        let totalReceivables = 0;
        let totalPayables = 0;
        let receivablesCount = 0;
        let payablesCount = 0;

        bills.forEach((bill) => {
          const userParticipant = bill.participants.find(
            (p) => p.name === user.username
          );
          if (!userParticipant) return;

          const userResult = bill.results?.find(
            (r) => r.participantId === userParticipant.id
          );
          if (!userResult) return;

          const isPayer = bill.payerId === userParticipant.id;
          const totalAmount =
            bill.items?.reduce((sum, item) => sum + item.amount, 0) || 0;

          if (userResult.paymentStatus === "pending") {
            pendingCount++;
          } else {
            paidCount++;
          }

          if (isPayer) {
            const receivables = totalAmount - (userResult.amount || 0);
            totalReceivables += receivables;
            receivablesCount += bill.participants.length - 1;
          } else {
            totalPayables += userResult.amount || 0;
            payablesCount++;
          }
        });

        const stats = {
          totalBills,
          pendingCount,
          paidCount,
          totalReceivables: totalReceivables.toFixed(2),
          totalPayables: totalPayables.toFixed(2),
          receivablesCount,
          payablesCount,
        };

        addResult("çµ±è¨ˆ", "è¨ˆç®—çµæœ", "pass", "çµ±è¨ˆæ•¸æ“šè¨ˆç®—å®Œæˆ", stats);
      }

      // æ¸¬è©¦ 6: ä»˜æ¬¾äººé‚è¼¯
      async function testPayerLogic(bills) {
        if (!bills || bills.length === 0) {
          addResult("ä»˜æ¬¾äºº", "æ¸¬è©¦è·³é", "warn", "æ²’æœ‰è³¬å–®æ•¸æ“šï¼Œè·³éæ¸¬è©¦");
          return;
        }

        addResult(
          "ä»˜æ¬¾äºº",
          "æª¢æŸ¥ä»˜æ¬¾äººé‚è¼¯",
          "info",
          "æª¢æŸ¥ä»˜æ¬¾äººæ¨™è¨˜å’Œæ‡‰æ”¶æ¬¾..."
        );

        const userStr = localStorage.getItem("user");
        const user = JSON.parse(userStr);

        let payerBills = [];
        let participantBills = [];

        bills.forEach((bill) => {
          const userParticipant = bill.participants.find(
            (p) => p.name === user.username
          );
          if (!userParticipant) return;

          const isPayer = bill.payerId === userParticipant.id;

          if (isPayer) {
            payerBills.push(bill);
            const payerParticipant = bill.participants.find(
              (p) => p.id === bill.payerId
            );
            addResult(
              "ä»˜æ¬¾äºº",
              `${bill.name || "(ç„¡åç¨±)"}`,
              "pass",
              `ç”¨æˆ¶æ˜¯ä»˜æ¬¾äºº: ${payerParticipant?.name}`
            );
          } else {
            participantBills.push(bill);
          }
        });

        addResult(
          "ä»˜æ¬¾äºº",
          "è§’è‰²çµ±è¨ˆ",
          "pass",
          `ä»˜æ¬¾äººè³¬å–®: ${payerBills.length} å€‹ï¼Œåƒèˆ‡è€…è³¬å–®: ${participantBills.length} å€‹`
        );
      }

      // æ¸¬è©¦ 7: æ¸¬è©¦è³¬å–®æ•¸æ“š
      async function testTestBills(bills) {
        if (!bills) {
          addResult("æ¸¬è©¦æ•¸æ“š", "æ¸¬è©¦è·³é", "warn", "æ²’æœ‰è³¬å–®æ•¸æ“š");
          return;
        }

        addResult("æ¸¬è©¦æ•¸æ“š", "æª¢æŸ¥æ¸¬è©¦è³¬å–®", "info", "æŸ¥æ‰¾æ¸¬è©¦è³¬å–®...");

        const testBills = bills.filter((b) => b.id.startsWith("test_bill_"));

        if (testBills.length > 0) {
          addResult(
            "æ¸¬è©¦æ•¸æ“š",
            "æ¸¬è©¦è³¬å–®",
            "pass",
            `æ‰¾åˆ° ${testBills.length} å€‹æ¸¬è©¦è³¬å–®`,
            testBills.map((b) => ({ id: b.id, name: b.name, date: b.date }))
          );
        } else {
          addResult(
            "æ¸¬è©¦æ•¸æ“š",
            "æ¸¬è©¦è³¬å–®",
            "warn",
            "æœªæ‰¾åˆ°æ¸¬è©¦è³¬å–®ï¼ˆID ä»¥ test_bill_ é–‹é ­ï¼‰"
          );
        }
      }

      // é‹è¡Œæ‰€æœ‰æ¸¬è©¦
      async function runAllTests() {
        // æ¸…é™¤ä¹‹å‰çš„çµæœ
        document.getElementById("test-results").innerHTML = "";
        testResults = [];
        stats = { pass: 0, fail: 0, warn: 0, info: 0, total: 0 };
        updateStats();

        addResult(
          "ç³»çµ±",
          "æ¸¬è©¦é–‹å§‹",
          "info",
          `æ¸¬è©¦é–‹å§‹æ™‚é–“: ${new Date().toLocaleString("zh-TW")}`
        );

        // 1. èªè­‰æ¸¬è©¦
        const authOK = await testAuth();
        if (!authOK) {
          addResult("ç³»çµ±", "æ¸¬è©¦ä¸­æ­¢", "fail", "èªè­‰å¤±æ•—ï¼Œç„¡æ³•ç¹¼çºŒæ¸¬è©¦");
          return;
        }

        // 2. API é€£é€šæ€§
        const apiOK = await testAPIConnection();
        if (!apiOK) {
          addResult("ç³»çµ±", "æ¸¬è©¦ä¸­æ­¢", "fail", "API é€£æ¥å¤±æ•—ï¼Œç„¡æ³•ç¹¼çºŒæ¸¬è©¦");
          return;
        }

        // 3. ç²å–è³¬å–®
        const bills = await testGetBills();

        // 4. ID åŒ¹é…æ¸¬è©¦
        await testIDMatching(bills);

        // 5. çµ±è¨ˆæ¸¬è©¦
        await testStatistics(bills);

        // 6. ä»˜æ¬¾äººé‚è¼¯æ¸¬è©¦
        await testPayerLogic(bills);

        // 7. æ¸¬è©¦è³¬å–®æª¢æŸ¥
        await testTestBills(bills);

        addResult(
          "ç³»çµ±",
          "æ¸¬è©¦å®Œæˆ",
          "info",
          `æ¸¬è©¦å®Œæˆæ™‚é–“: ${new Date().toLocaleString("zh-TW")}\nç¸½è¨ˆ: ${
            stats.total
          } é …ï¼Œé€šé: ${stats.pass}ï¼Œå¤±æ•—: ${stats.fail}ï¼Œè­¦å‘Š: ${stats.warn}`
        );
      }

      // å°å‡ºçµæœ
      function exportResults() {
        const markdown = generateMarkdown();
        const blob = new Blob([markdown], { type: "text/markdown" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `æˆ‘çš„è³¬å–®æ¸¬è©¦çµæœ_${
          new Date().toISOString().split("T")[0]
        }.md`;
        a.click();
        URL.revokeObjectURL(url);

        // åŒæ™‚è¤‡è£½åˆ°å‰ªè²¼æ¿
        navigator.clipboard.writeText(markdown).then(() => {
          alert("æ¸¬è©¦çµæœå·²ä¸‹è¼‰ä¸¦è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼");
        });
      }

      // ç”Ÿæˆ Markdown
      function generateMarkdown() {
        let md = `# æˆ‘çš„è³¬å–®é é¢æ¸¬è©¦çµæœ\n\n`;
        md += `**æ¸¬è©¦æ™‚é–“**: ${new Date().toLocaleString("zh-TW")}\n\n`;
        md += `## ğŸ“Š æ¸¬è©¦çµ±è¨ˆ\n\n`;
        md += `- **ç¸½è¨ˆ**: ${stats.total} é …æ¸¬è©¦\n`;
        md += `- **é€šé**: ${stats.pass} é … âœ…\n`;
        md += `- **å¤±æ•—**: ${stats.fail} é … âŒ\n`;
        md += `- **è­¦å‘Š**: ${stats.warn} é … âš ï¸\n`;
        md += `- **ä¿¡æ¯**: ${stats.info} é … â„¹ï¸\n\n`;
        md += `**é€šéç‡**: ${((stats.pass / stats.total) * 100).toFixed(
          1
        )}%\n\n`;

        md += `## ğŸ“‹ è©³ç´°æ¸¬è©¦çµæœ\n\n`;

        const categories = [...new Set(testResults.map((r) => r.category))];

        categories.forEach((category) => {
          md += `### ${category}\n\n`;
          const categoryResults = testResults.filter(
            (r) => r.category === category
          );

          categoryResults.forEach((result) => {
            const icon = {
              pass: "âœ…",
              fail: "âŒ",
              warn: "âš ï¸",
              info: "â„¹ï¸",
            }[result.status];

            md += `**${icon} ${result.name}**\n`;
            md += `- ${result.message}\n`;

            if (result.details) {
              md += `\`\`\`json\n${JSON.stringify(
                result.details,
                null,
                2
              )}\n\`\`\`\n`;
            }
            md += `\n`;
          });
        });

        md += `---\n*æ­¤å ±å‘Šç”± PBCèšè³¬é€š æˆ‘çš„è³¬å–®é é¢æ¸¬è©¦ç³»çµ±è‡ªå‹•ç”Ÿæˆ*\n`;
        return md;
      }

      // æ¸…é™¤çµæœ
      function clearResults() {
        document.getElementById("test-results").innerHTML = "";
        testResults = [];
        stats = { pass: 0, fail: 0, warn: 0, info: 0, total: 0 };
        updateStats();
      }

      // äº‹ä»¶ç›£è½
      document
        .getElementById("run-all-tests")
        .addEventListener("click", runAllTests);
      document
        .getElementById("export-results")
        .addEventListener("click", exportResults);
      document
        .getElementById("clear-results")
        .addEventListener("click", clearResults);

      // é é¢åŠ è¼‰æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
      window.addEventListener("DOMContentLoaded", () => {
        const sessionId = localStorage.getItem("sessionId");
        const userStr = localStorage.getItem("user");

        if (!sessionId || !userStr) {
          const warning = document.createElement("div");
          warning.className = "bg-red-50 border-l-4 border-red-500 p-4 mb-6";
          warning.innerHTML = `
            <div class="flex items-center gap-3">
              <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
              <div>
                <div class="font-semibold text-red-800">æœªç™»å…¥</div>
                <div class="text-sm text-red-600">è«‹å…ˆ <a href="/login-page.html" class="underline">ç™»å…¥</a> å†é€²è¡Œæ¸¬è©¦</div>
              </div>
            </div>
          `;
          document
            .querySelector(".max-w-6xl")
            .insertBefore(
              warning,
              document.querySelector(".max-w-6xl").firstChild
            );
        } else {
          try {
            const user = JSON.parse(userStr);
            const info = document.createElement("div");
            info.className = "bg-blue-50 border-l-4 border-blue-500 p-4 mb-6";
            info.innerHTML = `
              <div class="flex items-center gap-3">
                <i class="fas fa-user-check text-blue-500 text-xl"></i>
                <div>
                  <div class="font-semibold text-blue-800">å·²ç™»å…¥</div>
                  <div class="text-sm text-blue-600">ç•¶å‰ç”¨æˆ¶: ${user.username}</div>
                </div>
              </div>
            `;
            document
              .querySelector(".max-w-6xl")
              .insertBefore(
                info,
                document.querySelector(".max-w-6xl").firstChild
              );
          } catch (e) {
            console.error("è§£æç”¨æˆ¶æ•¸æ“šå¤±æ•—:", e);
          }
        }
      });
    </script>
  </body>
</html>
